<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sistema de Gesti√≥n de Limpieza de Flota</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöç</text></svg>" type="image/svg+xml">
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet + MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            /* Colores principales */
            --primary-50: #eef2ff;
            --primary-100: #e0e7ff;
            --primary-200: #c7d2fe;
            --primary-300: #a5b4fc;
            --primary-400: #818cf8;
            --primary-500: #6366f1;
            --primary-600: #4f46e5;
            --primary-700: #4338ca;
            --primary-800: #3730a3;
            --primary-900: #312e81;
            --primary-950: #1e1b4b;

            /* Colores de acento */
            --accent-50: #ecfdf5;
            --accent-100: #d1fae5;
            --accent-200: #a7f3d0;
            --accent-300: #6ee7b7;
            --accent-400: #34d399;
            --accent-500: #10b981;
            --accent-600: #059669;
            --accent-700: #047857;
            --accent-800: #065f46;
            --accent-900: #064e3b;
            --accent-950: #022c22;

            /* Colores neutros */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --gray-950: #030712;

            /* Estados */
            --success: var(--accent-600);
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: var(--primary-600);

            /* Tema claro por defecto */
            --bg-body: #f9fafb;
            --bg-card: #ffffff;
            --bg-hover: #f3f4f6;
            --bg-active: #e0e7ff;
            --bg-sidebar: #ffffff;
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-600);
            --text-muted: var(--gray-500);
            --text-on-primary: #ffffff;
            --border-color: var(--gray-200);
            --border-active: var(--primary-500);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            /* Layout */
            --header-height: 60px;
            --sidebar-width: 250px;
            --sidebar-collapsed: 64px;
            --mobile-nav-height: 56px;
            --border-radius-sm: 0.25rem;
            --border-radius: 0.375rem;
            --border-radius-md: 0.5rem;
            --border-radius-lg: 0.75rem;
            --border-radius-xl: 1rem;

            /* Fuentes */
            --font-sans: 'Inter', system-ui, sans-serif;
            --font-heading: 'Plus Jakarta Sans', var(--font-sans);

            /* Transiciones */
            --transition-fast: 150ms;
            --transition: 200ms;
            --transition-slow: 300ms;
            --ease: cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Tema oscuro */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: var(--gray-950);
                --bg-card: var(--gray-900);
                --bg-hover: var(--gray-800);
                --bg-active: var(--primary-900);
                --bg-sidebar: var(--gray-900);
                --text-primary: #f9fafb;
                --text-secondary: #d1d5db;
                --text-muted: #9ca3af;
                --border-color: var(--gray-800);
                --border-active: var(--primary-400);
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
                --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
                --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
                --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.15);
            }
        }

        /* Reset & Base */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            width: 100%;
        }

        body {
            font-family: var(--font-sans);
            font-size: 0.9375rem;
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--bg-body);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            transition: background-color var(--transition);
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
            font-weight: 600;
            line-height: 1.2;
            color: var(--text-primary);
        }

        h1 { font-size: 1.5rem; }
        h2 { font-size: 1.25rem; }
        h3 { font-size: 1.125rem; }
        h4 { font-size: 1rem; }
        h5 { font-size: 0.9375rem; }
        h6 { font-size: 0.875rem; }

        a {
            color: var(--primary-600);
            text-decoration: none;
            transition: color var(--transition-fast);
        }
        a:hover { color: var(--primary-700); }

        /* Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        .main-content {
            display: flex;
            height: calc(100% - var(--header-height));
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            height: 100%;
            position: fixed;
            left: 0;
            top: var(--header-height);
            bottom: 0;
            z-index: 40;
            transition: all var(--transition) var(--ease);
            box-shadow: var(--shadow);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--gray-400) transparent;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }

        .content-wrapper {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: margin-left var(--transition) var(--ease);
            overflow-y: auto;
        }

        .content-wrapper.sidebar-collapsed {
            margin-left: var(--sidebar-collapsed);
        }

        .content-inner {
            padding: 1rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        @media (max-width: 1023px) {
            .sidebar {
                transform: translateX(-100%);
                box-shadow: var(--shadow-lg);
            }

            .sidebar.mobile-visible {
                transform: translateX(0);
            }

            .content-wrapper, .content-wrapper.sidebar-collapsed {
                margin-left: 0;
                padding-bottom: calc(var(--mobile-nav-height) + 1rem);
            }

            .mobile-nav {
                display: flex;
            }

            .main-content {
                height: calc(100% - var(--header-height) - var(--mobile-nav-height));
            }
        }

        /* Header */
        .header {
            height: var(--header-height);
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            padding: 0 1rem;
            box-shadow: var(--shadow-sm);
            transition: background-color var(--transition);
        }

        .header-content {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            border-radius: var(--border-radius);
            color: white;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .logo-text {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            font-family: var(--font-heading);
        }

        @media (max-width: 768px) {
            .logo-text {
                display: none;
            }
        }

        /* Sidebar */
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-logo {
            width: 2rem;
            height: 2rem;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: white;
            font-weight: 700;
            font-size: 1rem;
        }

        .sidebar-title {
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
            color: var(--text-primary);
        }

        .sidebar-toggle {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            width: 1.75rem;
            height: 1.75rem;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .sidebar-toggle:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
        }

        .sidebar-collapsed .sidebar-title,
        .sidebar-collapsed .sidebar-toggle i.bi-chevron-left {
            display: none;
        }

        .sidebar-collapsed .sidebar-toggle i.bi-chevron-right {
            display: block;
        }

        .sidebar-toggle i.bi-chevron-right {
            display: none;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .sidebar-section {
            margin-bottom: 1.25rem;
        }

        .sidebar-section-header {
            padding: 0 1rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .sidebar-collapsed .sidebar-section-header {
            text-align: center;
            padding: 0 0.25rem 0.5rem;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu-item {
            margin-bottom: 0.125rem;
        }

        .sidebar-menu-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 1rem;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all var(--transition-fast);
            border-radius: 0;
            position: relative;
        }

        .sidebar-collapsed .sidebar-menu-link {
            padding: 0.625rem;
            justify-content: center;
        }

        .sidebar-menu-link:hover {
            color: var(--text-primary);
            background-color: var(--bg-hover);
        }

        .sidebar-menu-link.active {
            color: var(--primary-600);
            background-color: var(--bg-active);
        }

        .sidebar-menu-link.active::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: var(--primary-600);
            border-radius: 0 4px 4px 0;
        }

        .sidebar-menu-icon {
            flex-shrink: 0;
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
        }

        .sidebar-menu-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-collapsed .sidebar-menu-text {
            display: none;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background-color: var(--primary-100);
            color: var(--primary-700);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .user-details {
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .sidebar-collapsed .user-details {
            display: none;
        }

        /* Mobile Nav */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--mobile-nav-height);
            background-color: var(--bg-card);
            border-top: 1px solid var(--border-color);
            z-index: 50;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .mobile-nav-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .mobile-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 0.625rem;
            padding: 0.25rem;
            transition: all var(--transition-fast);
            position: relative;
        }

        .mobile-nav-item.active {
            color: var(--primary-600);
        }

        .mobile-nav-item.active::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 25%;
            right: 25%;
            height: 3px;
            background-color: var(--primary-600);
            border-radius: 3px 3px 0 0;
        }

        .mobile-nav-icon {
            font-size: 1.25rem;
            margin-bottom: 0.125rem;
        }

        /* Cards */
        .card {
            background-color: var(--bg-card);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow);
            transition: box-shadow var(--transition-fast);
            overflow: hidden;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title i {
            color: var(--primary-600);
        }

        .card-body {
            padding: 1rem;
        }

        .card-footer {
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1rem;
        }

        .grid-col-3 {
            grid-column: span 3;
        }

        .grid-col-4 {
            grid-column: span 4;
        }

        .grid-col-6 {
            grid-column: span 6;
        }

        .grid-col-8 {
            grid-column: span 8;
        }

        .grid-col-9 {
            grid-column: span 9;
        }

        .grid-col-12 {
            grid-column: span 12;
        }

        @media (max-width: 1200px) {
            .grid-col-3, .grid-col-4 {
                grid-column: span 6;
            }
            .grid-col-8, .grid-col-9 {
                grid-column: span 12;
            }
        }

        @media (max-width: 768px) {
            .grid-col-3, .grid-col-4, .grid-col-6, .grid-col-8, .grid-col-9 {
                grid-column: span 12;
            }
            .dashboard-grid {
                gap: 0.75rem;
            }
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            padding: 1rem;
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .stat-card-primary {
            border-left: 3px solid var(--primary-600);
        }

        .stat-card-success {
            border-left: 3px solid var(--success);
        }

        .stat-card-warning {
            border-left: 3px solid var(--warning);
        }

        .stat-card-danger {
            border-left: 3px solid var(--danger);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: var(--font-heading);
        }

        .stat-change {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.25rem;
        }

        .stat-up {
            color: var(--success);
        }

        .stat-down {
            color: var(--danger);
        }

        .stat-icon {
            font-size: 1.125rem;
            color: var(--primary-600);
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: var(--border-radius);
            background-color: var(--bg-hover);
        }

        /* Tabs */
        .tabs-container {
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
            position: relative;
        }

        .tabs {
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            position: relative;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-item {
            padding: 0.625rem 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            position: relative;
            white-space: nowrap;
            transition: all var(--transition-fast);
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .tab-item:hover {
            color: var(--text-primary);
        }

        .tab-item.active {
            color: var(--primary-600);
            border-bottom: 2px solid var(--primary-600);
        }

        .tab-item .badge {
            margin-left: 0.375rem;
        }

        .tab-content {
            padding: 1rem 0;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.125rem 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 999px;
            transition: all var(--transition-fast);
        }

        .badge-primary {
            color: var(--primary-700);
            background-color: var(--primary-100);
        }

        .badge-success {
            color: var(--accent-700);
            background-color: var(--accent-100);
        }

        .badge-warning {
            color: #92400e;
            background-color: #fef3c7;
        }

        .badge-danger {
            color: #b91c1c;
            background-color: #fee2e2;
        }

        .badge-neutral {
            color: var(--text-secondary);
            background-color: var(--gray-200);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            user-select: none;
            padding: 0.5rem 0.875rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border-radius: var(--border-radius);
            transition: all var(--transition-fast);
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .btn:after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }

        .btn:active:after {
            transform: scale(0, 0);
            opacity: .2;
            transition: 0s;
        }

        .btn:disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }

        .btn-icon {
            padding: 0.375rem;
            width: 2rem;
            height: 2rem;
            font-size: 1rem;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: 0.75rem 1.25rem;
            font-size: 1rem;
        }

        .btn-block {
            display: flex;
            width: 100%;
        }

        .btn-primary {
            color: var(--text-on-primary);
            background-color: var(--primary-600);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-700);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-secondary {
            color: var(--text-primary);
            background-color: var(--gray-200);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--gray-300);
        }

        .btn-success {
            color: white;
            background-color: var(--success);
        }

        .btn-success:hover:not(:disabled) {
            background-color: var(--accent-700);
        }

        .btn-danger {
            color: white;
            background-color: var(--danger);
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
        }

        .btn-warning {
            color: white;
            background-color: var(--warning);
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #d97706;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-outline:hover:not(:disabled) {
            background-color: var(--bg-hover);
        }

        .btn-link {
            color: var(--primary-600);
            background-color: transparent;
            box-shadow: none;
            padding: 0.375rem;
        }

        .btn-link:hover:not(:disabled) {
            color: var(--primary-700);
            text-decoration: underline;
            box-shadow: none;
        }

        .btn-group {
            display: flex;
            gap: 0.375rem;
        }

        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid white;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.375rem;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .form-control {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 400;
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--bg-card);
            background-clip: padding-box;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .form-control:focus {
            border-color: var(--primary-400);
            outline: 0;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        /* Alerts */
        .alert {
            position: relative;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border-radius: var(--border-radius);
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .alert-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .alert-text {
            margin-bottom: 0;
        }

        .alert-primary {
            color: var(--primary-700);
            background-color: var(--primary-50);
        }

        .alert-success {
            color: var(--accent-700);
            background-color: var(--accent-50);
        }

        .alert-warning {
            color: #92400e;
            background-color: #fffbeb;
        }

        .alert-danger {
            color: #b91c1c;
            background-color: #fef2f2;
        }

        .alert-info {
            color: #1e40af;
            background-color: #eff6ff;
        }

        /* Pending Tasks */
        .pending-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .pending-card {
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            background-color: var(--bg-card);
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }

        .pending-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            border-color: var(--primary-300);
        }

        .pending-header {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 0.9375rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .pending-content {
            padding: 0.75rem;
            flex: 1;
        }

        .pending-footer {
            padding: 0.5rem 0.75rem;
            background-color: var(--bg-hover);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .pending-status {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .status-indicator {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            background-color: var(--bg-hover);
            position: relative;
        }

        .status-indicator::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .status-indicator.completed::before {
            background-color: var(--success);
        }

        .status-indicator.pending::before {
            background-color: var(--warning);
        }

        .status-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .status-value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 999px;
        }

        .status-badge.completed {
            background-color: var(--accent-100);
            color: var(--accent-700);
        }

        .status-badge.pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        /* Feed */
        .feed-container {
            max-height: 600px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--gray-400) transparent;
        }

        .feed-container::-webkit-scrollbar {
            width: 4px;
        }

        .feed-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .feed-container::-webkit-scrollbar-thumb {
            background-color: var(--gray-400);
            border-radius: 20px;
        }

        .feed-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            transition: background-color var(--transition-fast);
        }

        .feed-item:last-child {
            border-bottom: none;
        }

        .feed-item:hover {
            background-color: var(--bg-hover);
        }

        .feed-content {
            flex: 1;
            min-width: 0;
        }

        .feed-title {
            font-weight: 600;
            margin-bottom: 0.125rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            color: var(--text-primary);
        }

        .feed-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.375rem;
        }

        .feed-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
        }

        .feed-actions {
            display: flex;
            gap: 0.375rem;
        }

        /* Map */
        .map-container {
            height: 600px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        @media (max-width: 768px) {
            .map-container {
                height: 400px;
            }
        }
        .toast-container {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    width: 320px;
    max-width: calc(100vw - 2rem);
    pointer-events: none; /* Permite clics a trav√©s del contenedor, pero no de los toasts */
}

.toast {
    background-color: var(--bg-card);
    border-radius: var(--border-radius);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    padding: 0.75rem 1rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    transition: all var(--transition);
    animation: slideInRight 0.3s ease, fadeOut 0.5s ease 5s forwards;
    border-left: 3px solid var(--primary-600);
    max-width: 100%;
    position: relative;
    pointer-events: auto; /* Restaura los eventos de clic */
}

.toast.success {
    border-left-color: var(--success);
}

.toast.error {
    border-left-color: var(--danger);
}

.toast.warning {
    border-left-color: var(--warning);
}

.toast-icon {
    font-size: 1.125rem;
    flex-shrink: 0;
    color: var(--primary-600);
    margin-top: 0.125rem;
}

.toast.success .toast-icon {
    color: var(--success);
}

.toast.error .toast-icon {
    color: var(--danger);
}

.toast.warning .toast-icon {
    color: var(--warning);
}

.toast-body {
    flex: 1;
    font-size: 0.875rem;
    line-height: 1.4;
}

.toast-close {
    color: var(--text-muted);
    background: transparent;
    border: none;
    font-size: 1.125rem;
    cursor: pointer;
    padding: 0.125rem;
    line-height: 1;
    transition: color var(--transition-fast);
    flex-shrink: 0;
    margin-left: auto;
    margin-top: -0.125rem;
}

.toast-close:hover {
    color: var(--text-primary);
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes fadeOut {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(10px);
        visibility: hidden;
    }
}

/* Notification Panel - Nuevos estilos */
.notification-panel {
    position: fixed;
    top: var(--header-height);
    right: 0;
    width: 350px;
    max-width: 100vw;
    height: calc(100vh - var(--header-height));
    background-color: var(--bg-card);
    box-shadow: -2px 0 15px rgba(0, 0, 0, 0.1);
    z-index: 60;
    transform: translateX(100%);
    transition: transform var(--transition) var(--ease);
    display: flex;
    flex-direction: column;
    border-left: 1px solid var(--border-color);
}

.notification-panel.visible {
    transform: translateX(0);
}

.notification-header {
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
}

.notification-title {
    font-weight: 600;
    font-size: 1.125rem;
    margin: 0;
}

.notification-list {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem;
}

.notification-item {
    padding: 0.875rem;
    border-radius: var(--border-radius);
    margin-bottom: 0.75rem;
    background-color: var(--bg-hover);
    border-left: 3px solid var(--primary-600);
    transition: background-color var(--transition-fast);
    cursor: pointer;
}

.notification-item:hover {
    background-color: var(--bg-hover);
}

.notification-item.unread {
    background-color: var(--primary-50);
    position: relative;
}

.notification-item.unread::after {
    content: "";
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--primary-600);
}

.notification-item-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
    padding-right: 1rem;
}

.notification-item-time {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
}

.notification-item-content {
    font-size: 0.875rem;
    line-height: 1.4;
}

.notification-footer {
    padding: 0.875rem;
    display: flex;
    justify-content: center;
    border-top: 1px solid var(--border-color);
}

@media (max-width: 1023px) {
    .toast-container {
        bottom: calc(var(--mobile-nav-height) + 1rem);
    }
}

        /* Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition) var(--ease);
        }

        .modal-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--bg-card);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            opacity: 0;
            transition: transform var(--transition) var(--ease), opacity var(--transition) var(--ease);
        }

        .modal-backdrop.active .modal {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin: 0;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color var(--transition-fast);
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* Photo Gallery */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .photo-item {
            aspect-ratio: 1;
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
        }

        .photo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform var(--transition);
        }

        .photo-item:hover .photo-img {
            transform: scale(1.05);
        }

        /* Lightbox */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
        }

        .lightbox.visible {
            opacity: 1;
            visibility: visible;
        }

        .lightbox-content {
            max-width: 90%;
            max-height: 90vh;
            position: relative;
        }

        .lightbox-img {
            max-width: 100%;
            max-height: 90vh;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
        }

        .lightbox-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background-color var(--transition-fast);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .lightbox-close:hover {
            background-color: rgba(239, 68, 68, 0.8);
        }

        /* Pending Tasks List */
        .pending-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.75rem;
            padding: 0.5rem;
        }

        .pending-list-item {
            padding: 0.75rem;
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .pending-list-item:hover {
            border-color: var(--primary-300);
            box-shadow: var(--shadow);
        }

        .pending-list-plate {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .pending-list-terminal {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .pending-list-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: auto;
        }

        /* Utilities */
        .d-flex { display: flex !important; }
        .flex-column { flex-direction: column !important; }
        .justify-content-between { justify-content: space-between !important; }
        .justify-content-center { justify-content: center !important; }
        .align-items-center { align-items: center !important; }
        .gap-1 { gap: 0.25rem !important; }
        .gap-2 { gap: 0.5rem !important; }
        .gap-3 { gap: 0.75rem !important; }
        .gap-4 { gap: 1rem !important; }
        
        .text-primary { color: var(--text-primary) !important; }
        .text-secondary { color: var(--text-secondary) !important; }
        .text-muted { color: var(--text-muted) !important; }
        .text-success { color: var(--success) !important; }
        .text-danger { color: var(--danger) !important; }
        .text-warning { color: var(--warning) !important; }
        
        .text-center { text-align: center !important; }
        .text-right { text-align: right !important; }
        
        .font-bold { font-weight: 700 !important; }
        .font-semibold { font-weight: 600 !important; }
        .font-medium { font-weight: 500 !important; }
        
        .text-sm { font-size: 0.875rem !important; }
        .text-xs { font-size: 0.75rem !important; }
        
        .mb-0 { margin-bottom: 0 !important; }
        .mb-1 { margin-bottom: 0.25rem !important; }
        .mb-2 { margin-bottom: 0.5rem !important; }
        .mb-3 { margin-bottom: 0.75rem !important; }
        .mb-4 { margin-bottom: 1rem !important; }
        .mb-5 { margin-bottom: 1.5rem !important; }
        
        .mt-0 { margin-top: 0 !important; }
        .mt-1 { margin-top: 0.25rem !important; }
        .mt-2 { margin-top: 0.5rem !important; }
        .mt-3 { margin-top: 0.75rem !important; }
        .mt-4 { margin-top: 1rem !important; }
        
        .ms-auto { margin-left: auto !important; }
        .me-auto { margin-right: auto !important; }
        
        .p-0 { padding: 0 !important; }
        .p-1 { padding: 0.25rem !important; }
        .p-2 { padding: 0.5rem !important; }
        .p-3 { padding: 0.75rem !important; }
        .p-4 { padding: 1rem !important; }
        
        .py-1 { padding-top: 0.25rem !important; padding-bottom: 0.25rem !important; }
        .py-2 { padding-top: 0.5rem !important; padding-bottom: 0.5rem !important; }
        .px-2 { padding-left: 0.5rem !important; padding-right: 0.5rem !important; }
        .px-3 { padding-left: 0.75rem !important; padding-right: 0.75rem !important; }
        
        .rounded { border-radius: var(--border-radius) !important; }
        .rounded-circle { border-radius: 50% !important; }
        
        .border { border: 1px solid var(--border-color) !important; }
        .border-top { border-top: 1px solid var(--border-color) !important; }
        .border-bottom { border-bottom: 1px solid var(--border-color) !important; }
        
        .bg-card { background-color: var(--bg-card) !important; }
        .bg-hover { background-color: var(--bg-hover) !important; }
        .bg-active { background-color: var(--bg-active) !important; }
        .bg-primary { background-color: var(--primary-100) !important; }
        .bg-success { background-color: var(--accent-100) !important; }
        .bg-warning { background-color: #fef3c7 !important; }
        .bg-danger { background-color: #fee2e2 !important; }
        
        .shadow-sm { box-shadow: var(--shadow-sm) !important; }
        .shadow { box-shadow: var(--shadow) !important; }
        
        .w-100 { width: 100% !important; }
        .h-100 { height: 100% !important; }
        
        .cursor-pointer { cursor: pointer !important; }
        
        .hidden { display: none !important; }
        
        @media (max-width: 768px) {
            .hidden-sm { display: none !important; }
        }
        
        @media (min-width: 769px) {
            .hidden-lg { display: none !important; }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <button id="mobile-menu-btn" class="btn btn-icon btn-outline hidden-lg">
                        <i class="bi bi-list"></i>
                    </button>
                    <div class="logo-container">
                        <div class="logo">AF</div>
                        <span class="logo-text">Sistema de Limpieza de Flota</span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="weather-display d-flex align-items-center gap-2" id="weather-mini">
                        <i class="bi bi-cloud-sun"></i>
                        <span id="weather-temp">--¬∞C</span>
                    </div>
                    <div class="text-muted hidden-sm" id="now"></div>
                    <button id="notifications-btn" class="btn btn-icon btn-outline position-relative">
                        <i class="bi bi-bell"></i>
                        <span id="notification-badge" class="badge badge-danger position-absolute" style="top: -5px; right: -5px; width: 18px; height: 18px; font-size: 10px; display: none;">0</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-nav">
                    <div class="sidebar-section">
                        <div class="sidebar-section-header">General</div>
                        <ul class="sidebar-menu">
                            <li class="sidebar-menu-item">
                                <a href="#dashboard" class="sidebar-menu-link active" data-page="dashboard">
                                    <span class="sidebar-menu-icon"><i class="bi bi-speedometer2"></i></span>
                                    <span class="sidebar-menu-text">Dashboard</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item">
                                <a href="#registro" class="sidebar-menu-link" data-page="registro">
                                    <span class="sidebar-menu-icon"><i class="bi bi-clipboard-plus"></i></span>
                                    <span class="sidebar-menu-text">Registrar Limpieza</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item">
                                <a href="#pendientes" class="sidebar-menu-link" data-page="pendientes">
                                    <span class="sidebar-menu-icon"><i class="bi bi-exclamation-triangle"></i></span>
                                    <span class="sidebar-menu-text">Pendientes</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item">
                                <a href="#mapa" class="sidebar-menu-link" data-page="mapa">
                                    <span class="sidebar-menu-icon"><i class="bi bi-geo-alt"></i></span>
                                    <span class="sidebar-menu-text">Mapa</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-section-header">Mantenimiento</div>
                        <ul class="sidebar-menu">
                            <li class="sidebar-menu-item">
                                <a href="#reportar-maquina" class="sidebar-menu-link" data-page="reportar-maquina">
                                    <span class="sidebar-menu-icon"><i class="bi bi-tools"></i></span>
                                    <span class="sidebar-menu-text">M√°quinas</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item">
                                <a href="#historial" class="sidebar-menu-link" data-page="historial">
                                    <span class="sidebar-menu-icon"><i class="bi bi-clock-history"></i></span>
                                    <span class="sidebar-menu-text">Historial</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-section-header">Sistema</div>
                        <ul class="sidebar-menu">
                            <li class="sidebar-menu-item">
                                <a href="#reportes" class="sidebar-menu-link" data-page="reportes">
                                    <span class="sidebar-menu-icon"><i class="bi bi-file-earmark-bar-graph"></i></span>
                                    <span class="sidebar-menu-text">Reportes</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item">
                                <a href="#configuracion" class="sidebar-menu-link" data-page="configuracion">
                                    <span class="sidebar-menu-icon"><i class="bi bi-gear"></i></span>
                                    <span class="sidebar-menu-text">Configuraci√≥n</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="sidebar-footer">
                    <div class="user-info">
                        <div class="user-avatar" id="user-initial">U</div>
                        <div class="user-details">
                            <div class="user-name" id="user-name">Usuario</div>
                            <div class="user-role" id="user-terminal">Terminal: Desconocido</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="content-wrapper" id="content">
                <div class="content-inner">
                    <!-- Dashboard Page -->
                    <div class="page active" id="page-dashboard">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1>Dashboard</h1>
                            <div class="d-flex gap-2">
                                <button id="refresh-dashboard" class="btn btn-primary">
                                    <i class="bi bi-arrow-repeat"></i> Actualizar
                                </button>
                            </div>
                        </div>

                        <!-- Weather Alert -->
                        <div class="alert alert-info mb-4" id="weather-alert">
                            <div class="alert-icon"><i class="bi bi-cloud"></i></div>
                            <div class="alert-content">
                                <div class="alert-title" id="weather-title">Cargando clima...</div>
                                <div class="alert-text" id="weather-desc">Obteniendo informaci√≥n meteorol√≥gica actual.</div>
                            </div>
                        </div>

                        <!-- Stats Cards -->
                        <div class="stats-grid">
                            <div class="stat-card stat-card-primary">
                                <div class="stat-header">
                                    <div class="stat-label"><i class="bi bi-clipboard-check"></i> Registros HOY</div>
                                    <div class="stat-icon"><i class="bi bi-clipboard-check"></i></div>
                                </div>
                                <div class="stat-value" id="kpiTotal">0</div>
                                <div class="stat-change" id="kpiTotalChange">
                                    <i class="bi bi-arrow-up"></i> 0% vs. ayer
                                </div>
                            </div>
                            <div class="stat-card stat-card-primary">
                                <div class="stat-header">
                                    <div class="stat-label"><i class="bi bi-broom"></i> Interior HOY</div>
                                    <div class="stat-icon"><i class="bi bi-broom"></i></div>
                                </div>
                                <div class="stat-value" id="kpiInt">0</div>
                                <div class="stat-change" id="kpiIntChange">
                                    <i class="bi bi-arrow-up"></i> 0% vs. ayer
                                </div>
                            </div>
                            <div class="stat-card stat-card-success">
                                <div class="stat-header">
                                    <div class="stat-label"><i class="bi bi-water"></i> Exterior HOY</div>
                                    <div class="stat-icon"><i class="bi bi-water"></i></div>
                                </div>
                                <div class="stat-value" id="kpiExt">0</div>
                                <div class="stat-change" id="kpiExtChange">
                                    <i class="bi bi-arrow-up"></i> 0% vs. ayer
                                </div>
                            </div>
                            <div class="stat-card stat-card-warning">
                                <div class="stat-header">
                                    <div class="stat-label"><i class="bi bi-exclamation-triangle"></i> Pendientes</div>
                                    <div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div>
                                </div>
                                <div class="stat-value" id="kpiPendientes">0</div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="stat-change" id="kpiPendientesChange">
                                        <i class="bi bi-arrow-down"></i> 0% vs. ayer
                                    </div>
                                    <a href="#pendientes" class="text-primary text-sm">Ver todos</a>
                                </div>
                            </div>
                        </div>

                        <!-- Dashboard Grid -->
                        <div class="dashboard-grid">
                            <!-- Pending Tasks -->
                            <div class="grid-col-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-exclamation-triangle"></i> Buses Pendientes</h2>
                                        <span class="badge badge-warning" id="pending-count">0</span>
                                    </div>
                                    <div class="card-body p-2" style="max-height: 400px; overflow-y: auto;">
                                        <div id="pending-buses-container" class="pending-grid">
                                            <!-- Pending cards will be added here -->
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <a href="#pendientes" class="btn btn-sm btn-outline">Ver todos los pendientes</a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Charts -->
                            <div class="grid-col-8">
                                <div class="card">
                                    <div class="tabs-container">
                                        <div class="tabs">
                                            <div class="tab-item active" data-tab="progreso">Progreso Diario</div>
                                            <div class="tab-item" data-tab="distribucion">Distribuci√≥n</div>
                                            <div class="tab-item" data-tab="terminales">Por Terminal</div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="tab-pane active" id="tab_progreso">
                                            <canvas id="progressChart" height="250"></canvas>
                                        </div>
                                        <div class="tab-pane" id="tab_distribucion">
                                            <canvas id="distributionChart" height="250"></canvas>
                                        </div>
                                        <div class="tab-pane" id="tab_terminales">
                                            <canvas id="terminalChart" height="250"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Recent Activity -->
                            <div class="grid-col-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-activity"></i> Actividad Reciente</h2>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="feed-container" id="recent-feed" style="max-height: 300px;">
                                            <!-- Feed items will be added here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Machine Status -->
                            <div class="grid-col-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-tools"></i> Estado de M√°quinas</h2>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="machine-status-container" class="feed-container" style="max-height: 300px;">
                                            <!-- Machine status items will be added here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Registro Page -->
                    <div class="page hidden" id="page-registro">
                        <h1 class="mb-4">Registrar Limpieza</h1>

                        <div class="card mb-4">
                            <div class="card-header">
                                <h2 class="card-title"><i class="bi bi-clipboard-plus"></i> Nuevo registro</h2>
                            </div>
                            <div class="card-body">
                                <form id="formLog" novalidate>
                                    <div class="dashboard-grid">
                                        <div class="grid-col-6">
                                            <div class="form-group">
                                                <label class="form-label" for="busSelect">PPU / Bus</label>
                                                <select id="busSelect" class="form-control" required>
                                                    <option value="">Selecciona bus</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="grid-col-6">
                                            <div class="form-group">
                                                <label class="form-label" for="taskSelect">Tarea realizada</label>
                                                <select id="taskSelect" class="form-control" required>
                                                    <option value="">Elige tarea</option>
                                                    <option value="BARRIDO">Barrido</option>
                                                    <option value="BARRIDO_Y_MOPEO">Barrido y Mopeo</option>
                                                    <option value="FULL">Full (interior + rodillo)</option>
                                                    <option value="LAVADO_RODILLO">Lavado con rodillos</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Fotos (opcional)</label>
                                        <div class="d-flex flex-column gap-2 border rounded p-3">
                                            <div class="d-flex justify-content-center p-3 bg-hover rounded cursor-pointer" id="upload-trigger">
                                                <div class="d-flex flex-column align-items-center">
                                                    <i class="bi bi-cloud-upload text-primary" style="font-size: 2rem;"></i>
                                                    <span class="mt-2">Haz clic para seleccionar fotos</span>
                                                </div>
                                                <input type="file" id="files" multiple accept="image/*" style="display: none;" />
                                            </div>
                                            <div id="previews" class="photo-grid mt-2"></div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <div class="alert alert-primary mb-0">
                                            <div class="alert-icon"><i class="bi bi-geo-alt"></i></div>
                                            <div class="alert-content">
                                                <div class="alert-title">Ubicaci√≥n</div>
                                                <p class="alert-text" id="gpsTxt">GPS: inicializando‚Ä¶</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end gap-3 mt-4">
                                        <button type="button" class="btn btn-outline" onclick="resetForm()">Cancelar</button>
                                        <button type="submit" id="submitBtn" class="btn btn-primary">
                                            <i class="bi bi-save"></i> Guardar registro
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="bi bi-clock-history"></i> √öltimos registros</h2>
                            </div>
                            <div class="card-body p-0">
                                <div class="feed-container" id="registro-recent-feed" style="max-height: 400px;">
                                    <!-- Recent feed items will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pendientes Page -->
                    <div class="page hidden" id="page-pendientes">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="mb-0">Tareas Pendientes</h1>
                            <button id="refresh-pendientes" class="btn btn-primary">
                                <i class="bi bi-arrow-clockwise"></i> Actualizar
                            </button>
                        </div>

                        <div class="dashboard-grid">
                            <div class="grid-col-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-broom"></i> Pendientes Interior</h2>
                                        <span class="badge badge-warning" id="interior-pending-count">0</span>
                                    </div>
                                    <div class="card-body p-2">
                                        <div id="interior-pending-list" class="pending-list-grid">
                                            <!-- Interior pending items will be added here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid-col-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-water"></i> Pendientes Exterior</h2>
                                        <span class="badge badge-warning" id="exterior-pending-count">0</span>
                                    </div>
                                    <div class="card-body p-2">
                                        <div id="exterior-pending-list" class="pending-list-grid">
                                            <!-- Exterior pending items will be added here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h2 class="card-title"><i class="bi bi-grid"></i> Vista de Flota Completa</h2>
                            </div>
                            <div class="card-body p-2">
                                <div id="fleet-status-grid" class="pending-grid">
                                    <!-- Fleet status cards will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mapa Page -->
                    <div class="page hidden" id="page-mapa">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="mb-0">Mapa de Registros</h1>
                            <div class="d-flex gap-2">
                                <select id="map-filter" class="form-control" style="min-width: 180px;">
                                    <option value="all">Todos los registros</option>
                                    <option value="today">Hoy</option>
                                    <option value="interior">Interior</option>
                                    <option value="exterior">Exterior</option>
                                </select>
                                <button id="refresh-map" class="btn btn-primary">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body p-0">
                                <div id="map" class="map-container" aria-label="Mapa de registros"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Reportar M√°quina Page -->
                    <div class="page hidden" id="page-reportar-maquina">
                        <h1 class="mb-4">Reportar M√°quina</h1>

                        <div class="dashboard-grid">
                            <div class="grid-col-5">
                                <div class="card">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-tools"></i> Reportar falla</h2>
                                    </div>
                                    <div class="card-body">
                                        <form id="formMachine" novalidate>
                                            <div class="form-group">
                                                <label class="form-label" for="machineTerminal">Terminal</label>
                                                <select id="machineTerminal" class="form-control" required>
                                                    <option value="">Seleccionar terminal</option>
                                                    <option value="El Roble">El Roble</option>
                                                    <option value="La Reina">La Reina</option>
                                                    <option value="Mar√≠a Ang√©lica">Mar√≠a Ang√©lica</option>
                                                    <option value="El Descanso">El Descanso</option>
                                                </select>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label class="form-label" for="machineType">Tipo de M√°quina</label>
                                                <select id="machineType" class="form-control" required>
                                                    <option value="">Seleccionar tipo</option>
                                                    <option value="RODILLO">M√°quina de Rodillos</option>
                                                    <option value="ASPIRADORA">Aspiradora Industrial</option>
                                                    <option value="HIDROLAVADORA">Hidrolavadora</option>
                                                    <option value="OTRA">Otra</option>
                                                </select>
                                            </div>

                                            <div class="form-group">
                                                <label class="form-label" for="machineIssue">Descripci√≥n del problema</label>
                                                <textarea id="machineIssue" class="form-control" rows="3" required></textarea>
                                            </div>

                                            <div class="form-group">
                                                <label class="form-label" for="machineDate">Fecha de reporte</label>
                                                <input type="datetime-local" id="machineDate" class="form-control" required>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label class="form-label" for="machineEstimate">Estimaci√≥n de reparaci√≥n (d√≠as)</label>
                                                <input type="number" id="machineEstimate" class="form-control" min="1" max="30" value="3">
                                            </div>

                                            <div class="form-group">
                                                <label class="form-label">Fotos (opcional)</label>
                                                <div class="d-flex flex-column gap-2 border rounded p-3">
                                                    <div class="d-flex justify-content-center p-3 bg-hover rounded cursor-pointer" id="machine-upload-trigger">
                                                        <div class="d-flex flex-column align-items-center">
                                                            <i class="bi bi-cloud-upload text-primary" style="font-size: 1.5rem;"></i>
                                                            <span class="mt-2 text-sm">Seleccionar fotos</span>
                                                        </div>
                                                        <input type="file" id="machinePhotos" multiple accept="image/*" style="display: none;" />
                                                    </div>
                                                    <div id="machinePhotoPreviews" class="photo-grid mt-2"></div>
                                                </div>
                                            </div>

                                            <div class="d-flex justify-content-end gap-3 mt-4">
                                                <button type="button" class="btn btn-outline" onclick="resetMachineForm()">Cancelar</button>
                                                <button type="submit" id="machineSubmitBtn" class="btn btn-danger">
                                                    <i class="bi bi-exclamation-triangle"></i> Reportar M√°quina
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid-col-7">
                                <div class="card">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-wrench"></i> M√°quinas Reportadas</h2>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="machine-reports-list" class="feed-container" style="max-height: 600px;">
                                            <!-- Machine reports will be added here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Historial Page -->
                    <div class="page hidden" id="page-historial">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="mb-0">Historial Completo</h1>
                            <div class="d-flex gap-2">
                                <select id="history-filter" class="form-control">
                                    <option value="all">Todos los registros</option>
                                    <option value="today">Hoy</option>
                                    <option value="week">Esta semana</option>
                                    <option value="month">Este mes</option>
                                </select>
                                <button id="export-history" class="btn btn-primary">
                                    <i class="bi bi-download"></i> Exportar
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="bi bi-clock-history"></i> Registros</h2>
                            </div>
                            <div class="card-body p-0">
                                <div class="feed-container" id="history-feed" style="max-height: 600px;">
                                    <!-- History feed items will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reportes Page -->
                    <div class="page hidden" id="page-reportes">
                        <h1 class="mb-4">Reportes y Estad√≠sticas</h1>

                        <div class="dashboard-grid">
                            <div class="grid-col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-calendar3"></i> Cumplimiento Mensual</h2>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="monthlyChart" height="250"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="grid-col-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-pie-chart"></i> Distribuci√≥n por Tipo</h2>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="taskTypeChart" height="250"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="grid-col-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-bar-chart-line"></i> Rendimiento por Terminal</h2>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="terminalPerformanceChart" height="250"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="grid-col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-wrench"></i> M√°quinas - Tiempo Fuera</h2>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="machineDowntimeChart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuraci√≥n Page -->
                    <div class="page hidden" id="page-configuracion">
                        <h1 class="mb-4">Configuraci√≥n</h1>

                        <div class="dashboard-grid">
                            <div class="grid-col-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-sliders"></i> Preferencias del Sistema</h2>
                                    </div>
                                    <div class="card-body">
                                        <form id="configForm">
                                            <h3 class="mb-2 text-primary">Informaci√≥n de Usuario</h3>
                                            <div class="dashboard-grid mb-4">
                                                <div class="grid-col-6">
                                                    <div class="form-group">
                                                        <label class="form-label" for="userName">Nombre de usuario</label>
                                                        <input type="text" id="userName" class="form-control" placeholder="Tu nombre">
                                                    </div>
                                                </div>
                                                <div class="grid-col-6">
                                                    <div class="form-group">
                                                        <label class="form-label" for="userTerminal">Terminal asignado</label>
                                                        <select id="userTerminal" class="form-control">
                                                            <option value="">Seleccionar terminal</option>
                                                            <option value="El Roble">El Roble</option>
                                                            <option value="La Reina">La Reina</option>
                                                            <option value="Mar√≠a Ang√©lica">Mar√≠a Ang√©lica</option>
                                                            <option value="El Descanso">El Descanso</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>

                                            <h3 class="mb-2 text-primary">Preferencias Generales</h3>
                                            <div class="form-group mb-2">
                                                <div class="d-flex align-items-center justify-content-between p-2 border rounded">
                                                    <label for="notificationsEnabled" class="mb-0">Notificaciones en tiempo real</label>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="notificationsEnabled" checked>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="form-group mb-2">
                                                <div class="d-flex align-items-center justify-content-between p-2 border rounded">
                                                    <label for="gpsEnabled" class="mb-0">Rastreo GPS autom√°tico</label>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="gpsEnabled" checked>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="form-group mb-4">
                                                <div class="d-flex align-items-center justify-content-between p-2 border rounded">
                                                    <label for="autoResetOnRain" class="mb-0">Resetear pendientes al detectar lluvia</label>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="autoResetOnRain" checked>
                                                    </div>
                                                </div>
                                            </div>

                                            <h3 class="mb-2 text-primary">Clima</h3>
                                            <div class="form-group mb-4">
                                                <label class="form-label" for="weatherLocation">Ubicaci√≥n para clima</label>
                                                <input type="text" id="weatherLocation" class="form-control" placeholder="Santiago, CL" value="Santiago, CL">
                                            </div>

                                            <div class="d-flex justify-content-end">
                                                <button type="submit" id="saveConfigBtn" class="btn btn-primary">
                                                    <i class="bi bi-check-lg"></i> Guardar configuraci√≥n
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid-col-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-info-circle"></i> Informaci√≥n del Sistema</h2>
                                    </div>
                                    <div class="card-body">
                                        <div class="dashboard-grid">
                                            <div class="grid-col-6">
                                                <div class="mb-3">
                                                    <strong class="d-block text-sm">Versi√≥n:</strong>
                                                    <span class="badge badge-primary">3.0.0</span>
                                                </div>
                                                <div class="mb-3">
                                                    <strong class="d-block text-sm">Dispositivo:</strong>
                                                    <span id="device-info" class="text-secondary">Cargando...</span>
                                                </div>
                                                <div class="mb-3">
                                                    <strong class="d-block text-sm">ID de dispositivo:</strong>
                                                    <span id="device-id" class="text-secondary">Cargando...</span>
                                                </div>
                                            </div>
                                            <div class="grid-col-6">
                                                <div class="mb-3">
                                                    <strong class="d-block text-sm">Navegador:</strong>
                                                    <span id="browser-info" class="text-secondary">Cargando...</span>
                                                </div>
                                                <div class="mb-3">
                                                    <strong class="d-block text-sm">Conectividad:</strong>
                                                    <span id="connectivity" class="text-secondary">Cargando...</span>
                                                </div>
                                                <div class="mb-3">
                                                    <strong class="d-block text-sm">Base de datos:</strong>
                                                    <span id="db-status" class="text-secondary">Verificando conexi√≥n...</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="alert alert-primary mt-3">
                                            <div class="alert-icon"><i class="bi bi-shield-check"></i></div>
                                            <div class="alert-content">
                                                <div class="alert-title">Sistema Seguro</div>
                                                <p class="alert-text mb-0">Todos los datos son almacenados de forma segura y sincronizados en tiempo real con el servidor central.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mt-4">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-database-check"></i> Sincronizaci√≥n</h2>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div>
                                                <strong class="d-block">Estado:</strong>
                                                <span id="sync-status" class="badge badge-success">Sincronizado</span>
                                            </div>
                                            <button id="force-sync" class="btn btn-sm btn-primary">
                                                <i class="bi bi-arrow-repeat"></i> Forzar sincronizaci√≥n
                                            </button>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <strong class="d-block text-sm">√öltima sincronizaci√≥n:</strong>
                                            <span id="last-sync" class="text-secondary">Nunca</span>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <strong class="d-block text-sm">Elementos pendientes:</strong>
                                            <span id="pending-sync" class="text-secondary">0 elementos</span>
                                        </div>
                                        
                                        <div class="alert alert-info mb-0">
                                            <div class="alert-content">
                                                <p class="alert-text mb-0">
                                                    <i class="bi bi-info-circle"></i> La sincronizaci√≥n autom√°tica ocurre cada 5 minutos cuando hay conexi√≥n a internet.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="mt-4 mb-5 text-center text-muted">
                    <div>
                        <p>¬© <span id="yy"></span> Sistema de Limpieza de Flota ¬∑ Versi√≥n 3.0</p>
                    </div>
                </footer>
            </div>
        </div>

        <!-- Mobile Navigation -->
        <div class="mobile-nav">
            <div class="mobile-nav-container">
                <a href="#dashboard" class="mobile-nav-item active" data-page="dashboard">
                    <i class="mobile-nav-icon bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#registro" class="mobile-nav-item" data-page="registro">
                    <i class="mobile-nav-icon bi bi-clipboard-plus"></i>
                    <span>Registrar</span>
                </a>
                <a href="#pendientes" class="mobile-nav-item" data-page="pendientes">
                    <i class="mobile-nav-icon bi bi-exclamation-triangle"></i>
                    <span>Pendientes</span>
                </a>
                <a href="#mapa" class="mobile-nav-item" data-page="mapa">
                    <i class="mobile-nav-icon bi bi-geo-alt"></i>
                    <span>Mapa</span>
                </a>
                <a href="#" class="mobile-nav-item" id="mobile-more-btn">
                    <i class="mobile-nav-icon bi bi-three-dots"></i>
                    <span>M√°s</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notification-panel">
        <div class="notification-header">
            <h3 class="notification-title">Notificaciones</h3>
            <button id="close-notifications" class="btn btn-icon btn-outline">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="notification-list" id="notification-list">
            <!-- Notifications will be added here -->
        </div>
        <div class="notification-footer">
            <button id="mark-all-read" class="btn btn-outline">
                <i class="bi bi-check-all"></i> Marcar como le√≠das
            </button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container">
        <!-- Toasts will be added here -->
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
        <div class="lightbox-content">
            <img src="" alt="Imagen ampliada" class="lightbox-img" id="lightbox-img">
        </div>
        <div class="lightbox-close" id="lightbox-close">
            <i class="bi bi-x"></i>
        </div>
    </div>

    <!-- Modal Templates -->
    <div class="modal-backdrop" id="log-detail-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Detalles del Registro</h3>
                <button class="modal-close" data-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body" id="log-detail-content">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="bus-detail-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="bus-detail-title">Detalles del Bus</h3>
                <button class="modal-close" data-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body" id="bus-detail-content">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" data-dismiss="modal">Cerrar</button>
                <button class="btn btn-primary" id="register-bus-cleaning">Registrar Limpieza</button>
            </div>
        </div>
    </div>

    <script>
        // === CONFIG ===
        const SUPABASE_URL = "https://tcmtxvuucjttngcazgff.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjbXR4dnV1Y2p0dG5nY2F6Z2ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA3MjUwMDEsImV4cCI6MjA1NjMwMTAwMX0.2WcIjMUEhSM6j9kYpbsYArQocZdHx86k7wXk-NyjIs0";

        // Configuraci√≥n de terminales
        const TERMINALES = [
            { nombre: "El Roble", lat: -33.44071194412281, lng: -70.78973603006452 },
            { nombre: "La Reina", lat: -33.4648451661274, lng: -70.53179284909858 },
            { nombre: "Mar√≠a Ang√©lica", lat: -33.51772240158645, lng: -70.55641931656773 },
            { nombre: "El Descanso", lat: -33.4695150389365, lng: -70.76243487908678 },
        ];

        // Tipos de tareas
        const TASKS = [
            { code: 'BARRIDO', label: 'Barrido', icon: 'bi-broom', interior: true, exterior: false },
            { code: 'BARRIDO_Y_MOPEO', label: 'Barrido y Mopeo', icon: 'bi-droplet', interior: true, exterior: false },
            { code: 'FULL', label: 'Full (interior + rodillo)', icon: 'bi-check2-all', interior: true, exterior: true },
            { code: 'LAVADO_RODILLO', label: 'Lavado con rodillos', icon: 'bi-water', interior: false, exterior: true },
        ];

        // === STATE ===
        let sb = null;
        let buses = [];
        let logs = [];
        let pendientes = [];
        let machineReports = [];
        let notifications = [];
        let gps = { lat: null, lng: null, ts: null };
        let map, clusterLayer, terminalsLayer, baseLayers;
        let charts = {};
        let gpsWatchId = null;
        let deviceId = generateDeviceId();
        let userConfig = {
            userName: 'Usuario',
            userTerminal: '',
            notificationsEnabled: true,
            gpsEnabled: true,
            autoResetOnRain: true,
            weatherLocation: 'Santiago, CL'
        };
        let weatherData = {
            temp: null,
            description: '',
            icon: '',
            isRaining: false,
            lastUpdated: null
        };
        let selectedBusId = null;
        
        // === UTILS ===
        // Simplificar selecciones DOM
        const $ = (sel, context = document) => context.querySelector(sel);
        const $$ = (sel, context = document) => Array.from(context.querySelectorAll(sel));

        // Funci√≥n para generar un ID de dispositivo √∫nico
        function generateDeviceId() {
            let deviceId = localStorage.getItem('flota_device_id');
            if (deviceId) return deviceId;

            const timestamp = Date.now().toString(36);
            const randomStr = Math.random().toString(36).substring(2, 8);
            const screenSize = `${window.screen.width}x${window.screen.height}`.replace(/\D/g, '');
            const colorDepth = window.screen.colorDepth || 0;
            const timezone = new Date().getTimezoneOffset();

            deviceId = `${timestamp}-${randomStr}-${screenSize}-${colorDepth}-${timezone}`.replace(/[^a-zA-Z0-9-]/g, '');
            localStorage.setItem('flota_device_id', deviceId);
            return deviceId;
        }

        // Mostrar toast notifications
        function showToast(message, type = 'info') {
            const container = $('#toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            let icon = 'bi-info-circle';
            if (type === 'success') icon = 'bi-check-circle';
            if (type === 'error') icon = 'bi-exclamation-circle';
            if (type === 'warning') icon = 'bi-exclamation-triangle';

            toast.innerHTML = `
                <div class="toast-icon"><i class="bi ${icon}"></i></div>
                <div class="toast-body">
                    <div>${message}</div>
                </div>
                <button type="button" class="toast-close"><i class="bi bi-x"></i></button>
            `;

            container.appendChild(toast);

            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 5000);

            // Manual close
            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            });
        }

        // Detectar info del dispositivo
        function detectDeviceInfo() {
            const userAgent = navigator.userAgent;
            let deviceInfo = 'Desconocido';
            let browserInfo = 'Desconocido';

            // Detectar dispositivo
            if (/Android/i.test(userAgent)) {
                deviceInfo = `Android ${/Android (\d+\.\d+)/.test(userAgent) ? userAgent.match(/Android (\d+\.\d+)/)[1] : ''}`;
            } else if (/iPhone|iPad|iPod/i.test(userAgent)) {
                deviceInfo = 'iOS';
                if (/iPhone/i.test(userAgent)) deviceInfo = 'iPhone';
                if (/iPad/i.test(userAgent)) deviceInfo = 'iPad';
                if (/iPod/i.test(userAgent)) deviceInfo = 'iPod';
            } else if (/Windows/i.test(userAgent)) {
                deviceInfo = 'PC Windows';
            } else if (/Macintosh/i.test(userAgent)) {
                deviceInfo = 'Mac';
            } else if (/Linux/i.test(userAgent)) {
                deviceInfo = 'PC Linux';
            }

            // Detectar navegador
            if (/Chrome/i.test(userAgent) && !/Chromium|Edge|Edg|OPR|SamsungBrowser/i.test(userAgent)) {
                browserInfo = `Chrome ${/Chrome\/(\d+)/.test(userAgent) ? userAgent.match(/Chrome\/(\d+)/)[1] : ''}`;
            } else if (/Firefox/i.test(userAgent)) {
                browserInfo = `Firefox ${/Firefox\/(\d+)/.test(userAgent) ? userAgent.match(/Firefox\/(\d+)/)[1] : ''}`;
            } else if (/Safari/i.test(userAgent) && !/Chrome|Chromium|Edge|Edg|OPR/i.test(userAgent)) {
                browserInfo = `Safari ${/Version\/(\d+\.\d+)/.test(userAgent) ? userAgent.match(/Version\/(\d+\.\d+)/)[1] : ''}`;
            } else if (/Edge|Edg/i.test(userAgent)) {
                browserInfo = `Edge ${/Edge\/(\d+)|Edg\/(\d+)/.test(userAgent) ? (userAgent.match(/Edge\/(\d+)/) || userAgent.match(/Edg\/(\d+)/))[1] : ''}`;
            } else if (/OPR/i.test(userAgent)) {
                browserInfo = `Opera ${/OPR\/(\d+)/.test(userAgent) ? userAgent.match(/OPR\/(\d+)/)[1] : ''}`;
            } else if (/SamsungBrowser/i.test(userAgent)) {
                browserInfo = `Samsung Browser ${/SamsungBrowser\/(\d+\.\d+)/.test(userAgent) ? userAgent.match(/SamsungBrowser\/(\d+\.\d+)/)[1] : ''}`;
            }

            return { deviceInfo, browserInfo };
        }

        // Calcular distancia entre coordenadas (Haversine)
        function haversineKm(a, b) {
            const R = 6371;
            const dLat = ((b.lat - a.lat) * Math.PI) / 180;
            const dLon = ((b.lng - a.lng) * Math.PI) / 180;
            const lat1 = (a.lat * Math.PI) / 180;
            const lat2 = (b.lat * Math.PI) / 180;
            const x = Math.sin(dLat / 2) ** 2 + Math.sin(dLon / 2) ** 2 * Math.cos(lat1) * Math.cos(lat2);
            const d = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1 - x));
            return R * d;
        }

        // Encontrar el terminal m√°s cercano
        function nearestTerminal(lat, lng) {
            const base = { lat, lng };
            let best = { nombre: '?', dist: Infinity };
            for (const t of TERMINALES) {
                const d = haversineKm(base, t);
                if (d < best.dist) best = { nombre: t.nombre, dist: d };
            }
            return best;
        }

        // Formatear fecha
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleString('es-CL', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        // Formatear fecha corta
        function formatShortDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('es-CL', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Formatear fecha relativa
        function formatRelativeTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);

            if (diffSec < 60) {
                return 'hace unos segundos';
            } else if (diffMin < 60) {
                return `hace ${diffMin} ${diffMin === 1 ? 'minuto' : 'minutos'}`;
            } else if (diffHour < 24) {
                return `hace ${diffHour} ${diffHour === 1 ? 'hora' : 'horas'}`;
            } else if (diffDay < 7) {
                return `hace ${diffDay} ${diffDay === 1 ? 'd√≠a' : 'd√≠as'}`;
            } else {
                return formatShortDate(dateStr);
            }
        }

        // === INICIALIZACI√ìN ===
        async function initSupabase() {
            try {
                if (SUPABASE_URL && SUPABASE_ANON_KEY) {
                    sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });
                    console.log("Cliente Supabase inicializado correctamente");
                    return true;
                } else {
                    console.log("Modo demostraci√≥n activado (sin Supabase)");
                    return false;
                }
            } catch (error) {
                console.error("Error inicializando Supabase:", error);
                showToast("Error de conexi√≥n con la base de datos", "error");
                return false;
            }
        }

        async function loadUserConfig() {
            const savedConfig = localStorage.getItem('flota_user_config');
            if (savedConfig) {
                try {
                    const parsed = JSON.parse(savedConfig);
                    userConfig = { ...userConfig, ...parsed };
                } catch (e) {
                    console.error("Error cargando configuraci√≥n:", e);
                }
            }

            // Aplicar configuraci√≥n a la interfaz
            $('#userName').value = userConfig.userName || '';
            $('#userTerminal').value = userConfig.userTerminal || '';
            $('#notificationsEnabled').checked = userConfig.notificationsEnabled !== false;
            $('#gpsEnabled').checked = userConfig.gpsEnabled !== false;
            $('#autoResetOnRain').checked = userConfig.autoResetOnRain !== false;
            $('#weatherLocation').value = userConfig.weatherLocation || 'Santiago, CL';

            // Actualizar UI con la configuraci√≥n cargada
            updateUserUI();
        }

        function saveUserConfig() {
            userConfig.userName = $('#userName').value;
            userConfig.userTerminal = $('#userTerminal').value;
            userConfig.notificationsEnabled = $('#notificationsEnabled').checked;
            userConfig.gpsEnabled = $('#gpsEnabled').checked;
            userConfig.autoResetOnRain = $('#autoResetOnRain').checked;
            userConfig.weatherLocation = $('#weatherLocation').value;

            localStorage.setItem('flota_user_config', JSON.stringify(userConfig));
            updateUserUI();
            showToast("Configuraci√≥n guardada correctamente", "success");
        }

        function updateUserUI() {
            // Actualizar nombre e inicial en sidebar
            $('#user-name').textContent = userConfig.userName || 'Usuario';
            $('#user-terminal').textContent = `Terminal: ${userConfig.userTerminal || 'Desconocido'}`;
            $('#user-initial').textContent = (userConfig.userName || 'U').charAt(0).toUpperCase();

            // Gestionar GPS seg√∫n preferencias
            if (userConfig.gpsEnabled) {
                startGPSWatch();
            } else if (gpsWatchId !== null) {
                try {
                    navigator.geolocation.clearWatch(gpsWatchId);
                    gpsWatchId = null;
                } catch (e) { }
                $('#gpsTxt').textContent = 'GPS: Desactivado en configuraci√≥n';
            }
        }

        // === GEOLOCALIZACI√ìN ===
        function startGPSWatch() {
            const gpsTxt = $('#gpsTxt');
            if (!gpsTxt) return;

            if (!navigator.geolocation) {
                gpsTxt.textContent = 'GPS: no disponible en este navegador';
                return;
            }

            try {
                if (gpsWatchId !== null) navigator.geolocation.clearWatch(gpsWatchId);
            } catch (e) { }

            gpsWatchId = navigator.geolocation.watchPosition(
                pos => {
                    gps = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        ts: Date.now(),
                        accuracy: pos.coords.accuracy
                    };

                    const nearest = nearestTerminal(gps.lat, gps.lng);
                    gpsTxt.innerHTML = `
                        <div class="d-flex justify-content-between gap-2">
                            <span>GPS: <span class="text-success">Activo</span> (Precisi√≥n: ${gps.accuracy.toFixed(1)}m)</span>
                            <span>Terminal m√°s cercano: <strong>${nearest.nombre}</strong> (${nearest.dist.toFixed(1)} km)</span>
                        </div>
                    `;

                    // Actualizar terminal del usuario si no est√° configurado
                    if (!userConfig.userTerminal && nearest.dist < 1) { // Si est√° a menos de 1km
                        userConfig.userTerminal = nearest.nombre;
                        localStorage.setItem('flota_user_config', JSON.stringify(userConfig));
                        updateUserUI();
                    }

                    // Si estamos en la p√°gina del mapa, actualizar posici√≥n actual
                    if ($('#map') && map) {
                        updateCurrentPositionMarker();
                    }
                },
                err => {
                    let errorMsg = 'GPS: sin se√±al';
                    switch (err.code) {
                        case err.PERMISSION_DENIED:
                            errorMsg = 'GPS: permiso denegado por el usuario';
                            break;
                        case err.POSITION_UNAVAILABLE:
                            errorMsg = 'GPS: posici√≥n no disponible';
                            break;
                        case err.TIMEOUT:
                            errorMsg = 'GPS: tiempo de espera agotado';
                            break;
                    }
                    gpsTxt.innerHTML = `<span class="text-danger">${errorMsg}</span>`;
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000 }
            );
        }

        // === CLIMA ===
        async function fetchWeather() {
            const location = userConfig.weatherLocation || 'Santiago, CL';
            const apiKey = ''; // OpenWeather API Key - TO BE ADDED DURING DEPLOYMENT

            // Si no hay API key, simular datos
            if (!apiKey) {
                simulateWeather();
                return;
            }

            try {
                const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(location)}&units=metric&appid=${apiKey}`);

                if (!response.ok) {
                    throw new Error('Error obteniendo datos del clima');
                }

                const data = await response.json();

                weatherData = {
                    temp: Math.round(data.main.temp),
                    description: data.weather[0].description,
                    icon: data.weather[0].icon,
                    isRaining: data.weather[0].main === 'Rain' || data.weather[0].id >= 500 && data.weather[0].id < 600,
                    lastUpdated: new Date()
                };

                updateWeatherUI();

                // Comprobar si est√° lloviendo y hay que resetear pendientes
                if (weatherData.isRaining && userConfig.autoResetOnRain) {
                    checkRainReset();
                }
            } catch (error) {
                console.error('Error fetching weather:', error);
                simulateWeather();
            }
        }

        function simulateWeather() {
            const now = new Date();
            const hour = now.getHours();
            const isNight = hour < 6 || hour > 18;
            const randomTemp = Math.floor(Math.random() * 10) + (isNight ? 10 : 20);
            const conditions = ['Despejado', 'Parcialmente nublado', 'Nublado', 'Lluvia ligera'];
            const randomCondition = conditions[Math.floor(Math.random() * conditions.length)];
            const isRaining = randomCondition.includes('lluvia');

            weatherData = {
                temp: randomTemp,
                description: randomCondition,
                icon: isNight ? 'moon' : 'sun',
                isRaining: isRaining,
                lastUpdated: new Date()
            };

            updateWeatherUI();
        }

        function updateWeatherUI() {
            // Mini indicador en header
            const weatherMini = $('#weather-mini');
            if (weatherMini) {
                let icon = 'bi-sun';
                if (weatherData.description.includes('nub')) icon = 'bi-cloud-sun';
                if (weatherData.description.includes('lluv') || weatherData.isRaining) icon = 'bi-cloud-rain';
                if (weatherData.description.includes('noche') || weatherData.icon?.includes('n')) icon = 'bi-moon';

                weatherMini.innerHTML = `
                    <i class="bi ${icon}"></i>
                    <span>${weatherData.temp}¬∞C</span>
                `;
            }

            // Alerta en dashboard
            const weatherAlert = $('#weather-alert');
            const weatherTitle = $('#weather-title');
            const weatherDesc = $('#weather-desc');
            
            if (weatherAlert && weatherTitle && weatherDesc) {
                let icon = 'bi-sun';
                let alertClass = 'alert-info';
                let title = `${weatherData.temp}¬∞C - ${weatherData.description}`;
                let description = 'Condiciones normales de operaci√≥n.';

                if (weatherData.description.includes('nub')) {
                    icon = 'bi-cloud-sun';
                }
                
                if (weatherData.description.includes('lluv') || weatherData.isRaining) {
                    icon = 'bi-cloud-rain';
                    alertClass = 'alert-warning';
                    description = '¬°Alerta de lluvia! Los lavados exteriores se han suspendido autom√°ticamente.';
                }
                
                if (weatherData.description.includes('noche') || weatherData.icon?.includes('n')) {
                    icon = 'bi-moon';
                }

                weatherAlert.className = 'alert ' + alertClass + ' mb-4';
                $('.alert-icon', weatherAlert).innerHTML = `<i class="bi ${icon}"></i>`;
                weatherTitle.textContent = title;
                weatherDesc.textContent = description;
            }
        }

        function checkRainReset() {
            const lastRainReset = localStorage.getItem('last_rain_reset');
            const now = new Date();
            const today = now.toISOString().split('T')[0];

            // Si no se ha reseteado hoy y est√° lloviendo
            if (lastRainReset !== today && weatherData.isRaining) {
                showNotification(
                    '¬°Alerta de lluvia!',
                    'Se ha detectado lluvia. Los lavados exteriores se han suspendido. Se marcar√° como "pendientes" los buses para mantenimiento exterior.',
                    'warning'
                );

                // Crear pendientes para todos los buses
                if (buses.length > 0) {
                    buses.forEach(bus => {
                        const existingPending = pendientes.find(p => p.bus_id === bus.id && p.task === 'LAVADO_RODILLO');
                        if (!existingPending) {
                            pendientes.push({
                                id: `pending-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
                                bus_id: bus.id,
                                plate: bus.plate,
                                task: 'LAVADO_RODILLO',
                                created_at: new Date().toISOString(),
                                terminal: bus.terminal || userConfig.userTerminal,
                                reason: 'Suspendido por lluvia'
                            });
                        }
                    });

                    renderPendientes();
                    savePendientes();
                }

                localStorage.setItem('last_rain_reset', today);
            }
        }

        // === MAPA ===
        function initMap() {
            const mapContainer = $('#map');
            if (!mapContainer) return;

            // Crear mapa con vista centrada en Santiago
            map = L.map('map', { zoomControl: true }).setView([-33.47, -70.73], 12);

            // Capas base
            const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles ¬© Esri ‚Äî Source: Esri, Maxar, Earthstar Geographics'
            });

            const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            const dark = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {
                attribution: '&copy; CartoDB, OpenStreetMap'
            });

            baseLayers = {
                'Calles': streets,
                'Sat√©lite': sat,
                'Oscuro': dark
            };

            // Capa de clusters para markers
            clusterLayer = L.markerClusterGroup({
                showCoverageOnHover: false,
                disableClusteringAtZoom: 15,
                spiderfyOnMaxZoom: true,
                maxClusterRadius: 60
            });
            map.addLayer(clusterLayer);

            // Capa para terminales
            terminalsLayer = L.layerGroup().addTo(map);
            for (const t of TERMINALES) {
                L.marker([t.lat, t.lng], {
                    icon: L.divIcon({
                        html: `<div style="background-color: white; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 3px solid #4f46e5;">
                            <i class="bi bi-building" style="color: #4f46e5; font-size: 18px;"></i>
                        </div>`,
                        className: 'custom-terminal-icon',
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    })
                })
                .addTo(terminalsLayer)
                .bindPopup(`<div style="text-align: center; font-weight: bold; padding: 5px;">Terminal ${t.nombre}</div>`);
            }

            // Capa para posici√≥n actual
            currentPositionLayer = L.layerGroup().addTo(map);
            updateCurrentPositionMarker();

            // Control de capas
            L.control.layers(
                baseLayers,
                { 'Registros': clusterLayer, 'Terminales': terminalsLayer, 'Mi posici√≥n': currentPositionLayer },
                { collapsed: true }
            ).addTo(map);

            // Evento de cambio de filtro
            $('#map-filter')?.addEventListener('change', () => {
                refreshMarkers();
            });

            // Actualizar tama√±o del mapa
            setTimeout(() => map.invalidateSize(), 100);
        }

        function updateCurrentPositionMarker() {
            if (!currentPositionLayer || !gps.lat || !gps.lng) return;
            
            currentPositionLayer.clearLayers();
            
            // Crear el marcador de posici√≥n actual con un c√≠rculo de precisi√≥n
            const accuracyCircle = L.circle([gps.lat, gps.lng], {
                radius: gps.accuracy || 50,
                color: '#4f46e5',
                fillColor: '#818cf8',
                fillOpacity: 0.2,
                weight: 1
            }).addTo(currentPositionLayer);
            
            const positionMarker = L.marker([gps.lat, gps.lng], {
                icon: L.divIcon({
                    html: `<div style="background-color: white; width: 32px; height: 32px; display: flex; justify-content: center; align-items: center; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 3px solid #4f46e5;">
                        <i class="bi bi-person" style="color: #4f46e5; font-size: 16px;"></i>
                    </div>`,
                    className: 'custom-position-icon',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                })
            }).addTo(currentPositionLayer);
            
            positionMarker.bindPopup(`
                <div style="text-align: center; padding: 5px;">
                    <strong>Mi posici√≥n actual</strong><br>
                    Precisi√≥n: ${gps.accuracy ? gps.accuracy.toFixed(1) + 'm' : 'Desconocida'}
                </div>
            `);
        }

        function refreshMarkers() {
            if (!clusterLayer) return;

            clusterLayer.clearLayers();
            const pts = [];

            // Aplicar filtro
            const filterValue = $('#map-filter')?.value || 'all';
            let filteredLogs = [...logs];

            if (filterValue === 'today') {
                const todayStr = new Date().toISOString().slice(0, 10);
                filteredLogs = logs.filter(l => (l.created_at || '').slice(0, 10) === todayStr);
            } else if (filterValue === 'interior') {
                filteredLogs = logs.filter(l => l.inside_cleaned);
            } else if (filterValue === 'exterior') {
                filteredLogs = logs.filter(l => l.outside_cleaned);
            }

            const data = filteredLogs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            for (const l of data) {
                if (l.gps_lat && l.gps_lng) {
                    // Seleccionar √≠cono seg√∫n tipo de tarea
                    let iconClass = 'bi-geo';
                    let iconColor = '#4f46e5';

                    if (l.inside_cleaned && !l.outside_cleaned) {
                        iconClass = 'bi-broom';
                        iconColor = '#4f46e5';
                    } else if (!l.inside_cleaned && l.outside_cleaned) {
                        iconClass = 'bi-water';
                        iconColor = '#10b981';
                    } else if (l.inside_cleaned && l.outside_cleaned) {
                        iconClass = 'bi-check2-all';
                        iconColor = '#8b5cf6';
                    }

                    // Crear HTML para el √≠cono personalizado
                    const iconHtml = `
                        <div style="background-color: white; width: 32px; height: 32px; display: flex; justify-content: center; align-items: center; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 2px solid ${iconColor};">
                            <i class="bi ${iconClass}" style="color: ${iconColor}; font-size: 16px;"></i>
                        </div>
                    `;

                    // Crear icono personalizado
                    const customIcon = L.divIcon({
                        html: iconHtml,
                        className: 'custom-map-icon',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });

                    // Crear marcador con icono personalizado
                    const m = L.marker([l.gps_lat, l.gps_lng], { icon: customIcon });

                    // Contenido del popup
                    const body = `
                        <div style="min-width: 200px; text-align: center;">
                            <h3 style="margin: 0 0 5px; font-size: 16px;">${l.plate || 'Bus'}</h3>
                            <p style="margin: 0 0 8px; font-size: 12px; color: #6b7280;">
                                ${formatDate(l.created_at)}
                            </p>
                            <div style="font-weight: 600; margin-bottom: 8px;">${l.task_type.replaceAll('_', ' ')}</div>
                            <div style="margin-top: 5px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                                ${l.inside_cleaned ? '<span style="background: #e0e7ff; color: #4338ca; padding: 3px 8px; border-radius: 999px; font-size: 12px;">Interior</span>' : ''}
                                ${l.outside_cleaned ? '<span style="background: #d1fae5; color: #047857; padding: 3px 8px; border-radius: 999px; font-size: 12px;">Exterior</span>' : ''}
                            </div>
                            ${l.photos && l.photos.length > 0 ? `
                                <div style="margin-top: 8px; font-size: 12px; text-align: center;">
                                    <a href="#" onclick="showLogDetails('${l.id}'); return false;">Ver detalles</a>
                                </div>
                            ` : ''}
                        </div>
                    `;

                    m.bindPopup(body);
                    clusterLayer.addLayer(m);
                    pts.push([l.gps_lat, l.gps_lng]);
                }
            }

            // Ajustar vista del mapa si hay puntos
            if (pts.length) {
                const b = L.latLngBounds(pts);
                map.fitBounds(b.pad(0.2));
            }
        }

        // === CARGA DE DATOS ===
        async function loadBuses() {
            const sel = $('#busSelect');
            if (!sel) return;

            sel.innerHTML = '<option value="">Cargando‚Ä¶</option>';

            try {
                if (sb) {
                    const { data, error } = await sb.from('buses')
                        .select('id,ppu,terminal:numero_interno')
                        .order('ppu', { ascending: true });

                    if (error) throw error;

                    // Mapear los datos recibidos para usar 'plate' internamente
                    buses = (data || []).map(bus => ({
                        id: bus.id,
                        plate: bus.ppu, // Asignar ppu a plate para uso interno
                        terminal: bus.terminal
                    }));
                } else {
                    // Sin datos de ejemplo
                    buses = [];
                    showToast("Modo sin conexi√≥n. Configura Supabase para funcionalidad completa.", "warning");
                }

                sel.innerHTML = '<option value="">Selecciona bus</option>' +
                    buses.map(b => `<option value="${b.id}">${b.plate}${b.terminal ? ` ¬∑ ${b.terminal}` : ''}</option>`).join('');
            } catch (error) {
                console.error('Error cargando buses:', error);
                showToast('Error cargando buses: ' + error.message, 'error');
                buses = [];
                sel.innerHTML = '<option value="">Error cargando buses</option>';
            }
        }

        async function loadLogs() {
            try {
                showToast("Cargando registros...", "info");

                if (sb) {
                    console.log("Consultando registros desde Supabase...");

                    // Consulta directa a la tabla cleaning_logs en lugar de la vista
                    const { data, error } = await sb.from('cleaning_logs')
                        .select('id, created_at, bus_id, task_type, gps_lat, gps_lng, photos, inside_cleaned, outside_cleaned, user_name, device_id')
                        .order('created_at', { ascending: false })
                        .limit(1000);

                    if (error) {
                        console.error("Error en consulta:", error);
                        throw error;
                    }

                    console.log("Registros obtenidos:", data?.length || 0);

                    if (data && data.length > 0) {
                        // Transformar datos para incluir la placa del bus
                        logs = await Promise.all(data.map(async (log) => {
                            // Buscar informaci√≥n del bus
                            let busPlate = 'Sin placa';
                            try {
                                // Obtener la placa directamente para cada bus
                                const { data: busData } = await sb.from('buses')
                                    .select('ppu')
                                    .eq('id', log.bus_id)
                                    .single();

                                if (busData) {
                                    busPlate = busData.ppu;
                                }
                            } catch (e) {
                                console.warn("No se pudo obtener placa para bus ID:", log.bus_id);
                            }

                            return {
                                id: log.id,
                                created_at: log.created_at,
                                bus_id: log.bus_id,
                                plate: busPlate,
                                task_type: log.task_type,
                                gps_lat: log.gps_lat,
                                gps_lng: log.gps_lng,
                                photos: log.photos || [],
                                inside_cleaned: log.inside_cleaned,
                                outside_cleaned: log.outside_cleaned,
                                user_name: log.user_name || 'Usuario',
                                device_id: log.device_id
                            };
                        }));

                        showToast(`Se cargaron ${logs.length} registros`, "success");
                    } else {
                        logs = [];
                        showToast("No se encontraron registros", "info");
                    }
                } else {
                    logs = []; // Sin datos si no hay conexi√≥n
                    showToast("No hay conexi√≥n a la base de datos", "warning");
                }

                // Actualizar UI despu√©s de cargar los datos
                console.log("Actualizando UI con", logs.length, "registros");
                renderFeed();
                renderFleetStatus();
                generatePendientes();

                if (clusterLayer) refreshMarkers();
                renderKPIs();

            } catch (error) {
                console.error('Error cargando registros:', error);
                showToast('Error cargando registros: ' + error.message, 'error');
                logs = [];

                // Intentar mostrar UI incluso con error
                renderFeed();
            }
        }

        function loadPendientes() {
            try {
                // Limpiar pendientes existentes
                pendientes = [];

                // Si hay pendientes guardados localmente, intentar cargarlos
                const savedPendientes = localStorage.getItem('flota_pendientes');
                if (savedPendientes) {
                    try {
                        const parsed = JSON.parse(savedPendientes);
                        // Validar que cada pendiente tenga la estructura correcta y 
                        // que el bus asociado exista realmente
                        parsed.forEach(pendiente => {
                            // Verificar que el bus existe en la base de datos real
                            const busExists = buses.some(bus => bus.id === pendiente.bus_id);
                            if (busExists) {
                                pendientes.push(pendiente);
                            }
                        });
                    } catch (e) {
                        console.error('Error en formato de pendientes guardados:', e);
                    }
                }

                // Actualizar la UI con solo los pendientes v√°lidos
                renderPendientes();
            } catch (e) {
                console.error('Error cargando pendientes:', e);
                pendientes = [];
                renderPendientes();
            }
        }

        function savePendientes() {
            // Filtrar para asegurar que solo se guarden pendientes con buses reales
            const validPendientes = pendientes.filter(p => {
                return buses.some(bus => bus.id === p.bus_id);
            });

            localStorage.setItem('flota_pendientes', JSON.stringify(validPendientes));
        }

        function loadMachineReports() {
            try {
                const savedReports = localStorage.getItem('flota_machine_reports');
                if (savedReports) {
                    machineReports = JSON.parse(savedReports);
                }
            } catch (e) {
                console.error('Error cargando reportes de m√°quinas:', e);
                machineReports = [];
            }

            renderMachineReports();
        }

        function saveMachineReports() {
            localStorage.setItem('flota_machine_reports', JSON.stringify(machineReports));
        }

        // === RENDERIZADO DE UI ===
        function renderKPIs() {
            const kpiTotal = $('#kpiTotal');
            const kpiInt = $('#kpiInt');
            const kpiExt = $('#kpiExt');
            const kpiPendientes = $('#kpiPendientes');

            if (!kpiTotal || !kpiInt || !kpiExt || !kpiPendientes) return;

            const todayStr = new Date().toISOString().slice(0, 10);
            const yesterdayStr = new Date(Date.now() - 86400000).toISOString().slice(0, 10);

            const today = logs.filter(l => (l.created_at || '').slice(0, 10) === todayStr);
            const yesterday = logs.filter(l => (l.created_at || '').slice(0, 10) === yesterdayStr);

            const todayTotal = today.length;
            const todayInt = today.filter(l => !!l.inside_cleaned).length;
            const todayExt = today.filter(l => !!l.outside_cleaned).length;

            const yesterdayTotal = yesterday.length;
            const yesterdayInt = yesterday.filter(l => !!l.inside_cleaned).length;
            const yesterdayExt = yesterday.filter(l => !!l.outside_cleaned).length;

            // Calcular cambios porcentuales
            const calculateChange = (current, previous) => {
                if (previous === 0) return current > 0 ? 100 : 0;
                return Math.round(((current - previous) / previous) * 100);
            };

            const totalChange = calculateChange(todayTotal, yesterdayTotal);
            const intChange = calculateChange(todayInt, yesterdayInt);
            const extChange = calculateChange(todayExt, yesterdayExt);

            // Actualizar valores
            kpiTotal.textContent = todayTotal;
            kpiInt.textContent = todayInt;
            kpiExt.textContent = todayExt;
            kpiPendientes.textContent = pendientes.length;

            // Actualizar indicadores de cambio
            $('#kpiTotalChange').innerHTML = getChangeIndicator(totalChange, 'vs. ayer');
            $('#kpiIntChange').innerHTML = getChangeIndicator(intChange, 'vs. ayer');
            $('#kpiExtChange').innerHTML = getChangeIndicator(extChange, 'vs. ayer');
            $('#kpiPendientesChange').innerHTML = getChangeIndicator(-5, 'vs. ayer');

            // Funci√≥n para crear el indicador de cambio
            function getChangeIndicator(change, suffix) {
                const isPositive = change > 0;
                const isNegative = change < 0;
                const displayChange = Math.abs(change);
                
                let icon = '';
                let colorClass = '';
                
                if (isPositive) {
                    icon = '<i class="bi bi-arrow-up"></i>';
                    colorClass = 'text-success';
                } else if (isNegative) {
                    icon = '<i class="bi bi-arrow-down"></i>';
                    colorClass = 'text-danger';
                } else {
                    icon = '<i class="bi bi-dash"></i>';
                    colorClass = 'text-muted';
                }
                
                return `<span class="${colorClass}">${icon} ${displayChange}%</span> ${suffix}`;
            }

            // Renderizar gr√°ficos
            renderCharts();
        }

        function renderCharts() {
            // Progreso diario (comparaci√≥n interior vs exterior)
            const renderProgressChart = () => {
                const ctx = $('#progressChart');
                if (!ctx) return;
                if (charts.progress) charts.progress.destroy();

                const todayStr = new Date().toISOString().slice(0, 10);
                const today = logs.filter(l => (l.created_at || '').slice(0, 10) === todayStr);

                // Preparar datos para gr√°fico
                const hours = [];
                for (let i = 0; i < 24; i++) {
                    hours.push(i < 10 ? `0${i}:00` : `${i}:00`);
                }

                const interiorData = new Array(24).fill(0);
                const exteriorData = new Array(24).fill(0);

                today.forEach(log => {
                    const hour = new Date(log.created_at).getHours();
                    if (log.inside_cleaned) interiorData[hour]++;
                    if (log.outside_cleaned) exteriorData[hour]++;
                });

                charts.progress = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: hours,
                        datasets: [
                            {
                                label: 'Interior',
                                data: interiorData,
                                borderColor: '#4f46e5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Exterior',
                                data: exteriorData,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: false
                            },
                            legend: {
                                position: 'bottom'
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            };

            // Gr√°fico por terminal
            const renderTerminalChart = () => {
                const ctx = $('#terminalChart');
                if (!ctx) return;
                if (charts.terminal) charts.terminal.destroy();

                const todayStr = new Date().toISOString().slice(0, 10);
                const today = logs.filter(l => (l.created_at || '').slice(0, 10) === todayStr);

                // Contar registros por terminal
                const terminals = {};
                today.forEach(log => {
                    if (log.gps_lat && log.gps_lng) {
                        const nearest = nearestTerminal(log.gps_lat, log.gps_lng);
                        terminals[nearest.nombre] = (terminals[nearest.nombre] || 0) + 1;
                    }
                });

                const labels = Object.keys(terminals);
                const data = Object.values(terminals);

                // Colores para cada terminal
                const colors = [
                    '#4f46e5', '#10b981', '#f59e0b', '#ef4444',
                    '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'
                ];

                charts.terminal = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12
                                }
                            }
                        }
                    }
                });
            };

            // Gr√°fico de distribuci√≥n de tareas
            const renderDistributionChart = () => {
                const ctx = $('#distributionChart');
                if (!ctx) return;
                if (charts.distribution) charts.distribution.destroy();

                const byTask = TASKS.map(t => ({
                    name: t.label,
                    count: logs.filter(l => l.task_type === t.code).length
                }));

                charts.distribution = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: byTask.map(x => x.name),
                        datasets: [{
                            label: 'Cantidad',
                            data: byTask.map(x => x.count),
                            borderRadius: 6,
                            backgroundColor: '#818cf8'
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            };

            // Gr√°ficos para la p√°gina de reportes
            const renderReportCharts = () => {
                // Cumplimiento Mensual
                const renderMonthlyChart = () => {
                    const ctx = $('#monthlyChart');
                    if (!ctx) return;
                    if (charts.monthly) charts.monthly.destroy();

                    // Obtener los √∫ltimos 30 d√≠as
                    const days = [];
                    const interiorData = [];
                    const exteriorData = [];
                    const targetLine = [];

                    for (let i = 29; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().slice(0, 10);
                        const dayLogs = logs.filter(l => (l.created_at || '').slice(0, 10) === dateStr);

                        days.push(date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }));
                        interiorData.push(dayLogs.filter(l => l.inside_cleaned).length);
                        exteriorData.push(dayLogs.filter(l => l.outside_cleaned).length);
                        targetLine.push(15); // Meta diaria ejemplo
                    }

                    charts.monthly = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: days,
                            datasets: [
                                {
                                    label: 'Interior',
                                    data: interiorData,
                                    backgroundColor: '#4f46e5',
                                    barPercentage: 0.6,
                                    categoryPercentage: 0.8
                                },
                                {
                                    label: 'Exterior',
                                    data: exteriorData,
                                    backgroundColor: '#10b981',
                                    barPercentage: 0.6,
                                    categoryPercentage: 0.8
                                },
                                {
                                    label: 'Meta',
                                    data: targetLine,
                                    type: 'line',
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    pointStyle: false,
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                },
                                title: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    stacked: true,
                                    grid: {
                                        display: false
                                    }
                                },
                                y: {
                                    stacked: false,
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                };

                // Distribuci√≥n por Tipo
                const renderTaskTypeChart = () => {
                    const ctx = $('#taskTypeChart');
                    if (!ctx) return;
                    if (charts.taskType) charts.taskType.destroy();

                    // Contar por tipo de tarea
                    const taskCounts = {};
                    TASKS.forEach(task => {
                        taskCounts[task.label] = logs.filter(l => l.task_type === task.code).length;
                    });

                    const labels = Object.keys(taskCounts);
                    const data = Object.values(taskCounts);

                    charts.taskType = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: [
                                    '#4f46e5',
                                    '#10b981',
                                    '#f59e0b',
                                    '#ef4444'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                };

                // Rendimiento por Terminal
                const renderTerminalPerformanceChart = () => {
                    const ctx = $('#terminalPerformanceChart');
                    if (!ctx) return;
                    if (charts.terminalPerformance) charts.terminalPerformance.destroy();

                    // Datos agrupados por terminal
                    const terminalData = {};
                    TERMINALES.forEach(terminal => {
                        terminalData[terminal.nombre] = {
                            interior: 0,
                            exterior: 0,
                            total: 0
                        };
                    });

                    logs.forEach(log => {
                        if (log.gps_lat && log.gps_lng) {
                            const nearest = nearestTerminal(log.gps_lat, log.gps_lng);
                            terminalData[nearest.nombre].total++;
                            if (log.inside_cleaned) terminalData[nearest.nombre].interior++;
                            if (log.outside_cleaned) terminalData[nearest.nombre].exterior++;
                        }
                    });

                    const labels = Object.keys(terminalData);
                    const interiorData = labels.map(label => terminalData[label].interior);
                    const exteriorData = labels.map(label => terminalData[label].exterior);

                    charts.terminalPerformance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Interior',
                                    data: interiorData,
                                    backgroundColor: '#4f46e5'
                                },
                                {
                                    label: 'Exterior',
                                    data: exteriorData,
                                    backgroundColor: '#10b981'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: false
                                    }
                                },
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                };

                // Tiempo Fuera de M√°quinas
                const renderMachineDowntimeChart = () => {
                    const ctx = $('#machineDowntimeChart');
                    if (!ctx) return;
                    if (charts.machineDowntime) charts.machineDowntime.destroy();

                    // Obtener datos de reportes de m√°quinas
                    const machineTypes = ['RODILLO', 'ASPIRADORA', 'HIDROLAVADORA', 'OTRA'];
                    const downtimeDays = machineTypes.map(type => {
                        const reports = machineReports.filter(r => r.type === type);
                        let totalDays = 0;

                        reports.forEach(report => {
                            if (report.resolved) {
                                const start = new Date(report.created_at);
                                const end = new Date(report.resolved_at);
                                const diffTime = Math.abs(end - start);
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                totalDays += diffDays;
                            } else {
                                const start = new Date(report.created_at);
                                const end = new Date();
                                const diffTime = Math.abs(end - start);
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                totalDays += diffDays;
                            }
                        });

                        return totalDays;
                    });

                    charts.machineDowntime = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Rodillos', 'Aspiradoras', 'Hidrolavadoras', 'Otras'],
                            datasets: [{
                                label: 'D√≠as fuera de servicio',
                                data: downtimeDays,
                                backgroundColor: '#ef4444',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'D√≠as'
                                    }
                                }
                            }
                        }
                    });
                };

                // Llamar a todas las funciones de gr√°ficos de reportes
                renderMonthlyChart();
                renderTaskTypeChart();
                renderTerminalPerformanceChart();
                renderMachineDowntimeChart();
            };

            // Ejecutar gr√°ficos
            renderProgressChart();
            renderTerminalChart();
            renderDistributionChart();

            // Verificar si estamos en la p√°gina de reportes
            if ($('#monthlyChart')) {
                renderReportCharts();
            }
        }

        function renderFeed() {
            const feedContainers = [
                { id: 'recent-feed', limit: 5 },
                { id: 'registro-recent-feed', limit: 5 },
                { id: 'history-feed', limit: 1000 }
            ];

            // Si no hay registros, mostrar mensaje
            if (!logs || logs.length === 0) {
                feedContainers.forEach(({ id }) => {
                    const container = $(`#${id}`);
                    if (container) {
                        container.innerHTML = '<div class="feed-item"><div class="text-center text-muted p-3">No hay registros disponibles</div></div>';
                    }
                });
                return;
            }

            try {
                // Ordenar registros por fecha (m√°s recientes primero)
                const data = [...logs].sort((a, b) => {
                    const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
                    const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
                    return dateB - dateA;
                });

                // Actualizar cada feed
                feedContainers.forEach(({ id, limit }) => {
                    const container = $(`#${id}`);
                    if (!container) return;

                    container.innerHTML = '';
                    const frag = document.createDocumentFragment();

                    for (const l of data.slice(0, limit)) {
                        const row = document.createElement('div');
                        row.className = 'feed-item';
                        row.dataset.id = l.id;
                        row.addEventListener('click', () => showLogDetails(l.id));

                        const taskInfo = TASKS.find(t => t.code === l.task_type) || { icon: 'bi-check-circle', label: l.task_type };
                        let dateString = 'Fecha desconocida';

                        try {
                            dateString = formatRelativeTime(l.created_at);
                        } catch (e) {
                            console.warn("Error formateando fecha:", l.created_at);
                        }

                        row.innerHTML = `
                            <div class="feed-content">
                                <div class="feed-title">
                                    <i class="bi ${taskInfo.icon}"></i> ${l.plate || 'Bus sin placa'}
                                </div>
                                <div class="feed-subtitle">
                                    ${dateString} 
                                    ${l.gps_lat && l.gps_lng ? `| ${nearestTerminal(l.gps_lat, l.gps_lng).nombre}` : ''}
                                </div>
                                <div class="feed-badges">
                                    ${l.inside_cleaned ? '<span class="badge badge-primary"><i class="bi bi-broom"></i> Interior</span>' : ''}
                                    ${l.outside_cleaned ? '<span class="badge badge-success"><i class="bi bi-water"></i> Exterior</span>' : ''}
                                </div>
                            </div>
                            <div class="feed-actions">
                                <button class="btn btn-sm btn-outline">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        `;

                        frag.appendChild(row);
                    }

                    container.appendChild(frag);
                });
            } catch (error) {
                console.error("Error en renderFeed:", error);
                feedContainers.forEach(({ id }) => {
                    const container = $(`#${id}`);
                    if (container) {
                        container.innerHTML = `<div class="feed-item"><div class="text-center text-muted p-3">Error al mostrar registros: ${error.message}</div></div>`;
                    }
                });
            }
        }

        function renderPendientes() {
            // Contenedores principales
            const pendingBusesContainer = $('#pending-buses-container');
            const interiorPendingList = $('#interior-pending-list');
            const exteriorPendingList = $('#exterior-pending-list');
            const fleetStatusGrid = $('#fleet-status-grid');
            
            // Contadores
            const pendingCount = $('#pending-count');
            const interiorPendingCount = $('#interior-pending-count');
            const exteriorPendingCount = $('#exterior-pending-count');
            
            // Filtrar por tipo
            const interiorPendings = pendientes.filter(p => {
                const task = TASKS.find(t => t.code === p.task);
                return task && task.interior;
            });
            
            const exteriorPendings = pendientes.filter(p => {
                const task = TASKS.find(t => t.code === p.task);
                return task && task.exterior;
            });
            
            // Actualizar contadores
            if (pendingCount) pendingCount.textContent = pendientes.length;
            if (interiorPendingCount) interiorPendingCount.textContent = interiorPendings.length;
            if (exteriorPendingCount) exteriorPendingCount.textContent = exteriorPendings.length;
            
            // Renderizar tarjetas de pendientes en dashboard
            if (pendingBusesContainer) {
                pendingBusesContainer.innerHTML = '';
                
                if (pendientes.length === 0) {
                    pendingBusesContainer.innerHTML = '<div class="text-center text-muted p-3">No hay tareas pendientes</div>';
                } else {
                    // Agrupar pendientes por bus
                    const busPendings = {};
                    
                    pendientes.forEach(p => {
                        if (!busPendings[p.bus_id]) {
                            busPendings[p.bus_id] = {
                                bus_id: p.bus_id,
                                plate: p.plate,
                                terminal: p.terminal,
                                created_at: p.created_at,
                                interior: false,
                                exterior: false
                            };
                        }
                        
                        // Marcar tipo de pendiente
                        const task = TASKS.find(t => t.code === p.task);
                        if (task) {
                            if (task.interior) busPendings[p.bus_id].interior = true;
                            if (task.exterior) busPendings[p.bus_id].exterior = true;
                        }
                    });
                    
                    // Convertir a array y ordenar por placa
                    const pendingArray = Object.values(busPendings).sort((a, b) => a.plate.localeCompare(b.plate));
                    
                    // Mostrar hasta 8 buses pendientes
                    pendingArray.slice(0, 8).forEach(bus => {
                        const card = document.createElement('div');
                        card.className = 'pending-card';
                        card.dataset.id = bus.bus_id;
                        card.addEventListener('click', () => showBusDetails(bus.bus_id));
                        
                        card.innerHTML = `
                            <div class="pending-header">
                                <span>${bus.plate}</span>
                                <span class="badge badge-warning">Pendiente</span>
                            </div>
                            <div class="pending-content">
                                <div class="text-sm text-muted mb-2">Terminal: ${bus.terminal || 'Desconocido'}</div>
                                <div class="pending-status">
                                    <div class="status-indicator ${bus.interior ? 'pending' : 'completed'}">
                                        <div class="status-label">Interior</div>
                                        <div class="status-value">${bus.interior ? 'Pendiente' : 'OK'}</div>
                                    </div>
                                    <div class="status-indicator ${bus.exterior ? 'pending' : 'completed'}">
                                        <div class="status-label">Exterior</div>
                                        <div class="status-value">${bus.exterior ? 'Pendiente' : 'OK'}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="pending-footer">
                                <span>Desde: ${formatShortDate(bus.created_at)}</span>
                                <span><i class="bi bi-arrow-right text-primary"></i></span>
                            </div>
                        `;
                        
                        pendingBusesContainer.appendChild(card);
                    });
                    
                    // Si hay m√°s pendientes de los que mostramos
                    if (pendingArray.length > 8) {
                        const moreLink = document.createElement('div');
                        moreLink.className = 'text-center mt-2';
                        moreLink.innerHTML = `<a href="#pendientes" class="text-primary">Ver ${pendingArray.length - 8} m√°s...</a>`;
                        pendingBusesContainer.appendChild(moreLink);
                    }
                }
            }
            
            // Renderizar listados de pendientes interior/exterior
            if (interiorPendingList) {
                interiorPendingList.innerHTML = '';
                
                if (interiorPendings.length === 0) {
                    interiorPendingList.innerHTML = '<div class="text-center text-muted p-3">No hay pendientes de interior</div>';
                } else {
                    interiorPendings.forEach(p => {
                        const item = document.createElement('div');
                        item.className = 'pending-list-item';
                        item.dataset.id = p.id;
                        item.dataset.busId = p.bus_id;
                        item.addEventListener('click', () => showBusDetails(p.bus_id));
                        
                        item.innerHTML = `
                            <div class="pending-list-plate">${p.plate}</div>
                            <div class="pending-list-terminal">${p.terminal || 'Sin terminal'}</div>
                            <div class="pending-list-date">${formatShortDate(p.created_at)}</div>
                        `;
                        
                        interiorPendingList.appendChild(item);
                    });
                }
            }
            
            if (exteriorPendingList) {
                exteriorPendingList.innerHTML = '';
                
                if (exteriorPendings.length === 0) {
                    exteriorPendingList.innerHTML = '<div class="text-center text-muted p-3">No hay pendientes de exterior</div>';
                } else {
                    exteriorPendings.forEach(p => {
                        const item = document.createElement('div');
                        item.className = 'pending-list-item';
                        item.dataset.id = p.id;
                        item.dataset.busId = p.bus_id;
                        item.addEventListener('click', () => showBusDetails(p.bus_id));
                        
                        item.innerHTML = `
                            <div class="pending-list-plate">${p.plate}</div>
                            <div class="pending-list-terminal">${p.terminal || 'Sin terminal'}</div>
                            <div class="pending-list-date">${formatShortDate(p.created_at)}</div>
                        `;
                        
                        exteriorPendingList.appendChild(item);
                    });
                }
            }
            
            // Renderizar grid de flota completa
            renderFleetStatus();
        }

        function renderFleetStatus() {
            const fleetStatusGrid = $('#fleet-status-grid');
            if (!fleetStatusGrid) return;
            
            fleetStatusGrid.innerHTML = '';
            
            if (!buses || buses.length === 0) {
                fleetStatusGrid.innerHTML = '<div class="text-center text-muted p-3">No hay informaci√≥n de buses disponible</div>';
                return;
            }
            
            // Para cada bus, determinar su estado
            buses.forEach(bus => {
                // Verificar pendientes
                const hasPendingInterior = pendientes.some(p => {
                    const task = TASKS.find(t => t.code === p.task);
                    return p.bus_id === bus.id && task && task.interior;
                });
                
                const hasPendingExterior = pendientes.some(p => {
                    const task = TASKS.find(t => t.code === p.task);
                    return p.bus_id === bus.id && task && task.exterior;
                });
                
                // √öltimos registros
                const busLogs = logs.filter(l => l.bus_id === bus.id)
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                const lastInterior = busLogs.find(l => l.inside_cleaned);
                const lastExterior = busLogs.find(l => l.outside_cleaned);
                
                // Crear tarjeta de bus
                const card = document.createElement('div');
                card.className = 'pending-card';
                card.dataset.id = bus.id;
                card.addEventListener('click', () => showBusDetails(bus.id));
                
                card.innerHTML = `
                    <div class="pending-header">
                        <span>${bus.plate}</span>
                        ${hasPendingInterior || hasPendingExterior ? 
                            '<span class="badge badge-warning">Pendiente</span>' : 
                            '<span class="badge badge-success">Al d√≠a</span>'}
                    </div>
                    <div class="pending-content">
                        <div class="text-sm text-muted mb-2">Terminal: ${bus.terminal || 'Desconocido'}</div>
                        <div class="pending-status">
                            <div class="status-indicator ${hasPendingInterior ? 'pending' : 'completed'}">
                                <div class="status-label">Interior</div>
                                <div class="status-value">${hasPendingInterior ? 'Pendiente' : 'OK'}</div>
                            </div>
                            <div class="status-indicator ${hasPendingExterior ? 'pending' : 'completed'}">
                                <div class="status-label">Exterior</div>
                                <div class="status-value">${hasPendingExterior ? 'Pendiente' : 'OK'}</div>
                            </div>
                        </div>
                    </div>
                    <div class="pending-footer">
                        <span>√öltimo: ${lastInterior || lastExterior ? formatShortDate((lastInterior || lastExterior).created_at) : 'Nunca'}</span>
                        <span><i class="bi bi-arrow-right text-primary"></i></span>
                    </div>
                `;
                
                fleetStatusGrid.appendChild(card);
            });
        }

        function renderMachineReports() {
            const containers = [
                $('#machine-reports-list'),
                $('#machine-status-container')
            ];

            containers.forEach(container => {
                if (!container) return;

                container.innerHTML = '';

                if (machineReports.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted p-3">No hay reportes de m√°quinas</div>';
                    return;
                }

                // Ordenar por fecha (m√°s recientes primero)
                const sorted = [...machineReports].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                // Limitar a 5 elementos para el status-container
                const limited = container.id === 'machine-status-container' ? sorted.slice(0, 5) : sorted;

                limited.forEach(report => {
                    const item = document.createElement('div');
                    item.className = 'feed-item';
                    item.dataset.id = report.id;

                    const reportDate = formatShortDate(report.created_at);
                    const resolvedDate = report.resolved ? formatShortDate(report.resolved_at) : 'Pendiente';

                    item.innerHTML = `
                        <div class="feed-content">
                            <div class="feed-title">
                                <i class="bi bi-tools"></i> ${report.terminal} - ${report.type.replaceAll('_', ' ')}
                            </div>
                            <div class="feed-subtitle">
                                Reporte: ${reportDate} | Resoluci√≥n: ${resolvedDate}
                            </div>
                            <div class="feed-badges">
                                <span class="badge ${report.resolved ? 'badge-success' : 'badge-warning'}">
                                    ${report.resolved ? 'Resuelto' : 'Pendiente'}
                                </span>
                            </div>
                        </div>
                        <div class="feed-actions">
                            ${!report.resolved ? `
                                <button class="btn btn-sm btn-success" onclick="resolveMachine('${report.id}', event)">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-outline" onclick="viewMachineDetails('${report.id}', event)">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    `;

                    container.appendChild(item);
                });
            });
        }

        function renderNotifications() {
            const container = $('#notification-list');
            if (!container) return;

            container.innerHTML = '';

            if (notifications.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-4">No hay notificaciones</div>';
                return;
            }

            notifications.forEach(notification => {
                const item = document.createElement('div');
                item.className = `notification-item${notification.read ? '' : ' unread'}`;

                item.innerHTML = `
                    <div class="notification-item-title">${notification.title}</div>
                    <div class="notification-item-time">${formatDate(notification.time)}</div>
                    <div class="notification-item-content">${notification.content}</div>
                `;

                item.addEventListener('click', () => {
                    notification.read = true;
                    item.classList.remove('unread');
                    updateNotificationBadge();
                });

                container.appendChild(item);
            });
        }

        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = $('#notification-badge');

            if (!badge) return;

            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // === FUNCIONALIDAD DE PENDIENTES ===
        function generatePendientes() {
            // Solo generar pendientes si hay buses y logs reales
            if (!buses.length || !logs.length) {
                return;
            }

            // Limpiar pendientes ficticios primero
            pendientes = pendientes.filter(p => {
                // Verificar que el bus existe realmente
                return buses.some(bus => bus.id === p.bus_id);
            });

            // Ahora generar nuevos pendientes basados en datos reales
            const now = new Date();
            const threeDaysAgo = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000);
            let newPendientes = [];

            buses.forEach(bus => {
                // Verificar si ya existe un pendiente para este bus
                const existingExterior = pendientes.some(p =>
                    p.bus_id === bus.id && p.task === 'LAVADO_RODILLO'
                );

                const existingInterior = pendientes.some(p =>
                    p.bus_id === bus.id &&
                    (p.task === 'BARRIDO' || p.task === 'BARRIDO_Y_MOPEO')
                );

                // Solo crear pendientes si no existen ya
                if (!existingExterior) {
                    // Buscar √∫ltima limpieza exterior
                    const lastExterior = logs.find(l =>
                        l.bus_id === bus.id &&
                        l.outside_cleaned &&
                        new Date(l.created_at) > threeDaysAgo
                    );

                    // Si no hay limpieza exterior reciente, crear pendiente
                    if (!lastExterior) {
                        newPendientes.push({
                            id: `pending-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
                            bus_id: bus.id,
                            plate: bus.plate,
                            task: 'LAVADO_RODILLO',
                            created_at: new Date().toISOString(),
                            terminal: bus.terminal,
                            reason: 'Sin lavado exterior en 3+ d√≠as'
                        });
                    }
                }

                if (!existingInterior) {
                    // Buscar √∫ltima limpieza interior
                    const lastInterior = logs.find(l =>
                        l.bus_id === bus.id &&
                        l.inside_cleaned &&
                        new Date(l.created_at) > threeDaysAgo
                    );

                    // Si no hay limpieza interior reciente, crear pendiente
                    if (!lastInterior) {
                        newPendientes.push({
                            id: `pending-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
                            bus_id: bus.id,
                            plate: bus.plate,
                            task: 'BARRIDO_Y_MOPEO',
                            created_at: new Date().toISOString(),
                            terminal: bus.terminal,
                            reason: 'Sin limpieza interior en 3+ d√≠as'
                        });
                    }
                }
            });

            // Agregar los nuevos pendientes
            pendientes = [...pendientes, ...newPendientes];
            savePendientes();
            renderPendientes();
            
            if (newPendientes.length > 0) {
                showToast(`Se detectaron ${newPendientes.length} nuevos pendientes`, "info");
            }
        }

     
        // Funci√≥n mejorada para mostrar detalles del registro con correcci√≥n de im√°genes
function showLogDetails(logId) {
    const log = logs.find(l => String(l.id) === String(logId));
    if (!log) {
        showToast("Registro no encontrado", "error");
        return;
    }

    const modalContent = $('#log-detail-content');
    if (!modalContent) return;

    const task = TASKS.find(t => t.code === log.task_type) || { label: log.task_type.replaceAll('_', ' '), icon: 'bi-check-circle' };
    
    // Crear contenido del modal
    modalContent.innerHTML = `
        <div class="text-center mb-3">
            <h3 class="text-xl font-bold">${log.plate || 'Sin placa'}</h3>
            <div class="text-sm text-muted mb-2">${formatDate(log.created_at)}</div>
        </div>
        
        <div class="d-flex flex-column gap-3 mb-3">
            <div class="border rounded p-3">
                <div class="text-sm text-muted mb-1">Tarea</div>
                <div class="font-semibold d-flex align-items-center gap-2">
                    <i class="bi ${task.icon}"></i> ${task.label}
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <div class="border rounded p-3 flex-grow-1">
                    <div class="text-sm text-muted mb-1">Interior</div>
                    <div class="font-semibold ${log.inside_cleaned ? 'text-success' : 'text-danger'}">
                        ${log.inside_cleaned ? 'Limpiado' : 'No realizado'}
                    </div>
                </div>
                
                <div class="border rounded p-3 flex-grow-1">
                    <div class="text-sm text-muted mb-1">Exterior</div>
                    <div class="font-semibold ${log.outside_cleaned ? 'text-success' : 'text-danger'}">
                        ${log.outside_cleaned ? 'Limpiado' : 'No realizado'}
                    </div>
                </div>
            </div>
        </div>
        
        ${log.gps_lat && log.gps_lng ? `
            <div class="border rounded p-3 mb-3">
                <div class="text-sm text-muted mb-1">Ubicaci√≥n</div>
                <div>Terminal: ${nearestTerminal(log.gps_lat, log.gps_lng).nombre}</div>
                <div class="text-sm text-muted">Coordenadas: ${log.gps_lat.toFixed(6)}, ${log.gps_lng.toFixed(6)}</div>
            </div>
        ` : ''}
        
        ${log.user_name ? `
            <div class="border rounded p-3 mb-3">
                <div class="text-sm text-muted mb-1">Registrado por</div>
                <div>${log.user_name}</div>
            </div>
        ` : ''}
    `;

    // Manejo mejorado de fotos
    if (log.photos && log.photos.length > 0) {
        const photosContainer = document.createElement('div');
        photosContainer.className = 'mt-3';
        
        photosContainer.innerHTML = `
            <div class="text-sm text-muted mb-2">Fotos (${log.photos.length})</div>
            <div class="photo-grid" id="photos-grid-${log.id}"></div>
        `;
        
        modalContent.appendChild(photosContainer);
        
        const photosGrid = $(`#photos-grid-${log.id}`);
        
        // Procesar cada foto
        log.photos.forEach((photo, index) => {
            const photoUrl = getPhotoUrl(photo);
            
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            photoItem.onclick = () => showLightbox(photoUrl);
            
            // Crear una imagen con manejo de errores
            const img = document.createElement('img');
            img.className = 'photo-img';
            img.alt = `Foto ${index + 1}`;
            
            // Manejar errores de carga
            img.onerror = function() {
                this.onerror = null; // Evitar bucles infinitos
                this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InN5c3RlbS11aSwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMnB4IiBmaWxsPSIjOTk5Ij5JbWFnZW4gbm8gZGlzcG9uaWJsZTwvdGV4dD48L3N2Zz4=';
                this.style.backgroundColor = '#f3f4f6';
            };
            
            // Establecer la fuente de la imagen
            img.src = photoUrl;
            
            photoItem.appendChild(img);
            photosGrid.appendChild(photoItem);
        });
    } else {
        const noPhotosMsg = document.createElement('div');
        noPhotosMsg.className = 'text-center text-muted p-3 mt-3';
        noPhotosMsg.textContent = 'No hay fotos disponibles';
        modalContent.appendChild(noPhotosMsg);
    }

    // Mostrar el modal
    const modal = $('#log-detail-modal');
    modal.classList.add('active');
}

// Funci√≥n auxiliar para obtener la URL correcta de la foto
function getPhotoUrl(photo) {
    // Si es un objeto con la propiedad url, usar esa
    if (photo && typeof photo === 'object' && photo.url) {
        return photo.url;
    }
    
    // Si es un string (path del storage)
    if (typeof photo === 'string') {
        // Si ya es una URL completa
        if (photo.startsWith('http://') || photo.startsWith('https://') || photo.startsWith('data:')) {
            return photo;
        }
        
        // Si es una ruta de Supabase Storage
        if (sb) {
            try {
                // Construir URL p√∫blica de Supabase Storage
                return sb.storage.from('cleaning-photos').getPublicUrl(photo).data.publicUrl;
            } catch (err) {
                console.error('Error obteniendo URL p√∫blica:', err);
            }
        }
    }
    
    // Imagen por defecto si no se pudo obtener la URL
    return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InN5c3RlbS11aSwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMnB4IiBmaWxsPSIjOTk5Ij5JbWFnZW4gbm8gZGlzcG9uaWJsZTwvdGV4dD48L3N2Zz4=';
}

// Funci√≥n mejorada para mostrar lightbox con imagen ampliada
function showLightbox(imageUrl) {
    const lightbox = $('#lightbox');
    const img = $('#lightbox-img');

    if (!lightbox || !img) return;

    // Mostrar un indicador de carga mientras se carga la imagen
    img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InN5c3RlbS11aSwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMnB4IiBmaWxsPSIjZmZmIj5DYXJnYW5kby4uLjwvdGV4dD48L3N2Zz4=';
    
    // Manejar errores de carga
    img.onerror = function() {
        this.onerror = null;
        this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InN5c3RlbS11aSwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNXB4IiBmaWxsPSIjZmZmIj5FcnJvciBhbCBjYXJnYXIgbGEgaW1hZ2VuPC90ZXh0Pjwvc3ZnPg==';
    };
    
    // Establecer la fuente real de la imagen
    img.src = imageUrl;
    
    // Mostrar el lightbox
    lightbox.classList.add('visible');
}

// C√≥digo adicional para ser agregado en loadLogs()
// Modificar la parte donde se procesan las fotos en el array de logs
async function loadLogs() {
    try {
        showToast("Cargando registros...", "info");

        if (sb) {
            console.log("Consultando registros desde Supabase...");

            // Consulta a la tabla cleaning_logs
            const { data, error } = await sb.from('cleaning_logs')
                .select('id, created_at, bus_id, task_type, gps_lat, gps_lng, photos, inside_cleaned, outside_cleaned, user_name, device_id')
                .order('created_at', { ascending: false })
                .limit(1000);

            if (error) {
                console.error("Error en consulta:", error);
                throw error;
            }

            console.log("Registros obtenidos:", data?.length || 0);

            if (data && data.length > 0) {
                // Transformar datos para incluir la placa del bus y procesar fotos
                logs = await Promise.all(data.map(async (log) => {
                    // Buscar informaci√≥n del bus
                    let busPlate = 'Sin placa';
                    try {
                        // Obtener la placa directamente para cada bus
                        const { data: busData } = await sb.from('buses')
                            .select('ppu')
                            .eq('id', log.bus_id)
                            .single();

                        if (busData) {
                            busPlate = busData.ppu;
                        }
                    } catch (e) {
                        console.warn("No se pudo obtener placa para bus ID:", log.bus_id);
                    }

                    // Procesar fotos para obtener URLs p√∫blicas
                    let processedPhotos = [];
                    if (log.photos && Array.isArray(log.photos)) {
                        // Si son rutas de Supabase Storage, obtener URLs p√∫blicas
                        processedPhotos = log.photos.map(photo => {
                            // Si ya es un objeto con url
                            if (typeof photo === 'object' && photo.url) {
                                return photo;
                            }
                            
                            // Si es string (path)
                            if (typeof photo === 'string') {
                                try {
                                    const publicUrl = sb.storage.from('cleaning-photos').getPublicUrl(photo).data.publicUrl;
                                    return {
                                        path: photo,
                                        url: publicUrl
                                    };
                                } catch (err) {
                                    console.error('Error procesando foto:', photo, err);
                                    return {
                                        path: photo,
                                        url: null
                                    };
                                }
                            }
                            
                            return photo; // Si es otro formato, mantenerlo igual
                        });
                    }

                    return {
                        id: log.id,
                        created_at: log.created_at,
                        bus_id: log.bus_id,
                        plate: busPlate,
                        task_type: log.task_type,
                        gps_lat: log.gps_lat,
                        gps_lng: log.gps_lng,
                        photos: processedPhotos,
                        inside_cleaned: log.inside_cleaned,
                        outside_cleaned: log.outside_cleaned,
                        user_name: log.user_name || 'Usuario',
                        device_id: log.device_id
                    };
                }));

                showToast(`Se cargaron ${logs.length} registros`, "success");
            } else {
                logs = [];
                showToast("No se encontraron registros", "info");
            }
        } else {
            logs = []; // Sin datos si no hay conexi√≥n
            showToast("No hay conexi√≥n a la base de datos", "warning");
        }

        // Actualizar UI despu√©s de cargar los datos
        console.log("Actualizando UI con", logs.length, "registros");
        renderFeed();
        renderFleetStatus();
        generatePendientes();

        if (clusterLayer) refreshMarkers();
        renderKPIs();

    } catch (error) {
        console.error('Error cargando registros:', error);
        showToast('Error cargando registros: ' + error.message, 'error');
        logs = [];

        // Intentar mostrar UI incluso con error
        renderFeed();
    }
}

// C√≥digo para el formulario de registro - Modificar la parte donde se suben fotos
// Este fragmento va dentro del evento submit del formLog
/*
// Procesar im√°genes
const files = $('#files').files;
const uploadedImages = [];

// Subir fotos a Supabase Storage (en producci√≥n)
if (sb && files.length > 0) {
    for (const file of files) {
        try {
            const fileExt = file.name.split('.').pop();
            const filePath = `${logId}/${Date.now()}-${Math.random().toString(36).slice(2)}.${fileExt}`;
            
            // Subir el archivo a Supabase Storage
            const { data: uploadData, error: uploadError } = await sb.storage
                .from('cleaning-photos')
                .upload(filePath, file, { upsert: false });
                
            if (uploadError) throw uploadError;
            
            // Obtener URL p√∫blica
            const { data: urlData } = sb.storage
                .from('cleaning-photos')
                .getPublicUrl(filePath);
                
            uploadedImages.push({
                path: filePath,
                url: urlData.publicUrl
            });
        } catch (uploadErr) {
            console.error('Error subiendo foto:', uploadErr);
            // Crear una URL temporal para la interfaz (aunque no se haya subido)
            uploadedImages.push({
                path: null,
                url: URL.createObjectURL(file)
            });
        }
    }
} else {
    // En modo sin conexi√≥n, usar URLs temporales
    for (const file of files) {
        uploadedImages.push({
            path: null,
            url: URL.createObjectURL(file)
        });
    }
}
*/


        function showBusDetails(busId) {
            const bus = buses.find(b => String(b.id) === String(busId));
            if (!bus) {
                showToast("Bus no encontrado", "error");
                return;
            }

            // Guardar bus seleccionado para usarlo en el bot√≥n de registrar limpieza
            selectedBusId = bus.id;

            // Obtener todos los registros de este bus
            const busLogs = logs.filter(l => l.bus_id === bus.id)
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // Obtener pendientes de este bus
            const busPendings = pendientes.filter(p => p.bus_id === bus.id);
            
            // Determinar estado de limpieza
            const lastInterior = busLogs.find(l => l.inside_cleaned);
            const lastExterior = busLogs.find(l => l.outside_cleaned);
            
            const hasPendingInterior = busPendings.some(p => {
                const task = TASKS.find(t => t.code === p.task);
                return task && task.interior;
            });
            
            const hasPendingExterior = busPendings.some(p => {
                const task = TASKS.find(t => t.code === p.task);
                return task && task.exterior;
            });

            const modalTitle = $('#bus-detail-title');
            const modalContent = $('#bus-detail-content');
            if (!modalTitle || !modalContent) return;

            // Actualizar t√≠tulo del modal
            modalTitle.textContent = `Detalles del Bus ${bus.plate}`;
            
            // Crear contenido del modal
            modalContent.innerHTML = `
                <div class="d-flex flex-column gap-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-sm text-muted">Terminal asignado</div>
                            <div class="font-semibold">${bus.terminal || 'No asignado'}</div>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="badge ${hasPendingInterior || hasPendingExterior ? 'badge-warning' : 'badge-success'} py-2 px-3">
                                ${hasPendingInterior || hasPendingExterior ? 'Pendiente' : 'Al d√≠a'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="border rounded">
                        <h4 class="p-3 border-bottom">Estado de Limpieza</h4>
                        <div class="d-flex">
                            <div class="flex-grow-1 p-3 border-end">
                                <div class="text-center mb-2">
                                    <i class="bi bi-broom" style="font-size: 1.5rem; color: var(--primary-600);"></i>
                                    <div class="font-semibold">Interior</div>
                                </div>
                                <div class="d-flex flex-column gap-2">
                                    <div class="text-sm text-muted">Estado:</div>
                                    <div class="status-badge ${hasPendingInterior ? 'pending' : 'completed'} text-center">
                                        ${hasPendingInterior ? 'Pendiente' : 'Completado'}
                                    </div>
                                    <div class="text-sm text-muted mt-1">√öltima limpieza:</div>
                                    <div class="text-sm">${lastInterior ? formatDate(lastInterior.created_at) : 'Nunca'}</div>
                                </div>
                            </div>
                            
                            <div class="flex-grow-1 p-3">
                                <div class="text-center mb-2">
                                    <i class="bi bi-water" style="font-size: 1.5rem; color: var(--accent-600);"></i>
                                    <div class="font-semibold">Exterior</div>
                                </div>
                                <div class="d-flex flex-column gap-2">
                                    <div class="text-sm text-muted">Estado:</div>
                                    <div class="status-badge ${hasPendingExterior ? 'pending' : 'completed'} text-center">
                                        ${hasPendingExterior ? 'Pendiente' : 'Completado'}
                                    </div>
                                    <div class="text-sm text-muted mt-1">√öltima limpieza:</div>
                                    <div class="text-sm">${lastExterior ? formatDate(lastExterior.created_at) : 'Nunca'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border rounded">
                        <h4 class="p-3 border-bottom">Historial de Limpieza</h4>
                        <div class="feed-container" style="max-height: 200px;">
                            ${busLogs.length > 0 ? busLogs.map(log => {
                                const task = TASKS.find(t => t.code === log.task_type) || { label: log.task_type.replaceAll('_', ' '), icon: 'bi-check-circle' };
                                return `
                                    <div class="feed-item" onclick="showLogDetails('${log.id}')">
                                        <div class="feed-content">
                                            <div class="feed-title">
                                                <i class="bi ${task.icon}"></i> ${task.label}
                                            </div>
                                            <div class="feed-subtitle">
                                                ${formatDate(log.created_at)}
                                            </div>
                                            <div class="feed-badges">
                                                ${log.inside_cleaned ? '<span class="badge badge-primary"><i class="bi bi-broom"></i> Interior</span>' : ''}
                                                ${log.outside_cleaned ? '<span class="badge badge-success"><i class="bi bi-water"></i> Exterior</span>' : ''}
                                            </div>
                                        </div>
                                        <div class="feed-actions">
                                            <button class="btn btn-sm btn-outline">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('') : '<div class="text-center text-muted p-3">No hay registros de limpieza para este bus</div>'}
                        </div>
                    </div>
                </div>
            `;

            // Mostrar el modal
            const modal = $('#bus-detail-modal');
            modal.classList.add('active');
        }

        function showLightbox(imageUrl) {
            const lightbox = $('#lightbox');
            const img = $('#lightbox-img');

            if (!lightbox || !img) return;

            img.src = imageUrl;
            lightbox.classList.add('visible');
        }

        // === FUNCIONES PRINCIPALES ===
        window.resetForm = function () {
            const form = $('#formLog');
            if (form) form.reset();
            
            const previews = $('#previews');
            if (previews) previews.innerHTML = '';
        };

        window.resetMachineForm = function () {
            const form = $('#formMachine');
            if (form) form.reset();
            
            const previews = $('#machinePhotoPreviews');
            if (previews) previews.innerHTML = '';
            
            // Establecer fecha actual
            const dateInput = $('#machineDate');
            if (dateInput) {
                dateInput.value = new Date().toISOString().slice(0, 16);
            }
            
            // Restaurar valor por defecto
            const estimateInput = $('#machineEstimate');
            if (estimateInput) {
                estimateInput.value = '3';
            }
        };

        window.showLogDetails = showLogDetails;
        window.showBusDetails = showBusDetails;
        window.showLightbox = showLightbox;

        window.resolveMachine = function (id, event) {
            if (event) event.stopPropagation();
            
            const report = machineReports.find(r => r.id === id);
            if (!report) return;

            // Marcar como resuelto
            report.resolved = true;
            report.resolved_at = new Date().toISOString();

            // Guardar cambios
            saveMachineReports();

            // Actualizar UI
            renderMachineReports();

            // Notificar
            showToast(`M√°quina en ${report.terminal} marcada como resuelta`, 'success');

            // Enviar notificaci√≥n
            showNotification(
                'M√°quina reparada',
                `La m√°quina ${report.type.replaceAll('_', ' ')} en ${report.terminal} ha sido reparada y est√° lista para su uso.`,
                'success'
            );
        };

        window.viewMachineDetails = function (id, event) {
            if (event) event.stopPropagation();
            
            const report = machineReports.find(r => r.id === id);
            if (!report) {
                showToast("Reporte no encontrado", "error");
                return;
            }

            // Aqu√≠ podr√≠as mostrar un modal con los detalles del reporte
            // Por ahora, mostraremos un alert simple
            alert(`
                M√°quina: ${report.type.replaceAll('_', ' ')}
                Terminal: ${report.terminal}
                Fecha de reporte: ${formatDate(report.created_at)}
                Estado: ${report.resolved ? 'Resuelto' : 'Pendiente'}
                ${report.resolved ? 'Fecha de resoluci√≥n: ' + formatDate(report.resolved_at) : ''}
                
                Descripci√≥n: ${report.description}
            `);
        };

        // === NOTIFICACIONES ===
        function showNotification(title, content, type = 'info') {
            // Agregar al panel de notificaciones
            const notification = {
                id: Date.now(),
                title,
                content,
                type,
                time: new Date(),
                read: false
            };

            notifications.unshift(notification);
            renderNotifications();

            // Mostrar toast si est√°n habilitadas
            if (userConfig.notificationsEnabled) {
                showToast(title, type);
            }

            // Actualizar badge
            updateNotificationBadge();

            // Si el navegador soporta notificaciones nativas y se ha dado permiso
            if ('Notification' in window && Notification.permission === 'granted' && userConfig.notificationsEnabled) {
                const notification = new Notification(title, {
                    body: content,
                    icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöç</text></svg>'
                });
            }
        }

        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
        }

        // === EVENTOS Y MANEJADORES ===
        function setupEvents() {
            // Subida de archivos
            const uploadTrigger = $('#upload-trigger');
            const fileInput = $('#files');
            if (uploadTrigger && fileInput) {
                uploadTrigger.addEventListener('click', () => fileInput.click());
            }
            
            const machineUploadTrigger = $('#machine-upload-trigger');
            const machineFileInput = $('#machinePhotos');
            if (machineUploadTrigger && machineFileInput) {
                machineUploadTrigger.addEventListener('click', () => machineFileInput.click());
            }
            
            // Previews de im√°genes
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    const previews = $('#previews');
                    if (!previews) return;
                    
                    previews.innerHTML = '';
                    
                    Array.from(e.target.files || []).forEach((f, index) => {
                        const item = document.createElement('div');
                        item.className = 'photo-item';
                        
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(f);
                        img.className = 'photo-img';
                        
                        const removeBtn = document.createElement('div');
                        removeBtn.className = 'photo-remove';
                        removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                        removeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            
                            // Crear un nuevo FileList sin este archivo
                            const dt = new DataTransfer();
                            const files = fileInput.files;
                            
                            for (let i = 0; i < files.length; i++) {
                                if (i !== index) dt.items.add(files[i]);
                            }
                            
                            fileInput.files = dt.files;
                            item.remove();
                        });
                        
                        item.appendChild(img);
                        item.appendChild(removeBtn);
                        previews.appendChild(item);
                    });
                });
            }
            
            if (machineFileInput) {
                machineFileInput.addEventListener('change', (e) => {
                    const previews = $('#machinePhotoPreviews');
                    if (!previews) return;
                    
                    previews.innerHTML = '';
                    
                    Array.from(e.target.files || []).forEach((f, index) => {
                        const item = document.createElement('div');
                        item.className = 'photo-item';
                        
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(f);
                        img.className = 'photo-img';
                        
                        const removeBtn = document.createElement('div');
                        removeBtn.className = 'photo-remove';
                        removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                        removeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            
                            // Crear un nuevo FileList sin este archivo
                            const dt = new DataTransfer();
                            const files = machineFileInput.files;
                            
                            for (let i = 0; i < files.length; i++) {
                                if (i !== index) dt.items.add(files[i]);
                            }
                            
                            machineFileInput.files = dt.files;
                            item.remove();
                        });
                        
                        item.appendChild(img);
                        item.appendChild(removeBtn);
                        previews.appendChild(item);
                    });
                });
            }
            
            // Formulario de registro
            const formLog = $('#formLog');
            if (formLog) {
                formLog.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const bus_id = $('#busSelect').value;
                    const task = $('#taskSelect').value;
                    
                    if (!bus_id || !task) {
                        showToast('Completa PPU y Tarea.', 'warning');
                        return;
                    }
                    
                    // Verificar coordenadas GPS
                    if (!gps.lat || !gps.lng) {
                        showToast('Esperando datos GPS. Por favor espere unos segundos.', 'warning');
                        return;
                    }
                    
                    const taskInfo = TASKS.find(t => t.code === task) || {};
                    const busDetails = buses.find(b => b.id === bus_id);
                    
                    // Deshabilitar bot√≥n durante env√≠o
                    const submitBtn = $('#submitBtn');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<div class="spinner"></div> Guardando...';
                    }
                    
                    try {
                        // ID √∫nico para el registro
                        const logId = `log-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
                        
                        // Procesar im√°genes
                        const files = $('#files').files;
                        const uploadedImages = [];
                        
                        // Simular subida de im√°genes (en producci√≥n usar√≠a Supabase Storage)
                        for (const file of files) {
                            const path = `${logId}/${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
                            // En producci√≥n: await sb.storage.from('cleaning-photos').upload(path, file)
                            
                            // Guardar URL temporal
                            uploadedImages.push({
                                path,
                                url: URL.createObjectURL(file)
                            });
                        }
                        
                        // Guardar registro en el estado local (en producci√≥n ir√≠a a Supabase)
                        const newLog = {
                            id: logId,
                            created_at: new Date().toISOString(),
                            bus_id,
                            plate: busDetails?.plate,
                            task_type: task,
                            gps_lat: gps.lat,
                            gps_lng: gps.lng,
                            photos: uploadedImages,
                            inside_cleaned: taskInfo.interior || false,
                            outside_cleaned: taskInfo.exterior || false,
                            user_id: deviceId,
                            user_name: userConfig.userName || 'Usuario'
                        };
                        
                        // Si supabase est√° configurado, guardar registro
                        if (sb) {
                            try {
                                const { data: ins, error: e1 } = await sb.from('cleaning_logs').insert({
                                    bus_id,
                                    task_type: task,
                                    gps_lat: gps.lat,
                                    gps_lng: gps.lng,
                                    inside_cleaned: taskInfo.interior || false,
                                    outside_cleaned: taskInfo.exterior || false,
                                    device_id: deviceId,
                                    user_name: userConfig.userName || 'Usuario'
                                }).select('id').single();
                                
                                if (e1) throw e1;
                                
                                // Subir fotos
                                const uploaded = [];
                                for (const f of files) {
                                    const ext = f.name.split('.').pop();
                                    const path = `${ins.id}/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
                                    const { error: eUp } = await sb.storage.from('cleaning-photos').upload(path, f, { upsert: false });
                                    if (eUp) throw eUp;
                                    uploaded.push(path);
                                }
                                
                                // Actualizar registro con fotos
                                if (uploaded.length) {
                                    const { error: e2 } = await sb.from('cleaning_logs').update({ photos: uploaded }).eq('id', ins.id);
                                    if (e2) throw e2;
                                }
                                
                                // Usar el ID real de Supabase
                                newLog.id = ins.id;
                            } catch (error) {
                                console.error('Error guardando en Supabase:', error);
                                throw error;
                            }
                        }
                        
                        // Agregar al estado local
                        logs.unshift(newLog);
                        
                        // Verificar si el bus ten√≠a pendientes de esta tarea y eliminarlos
                        if (taskInfo.interior) {
                            const pendientesInteriores = pendientes.filter(p => {
                                const task = TASKS.find(t => t.code === p.task);
                                return p.bus_id === bus_id && task && task.interior;
                            });
                            
                            pendientesInteriores.forEach(p => {
                                const index = pendientes.findIndex(pending => pending.id === p.id);
                                if (index !== -1) {
                                    pendientes.splice(index, 1);
                                }
                            });
                        }
                        
                        if (taskInfo.exterior) {
                            const pendientesExteriores = pendientes.filter(p => {
                                const task = TASKS.find(t => t.code === p.task);
                                return p.bus_id === bus_id && task && task.exterior;
                            });
                            
                            pendientesExteriores.forEach(p => {
                                const index = pendientes.findIndex(pending => pending.id === p.id);
                                if (index !== -1) {
                                    pendientes.splice(index, 1);
                                }
                            });
                        }
                        
                        // Guardar cambios en pendientes
                        savePendientes();
                        
                        // Actualizar UI
                        if (clusterLayer) refreshMarkers();
                        renderPendientes();
                        renderFleetStatus();
                        renderKPIs();
                        renderFeed();
                        
                        // Reiniciar formulario
                        formLog.reset();
                        $('#previews').innerHTML = '';
                        
                        // Mostrar notificaci√≥n
                        showToast(`Registro guardado para bus ${busDetails?.plate}`, 'success');
                        
                        // Enviar notificaci√≥n
                        showNotification(
                            'Registro completado',
                            `Se ha realizado el aseo de ${busDetails?.plate}: ${task.replaceAll('_', ' ')}`,
                            'success'
                        );
                    } catch (err) {
                        showToast(`Error al guardar: ${err?.message || err}`, 'error');
                    } finally {
                        // Reactivar bot√≥n
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="bi bi-save"></i> Guardar registro';
                        }
                    }
                });
            }
            
            // Formulario de reporte de m√°quina
            const formMachine = $('#formMachine');
            if (formMachine) {
                // Establecer fecha actual en el formulario
                const machineDateInput = $('#machineDate');
                if (machineDateInput) {
                    const now = new Date();
                    const formattedDate = now.toISOString().slice(0, 16); // Formato: YYYY-MM-DDTHH:MM
                    machineDateInput.value = formattedDate;
                }
                
                formMachine.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const terminal = $('#machineTerminal').value;
                    const type = $('#machineType').value;
                    const description = $('#machineIssue').value;
                    const reportDate = $('#machineDate').value;
                    const estimate = $('#machineEstimate').value;
                    
                    if (!terminal || !type || !description || !reportDate) {
                        showToast('Completa todos los campos requeridos.', 'warning');
                        return;
                    }
                    
                    // Deshabilitar bot√≥n durante env√≠o
                    const submitBtn = $('#machineSubmitBtn');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<div class="spinner"></div> Guardando...';
                    }
                    
                    try {
                        // ID √∫nico para el reporte
                        const reportId = `machine-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
                        
                        // Procesar im√°genes
                        const files = $('#machinePhotos').files;
                        const uploadedImages = [];
                        
                        // Simular subida de im√°genes
                        for (const file of files) {
                            const path = `${reportId}/${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
                            uploadedImages.push({
                                path,
                                url: URL.createObjectURL(file)
                            });
                        }
                        
                        // Calcular fecha estimada de resoluci√≥n
                        const estimatedDate = new Date(reportDate);
                        estimatedDate.setDate(estimatedDate.getDate() + parseInt(estimate, 10));
                        
                        // Guardar reporte
                        const newReport = {
                            id: reportId,
                            created_at: new Date(reportDate).toISOString(),
                            terminal,
                            type,
                            description,
                            estimated_days: parseInt(estimate, 10),
                            estimated_date: estimatedDate.toISOString(),
                            photos: uploadedImages,
                            resolved: false,
                            resolved_at: null,
                            user_id: deviceId,
                            user_name: userConfig.userName || 'Usuario'
                        };
                        
                        // Si supabase est√° configurado, guardar registro
                        if (sb) {
                            try {
                                const { data: ins, error: e1 } = await sb.from('machine_reports').insert({
                                    terminal,
                                    type,
                                    description,
                                    estimated_days: parseInt(estimate, 10),
                                    estimated_date: estimatedDate.toISOString(),
                                    device_id: deviceId,
                                    user_name: userConfig.userName || 'Usuario'
                                }).select('id').single();
                                
                                if (e1) throw e1;
                                
                                // Subir fotos
                                const uploaded = [];
                                for (const f of files) {
                                    const ext = f.name.split('.').pop();
                                    const path = `machine-${ins.id}/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
                                    const { error: eUp } = await sb.storage.from('machine-photos').upload(path, f, { upsert: false });
                                    if (eUp) throw eUp;
                                    uploaded.push(path);
                                }
                                
                                // Actualizar registro con fotos
                                if (uploaded.length) {
                                    const { error: e2 } = await sb.from('machine_reports').update({ photos: uploaded }).eq('id', ins.id);
                                    if (e2) throw e2;
                                }
                                
                                // Usar el ID real de Supabase
                                newReport.id = ins.id;
                            } catch (error) {
                                console.error('Error guardando en Supabase:', error);
                                throw error;
                            }
                        }
                        
                        // Agregar al estado local
                        machineReports.unshift(newReport);
                        saveMachineReports();
                        
                        // Actualizar UI
                        renderMachineReports();
                        
                        // Reiniciar formulario
                        formMachine.reset();
                        $('#machinePhotoPreviews').innerHTML = '';
                        
                        // Establecer fecha actual
                        if (machineDateInput) {
                            machineDateInput.value = new Date().toISOString().slice(0, 16);
                        }
                        
                        // Restaurar valor por defecto
                        $('#machineEstimate').value = '3';
                        
                        // Mostrar notificaci√≥n
                        showToast(`M√°quina reportada en ${terminal}`, 'success');
                        
                        // Enviar notificaci√≥n
                        showNotification(
                            'M√°quina reportada',
                            `Se ha reportado una m√°quina de tipo ${type.replaceAll('_', ' ')} en ${terminal} como fuera de servicio.`,
                            'warning'
                        );
                        
                        // Crear pendientes para buses en ese terminal si es m√°quina de rodillo
                        if (type === 'RODILLO') {
                            const busesInTerminal = buses.filter(b => b.terminal === terminal);
                            if (busesInTerminal.length > 0) {
                                busesInTerminal.forEach(bus => {
                                    const existingPending = pendientes.some(p => {
                                        return p.bus_id === bus.id && p.task === 'LAVADO_RODILLO';
                                    });
                                    
                                    if (!existingPending) {
                                        pendientes.push({
                                            id: `pending-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
                                            bus_id: bus.id,
                                            plate: bus.plate,
                                            task: 'LAVADO_RODILLO',
                                            created_at: new Date().toISOString(),
                                            terminal,
                                            reason: 'M√°quina fuera de servicio'
                                        });
                                    }
                                });
                                
                                savePendientes();
                                renderPendientes();
                                renderFleetStatus();
                                
                                showToast(`Se han creado pendientes para ${busesInTerminal.length} buses en ${terminal}`, 'info');
                            }
                        }
                    } catch (err) {
                        showToast(`Error al guardar: ${err?.message || err}`, 'error');
                    } finally {
                        // Reactivar bot√≥n
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Reportar M√°quina';
                        }
                    }
                });
            }
            
            // Formulario de configuraci√≥n
            const configForm = $('#configForm');
            if (configForm) {
                configForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveUserConfig();
                });
            }
            
            // Bot√≥n Registrar Limpieza en modal de bus
            const registerBtn = $('#register-bus-cleaning');
            if (registerBtn) {
                registerBtn.addEventListener('click', () => {
                    if (selectedBusId) {
                        // Cerrar modal
                        $('#bus-detail-modal').classList.remove('active');
                        
                        // Navegar a registro y configurar bus
                        navigateTo('registro');
                        
                        // Seleccionar el bus en el formulario
                        const busSelect = $('#busSelect');
                        if (busSelect) {
                            busSelect.value = selectedBusId;
                        }
                        
                        // Scroll al formulario
                        $('#formLog').scrollIntoView({ behavior: 'smooth' });
                    }
                });
            }
            
            // Botones de actualizaci√≥n
            const refreshButtons = [
                { id: 'refresh-dashboard', action: () => {
                    loadLogs().then(() => {
                        showToast('Dashboard actualizado', 'success');
                    });
                }},
                { id: 'refresh-pendientes', action: () => {
                    generatePendientes();
                    showToast('Pendientes actualizados', 'success');
                }},
                { id: 'refresh-map', action: () => {
                    refreshMarkers();
                    showToast('Mapa actualizado', 'success');
                }},
                { id: 'force-sync', action: () => {
                    // Simulaci√≥n de sincronizaci√≥n
                    const syncStatus = $('#sync-status');
                    const lastSync = $('#last-sync');
                    
                    if (syncStatus) {
                        syncStatus.textContent = 'Sincronizando...';
                        syncStatus.className = 'badge badge-warning';
                    }
                    
                    setTimeout(() => {
                        if (syncStatus) {
                            syncStatus.textContent = 'Sincronizado';
                            syncStatus.className = 'badge badge-success';
                        }
                        
                        if (lastSync) {
                            lastSync.textContent = new Date().toLocaleString();
                        }
                        
                        showToast('Sincronizaci√≥n completada', 'success');
                    }, 1500);
                }}
            ];
            
            refreshButtons.forEach(({ id, action }) => {
                const button = $(`#${id}`);
                if (button) {
                    button.addEventListener('click', () => {
                        const icon = button.querySelector('i');
                        if (icon) {
                            icon.className = 'bi bi-arrow-repeat fa-spin';
                        }
                        
                        button.disabled = true;
                        
                        // Ejecutar la acci√≥n
                        action();
                        
                        // Restaurar bot√≥n
                        setTimeout(() => {
                            if (icon) {
                                icon.className = 'bi bi-arrow-repeat';
                            }
                            button.disabled = false;
                        }, 1000);
                    });
                }
            });
            
            // Notificaciones y panel
            const notificationsBtn = $('#notifications-btn');
            if (notificationsBtn) {
                notificationsBtn.addEventListener('click', () => {
                    $('#notification-panel').classList.toggle('visible');
                });
            }
            
            const closeNotificationsBtn = $('#close-notifications');
            if (closeNotificationsBtn) {
                closeNotificationsBtn.addEventListener('click', () => {
                    $('#notification-panel').classList.remove('visible');
                });
            }
            
            const markAllReadBtn = $('#mark-all-read');
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', () => {
                    notifications.forEach(n => n.read = true);
                    renderNotifications();
                    updateNotificationBadge();
                    showToast("Todas las notificaciones han sido marcadas como le√≠das", "success");
                });
            }
            
            // Cerrar lightbox
            const lightboxClose = $('#lightbox-close');
            if (lightboxClose) {
                lightboxClose.addEventListener('click', () => {
                    $('#lightbox').classList.remove('visible');
                });
            }
            
            // Cerrar lightbox al hacer clic fuera de la imagen
            const lightbox = $('#lightbox');
            if (lightbox) {
                lightbox.addEventListener('click', (e) => {
                    if (e.target === lightbox) {
                        lightbox.classList.remove('visible');
                    }
                });
            }
            
            // Cerrar modales
            $$('[data-dismiss="modal"]').forEach(button => {
                button.addEventListener('click', () => {
                    const modal = button.closest('.modal-backdrop');
                    if (modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            
            // Cerrar modales al hacer clic fuera
            $$('.modal-backdrop').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            
            // Exportar historial
            const exportBtn = $('#export-history');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    try {
                        const filterValue = $('#history-filter')?.value || 'all';
                        let filteredLogs = [...logs];
                        
                        // Aplicar filtro
                        if (filterValue === 'today') {
                            const todayStr = new Date().toISOString().slice(0, 10);
                            filteredLogs = logs.filter(l => (l.created_at || '').slice(0, 10) === todayStr);
                        } else if (filterValue === 'week') {
                            const weekAgo = new Date();
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            filteredLogs = logs.filter(l => new Date(l.created_at) >= weekAgo);
                        } else if (filterValue === 'month') {
                            const monthAgo = new Date();
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            filteredLogs = logs.filter(l => new Date(l.created_at) >= monthAgo);
                        }
                        
                        // Convertir a CSV
                        const headers = ['Fecha', 'Bus', 'Tarea', 'Interior', 'Exterior', 'Terminal', 'Usuario'];
                        
                        const rows = filteredLogs.map(log => {
                            const date = new Date(log.created_at).toLocaleString();
                            const terminal = log.gps_lat && log.gps_lng ? nearestTerminal(log.gps_lat, log.gps_lng).nombre : 'N/A';
                            
                            return [
                                date,
                                log.plate || 'Desconocido',
                                log.task_type.replaceAll('_', ' '),
                                log.inside_cleaned ? 'S√≠' : 'No',
                                log.outside_cleaned ? 'S√≠' : 'No',
                                terminal,
                                log.user_name || 'Desconocido'
                            ];
                        });
                        
                        // Crear contenido CSV
                        let csvContent = headers.join(',') + '\n';
                        rows.forEach(row => {
                            csvContent += row.join(',') + '\n';
                        });
                        
                        // Crear blob y descargar
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.setAttribute('href', url);
                        link.setAttribute('download', `historial_limpieza_${new Date().toISOString().slice(0, 10)}.csv`);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        showToast(`Exportado ${rows.length} registros a CSV`, 'success');
                    } catch (error) {
                        console.error('Error exportando historial:', error);
                        showToast('Error exportando historial: ' + error.message, 'error');
                    }
                });
            }
            
            // Filtro de historial
            const historyFilter = $('#history-filter');
            if (historyFilter) {
                historyFilter.addEventListener('change', () => {
                    renderFeed();
                });
            }
            
            // Sidebar toggle
            const sidebarToggle = $('.sidebar-toggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    $('#sidebar').classList.toggle('collapsed');
                    $('#content').classList.toggle('sidebar-collapsed');
                });
            }
            
            // Mobile menu toggle
            const mobileMenuBtn = $('#mobile-menu-btn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', () => {
                    $('#sidebar').classList.toggle('mobile-visible');
                });
            }
            
            // Cerrar sidebar al hacer clic fuera
            document.addEventListener('click', (e) => {
                const sidebar = $('#sidebar');
                if (sidebar && sidebar.classList.contains('mobile-visible') && !sidebar.contains(e.target) && e.target !== mobileMenuBtn) {
                    sidebar.classList.remove('mobile-visible');
                }
            });
            
            // Tabs
            $$('.tab-item').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Actualizar tabs
                    $$('.tab-item').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Actualizar paneles
                    $$('.tab-pane').forEach(panel => panel.classList.remove('active'));
                    $(`#tab_${tabId}`)?.classList.add('active');
                    
                    // Si es el tab del mapa, actualizar tama√±o
                    if (tabId === 'mapa' && map) {
                        setTimeout(() => map.invalidateSize(), 100);
                    }
                });
            });
            
            // Menu de navegaci√≥n
            const pageLinks = $$('[data-page]');
            pageLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(link.getAttribute('data-page'));
                });
            });
            
            // Mobile more button
            const mobileMoreBtn = $('#mobile-more-btn');
            if (mobileMoreBtn) {
                mobileMoreBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    $('#sidebar').classList.add('mobile-visible');
                });
            }
        }

        function navigateTo(pageId) {
            // Actualizar URL hash
            window.location.hash = pageId;

            // Ocultar todas las p√°ginas
            $$('.page').forEach(page => page.classList.add('hidden'));
            $$('.page').forEach(page => page.classList.remove('active'));

            // Mostrar la p√°gina seleccionada
            $(`#page-${pageId}`)?.classList.remove('hidden');
            $(`#page-${pageId}`)?.classList.add('active');

            // Actualizar navegaci√≥n
            $$('.sidebar-menu-link').forEach(link => link.classList.remove('active'));
            $$('.sidebar-menu-link').forEach(link => {
                if (link.getAttribute('data-page') === pageId) {
                    link.classList.add('active');
                }
            });

            // Actualizar navegaci√≥n m√≥vil
            $$('.mobile-nav-item').forEach(item => item.classList.remove('active'));
            $$('.mobile-nav-item').forEach(item => {
                if (item.getAttribute('data-page') === pageId) {
                    item.classList.add('active');
                }
            });

            // Acciones espec√≠ficas por p√°gina
            if (pageId === 'mapa' && map) {
                setTimeout(() => map.invalidateSize(), 100);
            }

            // Cerrar sidebar en m√≥vil al navegar
            if (window.innerWidth < 1024) {
                $('#sidebar').classList.remove('mobile-visible');
            }

            // En m√≥viles, hacer scroll al inicio de la p√°gina
            window.scrollTo(0, 0);

            // Si es la p√°gina de registro y estamos en m√≥vil, hacer focus en el formulario
            if (pageId === 'registro' && window.innerWidth < 768) {
                $('#busSelect')?.focus();
            }
        }

        function setupSystemInfo() {
            // Informaci√≥n del dispositivo
            const { deviceInfo, browserInfo } = detectDeviceInfo();
            const deviceInfoEl = $('#device-info');
            const browserInfoEl = $('#browser-info');
            const deviceIdEl = $('#device-id');

            if (deviceInfoEl) deviceInfoEl.textContent = deviceInfo;
            if (browserInfoEl) browserInfoEl.textContent = browserInfo;
            if (deviceIdEl) deviceIdEl.textContent = deviceId.slice(0, 8) + '...';

            // Estado de conectividad
            const updateConnectivity = () => {
                const connectivityEl = $('#connectivity');
                if (!connectivityEl) return;

                connectivityEl.textContent = navigator.onLine ? 'En l√≠nea' : 'Sin conexi√≥n';
                connectivityEl.className = navigator.onLine ? 'text-success' : 'text-danger';
            };

            window.addEventListener('online', updateConnectivity);
            window.addEventListener('offline', updateConnectivity);
            updateConnectivity();

            // Estado de la base de datos
            const dbStatusEl = $('#db-status');
            if (!dbStatusEl) return;

            if (sb) {
                sb.from('buses').select('count(*)', { count: 'exact', head: true })
                    .then(({ count, error }) => {
                        if (error) {
                            dbStatusEl.textContent = 'Error de conexi√≥n';
                            dbStatusEl.className = 'text-danger';
                        } else {
                            dbStatusEl.textContent = `Conectado (${count} buses)`;
                            dbStatusEl.className = 'text-success';
                        }
                    })
                    .catch(() => {
                        dbStatusEl.textContent = 'Error de conexi√≥n';
                        dbStatusEl.className = 'text-danger';
                    });
            } else {
                dbStatusEl.textContent = 'Modo sin conexi√≥n';
                dbStatusEl.className = 'text-warning';
            }
            
            // Estado de sincronizaci√≥n
            const lastSyncEl = $('#last-sync');
            if (lastSyncEl) {
                lastSyncEl.textContent = new Date().toLocaleString();
            }
        }

        function setupRealtime() {
            if (!sb) return;

            sb.channel('realtime:cleaning_logs')
                .on('postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'cleaning_logs' },
                    (payload) => {
                        const rec = payload.new;
                        const bus = buses.find(x => x.id === rec.bus_id);
                        const near = (rec.gps_lat && rec.gps_lng) ? nearestTerminal(rec.gps_lat, rec.gps_lng) : null;

                        showToast(
                            `Nuevo registro: ${bus?.plate || '(bus)'} ¬∑ ${rec.task_type.replaceAll('_', ' ')} ¬∑ ${near ? `${near.nombre} (~${near.dist.toFixed(1)} km)` : 'sin GPS'}`,
                            'info'
                        );

                        // Si el ID de dispositivo es diferente al actual, es un registro de otro usuario
                        if (rec.device_id !== deviceId) {
                            showNotification(
                                'Nuevo registro de otro usuario',
                                `${rec.user_name || 'Usuario'} ha registrado ${bus?.plate || 'un bus'} - ${rec.task_type.replaceAll('_', ' ')}`,
                                'info'
                            );
                        }

                        logs.unshift({ ...rec, plate: bus?.plate });
                        if (clusterLayer) refreshMarkers();
                        renderKPIs();
                        renderFeed();
                        renderPendientes();
                        renderFleetStatus();
                    })
                .subscribe();

            // Polling cada minuto para mantener datos actualizados
            setInterval(loadLogs, 60000);
        }

        // === INICIALIZACI√ìN ===
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                // Inicializar el toast container
                if (!$('#toast-container')) {
                    const toastContainer = document.createElement('div');
                    toastContainer.id = 'toast-container';
                    toastContainer.className = 'toast-container';
                    document.body.appendChild(toastContainer);
                }

                // Mostrar mensaje de inicializaci√≥n
                showToast("Inicializando sistema...", "info");

                // Inicializar Supabase
                await initSupabase();

                // Configurar eventos
                setupEvents();

                // Cargar configuraci√≥n
                loadUserConfig();

                // Solicitar permisos de notificaci√≥n
                requestNotificationPermission();
                
                // Inicializar mapa
                initMap();

                // Cargar datos iniciales
                await loadBuses();
                await loadLogs(); // Esto cargar√° pendientes despu√©s
                loadMachineReports();

                // Informaci√≥n del sistema
                setupSystemInfo();

                // Configurar tiempo real
                setupRealtime();

                // Iniciar GPS si est√° habilitado
                if (userConfig.gpsEnabled) {
                    startGPSWatch();
                }

                // Obtener clima
                fetchWeather();
                // Actualizar clima cada 30 minutos
                setInterval(fetchWeather, 30 * 60 * 1000);

                // Definir navegaci√≥n desde el URL si existe
                const pageFromHash = window.location.hash.slice(1);
                if (pageFromHash && $(`#page-${pageFromHash}`)) {
                    navigateTo(pageFromHash);
                }

                // Actualizar hash al navegar
                window.addEventListener('hashchange', () => {
                    const pageFromHash = window.location.hash.slice(1);
                    if (pageFromHash && $(`#page-${pageFromHash}`)) {
                        navigateTo(pageFromHash);
                    }
                });

                // Actualizar a√±o en footer
                $('#yy').textContent = new Date().getFullYear();
            } catch (error) {
                console.error('Error inicializando la aplicaci√≥n:', error);
                showToast('Error inicializando la aplicaci√≥n: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>
