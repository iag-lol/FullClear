<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sistema de Gesti√≥n Aseo de Flota</title>
    <!-- Favicon -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöç</text></svg>"
        type="image/svg+xml">
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Leaflet + MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* === VARIABLES === */
        :root {
            /* Colores principales */
            --primary-50: #edfaff;
            --primary-100: #d6f4ff;
            --primary-200: #b6ecff;
            --primary-300: #83e1ff;
            --primary-400: #48ceff;
            --primary-500: #1fb0ff;
            --primary-600: #0690f0;
            --primary-700: #0274d9;
            --primary-800: #0761b0;
            --primary-900: #0c5490;
            --primary-950: #093559;

            /* Colores secundarios */
            --secondary-50: #efffef;
            --secondary-100: #d7ffd9;
            --secondary-200: #b2ffb7;
            --secondary-300: #79ff82;
            --secondary-400: #3eff4d;
            --secondary-500: #16e829;
            --secondary-600: #08c21d;
            --secondary-700: #0b971c;
            --secondary-800: #10761c;
            --secondary-900: #126119;
            --secondary-950: #033a0c;

            /* Colores neutros */
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --gray-950: #020617;

            /* Estados */
            --success: var(--secondary-600);
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: var(--primary-600);

            /* Tema claro por defecto */
            --bg-body: #f8fafc;
            --bg-content: #ffffff;
            --bg-card: #ffffff;
            --bg-card-hover: #f1f5f9;
            --bg-sidebar: #ffffff;
            --bg-input: #ffffff;
            --bg-button: var(--primary-600);
            --bg-button-hover: var(--primary-700);
            --bg-button-secondary: var(--gray-200);
            --bg-button-secondary-hover: var(--gray-300);
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-600);
            --text-muted: var(--gray-500);
            --text-on-primary: #ffffff;
            --border-color: var(--gray-200);
            --border-input: var(--gray-300);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            /* Tama√±os y espacios */
            --header-height: 70px;
            --sidebar-width: 280px;
            --sidebar-collapsed: 76px;
            --mobile-nav-height: 66px;
            --container-max-width: 1440px;
            --border-radius-sm: 0.375rem;
            --border-radius: 0.5rem;
            --border-radius-md: 0.75rem;
            --border-radius-lg: 1rem;
            --border-radius-xl: 1.5rem;

            /* Fuentes */
            --font-sans: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-heading: 'Outfit', var(--font-sans);

            /* Animaciones */
            --transition-fast: 150ms;
            --transition: 250ms;
            --transition-slow: 350ms;
            --ease: cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Tema oscuro */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: var(--gray-950);
                --bg-content: var(--gray-900);
                --bg-card: var(--gray-800);
                --bg-card-hover: var(--gray-700);
                --bg-sidebar: var(--gray-900);
                --bg-input: var(--gray-800);
                --text-primary: #f8fafc;
                --text-secondary: #cbd5e1;
                --text-muted: #94a3b8;
                --border-color: var(--gray-700);
                --border-input: var(--gray-600);
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
                --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
                --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
                --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.12);
            }
        }

        /* === RESET & BASE === */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            width: 100%;
        }

        body {
            font-family: var(--font-sans);
            font-size: 16px;
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--bg-body);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            transition: background-color var(--transition);
        }

        /* Tipograf√≠a */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: var(--font-heading);
            font-weight: 600;
            line-height: 1.2;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        h1 {
            font-size: 1.75rem;
        }

        h2 {
            font-size: 1.5rem;
        }

        h3 {
            font-size: 1.25rem;
        }

        h4 {
            font-size: 1.125rem;
        }

        h5 {
            font-size: 1rem;
        }

        h6 {
            font-size: 0.875rem;
        }

        @media (min-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.75rem;
            }

            h3 {
                font-size: 1.5rem;
            }
        }

        p {
            margin-bottom: 1rem;
        }

        a {
            color: var(--primary-600);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            color: var(--primary-700);
        }

        /* === LAYOUT === */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        .main-content {
            flex: 1;
            display: flex;
            height: calc(100% - var(--header-height));
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            height: 100%;
            position: fixed;
            left: 0;
            top: var(--header-height);
            bottom: 0;
            z-index: 40;
            transition: all var(--transition) var(--ease);
            box-shadow: var(--shadow);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--gray-400) transparent;
        }

        .sidebar::-webkit-scrollbar {
            width: 5px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background-color: var(--gray-400);
            border-radius: 20px;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }

        .content-wrapper {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
            overflow-y: auto;
            transition: margin-left var(--transition) var(--ease);
        }

        .content-wrapper.sidebar-collapsed {
            margin-left: var(--sidebar-collapsed);
        }

        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--mobile-nav-height);
            background-color: var(--bg-card);
            border-top: 1px solid var(--border-color);
            z-index: 50;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        @media (max-width: 1023px) {
            .sidebar {
                transform: translateX(-100%);
                box-shadow: var(--shadow-lg);
            }

            .sidebar.mobile-visible {
                transform: translateX(0);
            }

            .content-wrapper,
            .content-wrapper.sidebar-collapsed {
                margin-left: 0;
                padding: 1rem;
                padding-bottom: calc(var(--mobile-nav-height) + 1rem);
            }

            .mobile-nav {
                display: flex;
            }

            .main-content {
                height: calc(100% - var(--header-height) - var(--mobile-nav-height));
            }
        }

        /* === HEADER === */
        .header {
            height: var(--header-height);
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: background-color var(--transition);
        }

        .header-content {
            width: 100%;
            max-width: var(--container-max-width);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            border-radius: var(--border-radius);
            color: white;
            font-weight: 700;
            font-size: 1.125rem;
            box-shadow: var(--shadow-sm);
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--text-primary);
            font-family: var(--font-heading);
        }

        @media (max-width: 768px) {
            .logo-text {
                display: none;
            }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* === CONTAINER === */
        .container {
            width: 100%;
            max-width: var(--container-max-width);
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* === CARD === */
        .card {
            background-color: var(--bg-card);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow);
            transition: box-shadow var(--transition-fast), transform var(--transition-fast);
            overflow: hidden;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title i {
            color: var(--primary-600);
        }

        .card-body {
            padding: 1.5rem;
        }

        .card-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* === FORMULARIOS === */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .form-control {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--bg-input);
            background-clip: padding-box;
            border: 1px solid var(--border-input);
            border-radius: var(--border-radius);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .form-control:focus {
            border-color: var(--primary-400);
            outline: 0;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        .form-control::placeholder {
            color: var(--text-muted);
            opacity: 1;
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1rem;
            padding-right: 2.5rem;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .form-text {
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .form-grid {
            display: grid;
            gap: 1rem;
        }

        @media (min-width: 640px) {
            .form-grid-2 {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-grid-3 {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Input file personalizado */
        .file-input-container {
            position: relative;
        }

        .file-input {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px dashed var(--border-input);
            border-radius: var(--border-radius);
            background-color: var(--bg-input);
            color: var(--text-secondary);
            font-weight: 500;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .file-input:focus+.file-input-label,
        .file-input:hover+.file-input-label {
            border-color: var(--primary-400);
            color: var(--primary-600);
            background-color: rgba(14, 165, 233, 0.05);
        }

        /* Photo preview */
        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .photo-item {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            aspect-ratio: 1 / 1;
            background-color: var(--bg-card-hover);
        }

        .photo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background-color var(--transition-fast);
            z-index: 3;
        }

        .photo-remove:hover {
            background-color: var(--danger);
        }

        /* === BOTONES === */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            user-select: none;
            padding: 0.75rem 1.25rem;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: var(--border-radius);
            transition: all var(--transition-fast);
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .btn:after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }

        .btn:active:after {
            transform: scale(0, 0);
            opacity: .2;
            transition: 0s;
        }

        .btn:disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 2.5rem;
            height: 2.5rem;
            font-size: 1.25rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-lg {
            padding: 1rem 1.5rem;
            font-size: 1.125rem;
        }

        .btn-block {
            display: flex;
            width: 100%;
        }

        .btn-primary {
            color: var(--text-on-primary);
            background-color: var(--bg-button);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--bg-button-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-secondary {
            color: var(--text-primary);
            background-color: var(--bg-button-secondary);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--bg-button-secondary-hover);
        }

        .btn-success {
            color: white;
            background-color: var(--success);
        }

        .btn-success:hover:not(:disabled) {
            background-color: #0b971c;
        }

        .btn-danger {
            color: white;
            background-color: var(--danger);
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
        }

        .btn-warning {
            color: white;
            background-color: var(--warning);
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #d97706;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-outline:hover:not(:disabled) {
            background-color: var(--bg-card-hover);
        }

        .btn-link {
            color: var(--primary-600);
            background-color: transparent;
            box-shadow: none;
            padding: 0.5rem;
        }

        .btn-link:hover:not(:disabled) {
            color: var(--primary-700);
            text-decoration: underline;
            box-shadow: none;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
        }

        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid white;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* === SIDEBAR === */
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-logo {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            color: white;
            font-weight: 700;
            font-size: 1.125rem;
        }

        .sidebar-title {
            font-weight: 700;
            font-size: 1.125rem;
            white-space: nowrap;
            color: var(--text-primary);
        }

        .sidebar-toggle {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            width: 2rem;
            height: 2rem;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .sidebar-toggle:hover {
            background-color: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .sidebar-collapsed .sidebar-title,
        .sidebar-collapsed .sidebar-toggle i.bi-chevron-left {
            display: none;
        }

        .sidebar-collapsed .sidebar-toggle i.bi-chevron-right {
            display: block;
        }

        .sidebar-toggle i.bi-chevron-right {
            display: none;
        }

        .sidebar-nav {
            padding: 1.25rem 0;
        }

        .sidebar-section {
            margin-bottom: 1.5rem;
        }

        .sidebar-section-header {
            padding: 0 1.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .sidebar-collapsed .sidebar-section-header {
            text-align: center;
            padding: 0 0.5rem 0.5rem;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu-item {
            margin-bottom: 0.25rem;
        }

        .sidebar-menu-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.25rem;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all var(--transition-fast);
            border-radius: 0;
            position: relative;
        }

        .sidebar-collapsed .sidebar-menu-link {
            padding: 0.75rem;
            justify-content: center;
        }

        .sidebar-menu-link:hover {
            color: var(--text-primary);
            background-color: var(--bg-card-hover);
        }

        .sidebar-menu-link.active {
            color: var(--primary-600);
            background-color: var(--primary-50);
        }

        .sidebar-menu-link.active::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: var(--primary-600);
            border-radius: 0 4px 4px 0;
        }

        .sidebar-menu-icon {
            flex-shrink: 0;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .sidebar-menu-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-collapsed .sidebar-menu-text {
            display: none;
        }

        .sidebar-footer {
            padding: 1.25rem;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: var(--primary-100);
            color: var(--primary-700);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .user-details {
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .sidebar-collapsed .user-details {
            display: none;
        }

        /* === MOBILE NAV === */
        .mobile-nav-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .mobile-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 0.75rem;
            padding: 0.5rem;
            transition: all var(--transition-fast);
            position: relative;
        }

        .mobile-nav-item.active {
            color: var(--primary-600);
        }

        .mobile-nav-item.active::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 25%;
            right: 25%;
            height: 3px;
            background-color: var(--primary-600);
            border-radius: 3px 3px 0 0;
        }

        .mobile-nav-icon {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        /* === TABS === */
        .tabs-container {
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            position: relative;
        }

        .tabs {
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            position: relative;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-item {
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            color: var(--text-secondary);
            position: relative;
            white-space: nowrap;
            transition: all var(--transition-fast);
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }

        .tab-item:hover {
            color: var(--text-primary);
        }

        .tab-item.active {
            color: var(--primary-600);
            border-bottom: 2px solid var(--primary-600);
        }

        .tab-item .badge {
            margin-left: 0.5rem;
        }

        .tab-content {
            padding: 1.5rem 0;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* === BADGES === */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 999px;
            transition: all var(--transition-fast);
        }

        .badge-primary {
            color: var(--primary-700);
            background-color: var(--primary-100);
        }

        .badge-success {
            color: var(--secondary-700);
            background-color: var(--secondary-100);
        }

        .badge-warning {
            color: #92400e;
            background-color: #fef3c7;
        }

        .badge-danger {
            color: #b91c1c;
            background-color: #fee2e2;
        }

        .badge-neutral {
            color: var(--text-secondary);
            background-color: var(--gray-200);
        }

        /* === ALERTS === */
        .alert {
            position: relative;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .alert-text {
            margin-bottom: 0;
        }

        .alert-primary {
            color: var(--primary-700);
            background-color: var(--primary-50);
        }

        .alert-success {
            color: var(--secondary-700);
            background-color: var(--secondary-50);
        }

        .alert-warning {
            color: #92400e;
            background-color: #fffbeb;
        }

        .alert-danger {
            color: #b91c1c;
            background-color: #fef2f2;
        }

        .alert-info {
            color: #1e40af;
            background-color: #eff6ff;
        }

        /* === CARDS INFORMATIVAS === */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (min-width: 640px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .stat-card {
            padding: 1.25rem;
            background-color: var(--bg-card);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .stat-card-primary {
            border-left: 4px solid var(--primary-600);
        }

        .stat-card-success {
            border-left: 4px solid var(--success);
        }

        .stat-card-warning {
            border-left: 4px solid var(--warning);
        }

        .stat-card-danger {
            border-left: 4px solid var(--danger);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            font-family: var(--font-heading);
        }

        .stat-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-up {
            color: var(--success);
        }

        .stat-down {
            color: var(--danger);
        }

        .stat-icon {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            font-size: 1.25rem;
            color: var(--text-muted);
            opacity: 0.3;
        }

        /* === WEATHER WIDGET === */
        .weather-widget {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem;
            background-color: var(--bg-card);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .weather-icon {
            font-size: 2.25rem;
            color: var(--primary-600);
            background-color: var(--primary-50);
            width: 3.5rem;
            height: 3.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .weather-content {
            flex: 1;
        }

        .weather-temp {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .weather-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .weather-rain {
            color: var(--danger);
            font-weight: 600;
        }

        .weather-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* === FEED Y LISTADOS === */
        .feed-container {
            max-height: 600px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--gray-400) transparent;
        }

        .feed-container::-webkit-scrollbar {
            width: 5px;
        }

        .feed-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .feed-container::-webkit-scrollbar-thumb {
            background-color: var(--gray-400);
            border-radius: 20px;
        }

        .feed-item {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            transition: background-color var(--transition-fast);
        }

        .feed-item:last-child {
            border-bottom: none;
        }

        .feed-item:hover {
            background-color: var(--bg-card-hover);
        }

        .feed-content {
            flex: 1;
            min-width: 0;
        }

        .feed-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
        }

        .feed-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .feed-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .feed-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* === PENDING ITEMS === */
        .pending-item {
            padding: 1.25rem;
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            border-left: 4px solid var(--warning);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
        }

        .pending-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .pending-content {
            flex: 1;
        }

        .pending-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pending-info {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .pending-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* === MAINTENANCE ITEMS === */
        .maintenance-item {
            padding: 1.25rem;
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            border-left: 4px solid var(--danger);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
        }

        .maintenance-item.resolved {
            border-left-color: var(--success);
        }

        .maintenance-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .maintenance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .maintenance-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .maintenance-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 999px;
            font-weight: 600;
            background-color: var(--danger-100);
            color: var(--danger);
        }

        .maintenance-status.resolved {
            background-color: var(--secondary-100);
            color: var(--secondary-700);
        }

        .maintenance-details {
            margin-bottom: 0.75rem;
        }

        .maintenance-dates {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .maintenance-description {
            padding: 0.75rem;
            background-color: var(--bg-card-hover);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
        }

        /* === MAP === */
        .map-container {
            height: 600px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        @media (max-width: 768px) {
            .map-container {
                height: 400px;
            }
        }

        /* === TOAST NOTIFICATIONS === */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 350px;
            max-width: calc(100vw - 2rem);
        }

        @media (max-width: 1023px) {
            .toast-container {
                bottom: calc(var(--mobile-nav-height) + 1rem);
            }
        }

        .toast {
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            padding: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            transition: all var(--transition);
            animation: slideIn 0.3s var(--ease), fadeOut 0.5s var(--ease) 5s forwards;
            border-left: 4px solid var(--primary-600);
            max-width: 100%;
            position: relative;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
            color: var(--primary-600);
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error .toast-icon {
            color: var(--danger);
        }

        .toast.warning .toast-icon {
            color: var(--warning);
        }

        .toast-body {
            flex: 1;
        }

        .toast-close {
            color: var(--text-muted);
            background: transparent;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color var(--transition-fast);
        }

        .toast-close:hover {
            color: var(--text-primary);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        /* === NOTIFICATION PANEL === */
        .notification-panel {
            position: fixed;
            top: var(--header-height);
            right: 0;
            width: 350px;
            max-width: 100vw;
            height: calc(100vh - var(--header-height));
            background-color: var(--bg-card);
            box-shadow: var(--shadow-lg);
            z-index: 60;
            transform: translateX(100%);
            transition: transform var(--transition) var(--ease);
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color);
        }

        .notification-panel.visible {
            transform: translateX(0);
        }

        .notification-header {
            padding: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .notification-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin: 0;
        }

        .notification-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .notification-item {
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.75rem;
            background-color: var(--bg-card-hover);
            border-left: 3px solid var(--primary-600);
            transition: background-color var(--transition-fast);
        }

        .notification-item:hover {
            background-color: var(--bg-body);
        }

        .notification-item.unread {
            background-color: var(--primary-50);
        }

        .notification-item-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .notification-item-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .notification-item-content {
            font-size: 0.875rem;
        }

        .notification-footer {
            padding: 1rem;
            display: flex;
            justify-content: center;
            border-top: 1px solid var(--border-color);
        }

        /* === LIGHTBOX === */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
        }

        .lightbox.visible {
            opacity: 1;
            visibility: visible;
        }

        .lightbox-content {
            max-width: 90%;
            max-height: 90vh;
            position: relative;
        }

        .lightbox-img {
            max-width: 100%;
            max-height: 90vh;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
        }

        .lightbox-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background-color var(--transition-fast);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .lightbox-close:hover {
            background-color: rgba(239, 68, 68, 0.8);
        }

        /* === TOGGLE SWITCH === */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 3rem;
            height: 1.5rem;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-300);
            transition: .4s;
            border-radius: 999px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 1.25rem;
            width: 1.25rem;
            left: 0.125rem;
            bottom: 0.125rem;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }

        input:checked+.toggle-slider {
            background-color: var(--primary-600);
        }

        input:focus+.toggle-slider {
            box-shadow: 0 0 1px var(--primary-600);
        }

        input:checked+.toggle-slider:before {
            transform: translateX(1.5rem);
        }

        .toggle-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* === UTILIDADES === */
        .text-primary {
            color: var(--text-primary) !important;
        }

        .text-secondary {
            color: var(--text-secondary) !important;
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        .text-success {
            color: var(--success) !important;
        }

        .text-danger {
            color: var(--danger) !important;
        }

        .text-warning {
            color: var(--warning) !important;
        }

        .text-info {
            color: var(--primary-600) !important;
        }

        .text-center {
            text-align: center !important;
        }

        .text-left {
            text-align: left !important;
        }

        .text-right {
            text-align: right !important;
        }

        .font-bold {
            font-weight: 700 !important;
        }

        .font-semibold {
            font-weight: 600 !important;
        }

        .font-medium {
            font-weight: 500 !important;
        }

        .font-normal {
            font-weight: 400 !important;
        }

        .text-xs {
            font-size: 0.75rem !important;
        }

        .text-sm {
            font-size: 0.875rem !important;
        }

        .text-base {
            font-size: 1rem !important;
        }

        .text-lg {
            font-size: 1.125rem !important;
        }

        .text-xl {
            font-size: 1.25rem !important;
        }

        .text-2xl {
            font-size: 1.5rem !important;
        }

        .hidden {
            display: none !important;
        }

        .invisible {
            visibility: hidden !important;
        }

        .d-flex {
            display: flex !important;
        }

        .d-inline-flex {
            display: inline-flex !important;
        }

        .d-block {
            display: block !important;
        }

        .d-inline-block {
            display: inline-block !important;
        }

        .flex-row {
            flex-direction: row !important;
        }

        .flex-column {
            flex-direction: column !important;
        }

        .flex-wrap {
            flex-wrap: wrap !important;
        }

        .flex-nowrap {
            flex-wrap: nowrap !important;
        }

        .justify-content-start {
            justify-content: flex-start !important;
        }

        .justify-content-end {
            justify-content: flex-end !important;
        }

        .justify-content-center {
            justify-content: center !important;
        }

        .justify-content-between {
            justify-content: space-between !important;
        }

        .justify-content-around {
            justify-content: space-around !important;
        }

        .align-items-start {
            align-items: flex-start !important;
        }

        .align-items-end {
            align-items: flex-end !important;
        }

        .align-items-center {
            align-items: center !important;
        }

        .align-items-baseline {
            align-items: baseline !important;
        }

        .align-items-stretch {
            align-items: stretch !important;
        }

        .gap-1 {
            gap: 0.25rem !important;
        }

        .gap-2 {
            gap: 0.5rem !important;
        }

        .gap-3 {
            gap: 0.75rem !important;
        }

        .gap-4 {
            gap: 1rem !important;
        }

        .gap-5 {
            gap: 1.25rem !important;
        }

        .gap-6 {
            gap: 1.5rem !important;
        }

        .w-100 {
            width: 100% !important;
        }

        .h-100 {
            height: 100% !important;
        }

        .position-relative {
            position: relative !important;
        }

        .position-absolute {
            position: absolute !important;
        }

        .position-fixed {
            position: fixed !important;
        }

        .position-sticky {
            position: sticky !important;
        }

        .m-0 {
            margin: 0 !important;
        }

        .mt-0 {
            margin-top: 0 !important;
        }

        .mr-0 {
            margin-right: 0 !important;
        }

        .mb-0 {
            margin-bottom: 0 !important;
        }

        .ml-0 {
            margin-left: 0 !important;
        }

        .m-1 {
            margin: 0.25rem !important;
        }

        .mt-1 {
            margin-top: 0.25rem !important;
        }

        .mr-1 {
            margin-right: 0.25rem !important;
        }

        .mb-1 {
            margin-bottom: 0.25rem !important;
        }

        .ml-1 {
            margin-left: 0.25rem !important;
        }

        .m-2 {
            margin: 0.5rem !important;
        }

        .mt-2 {
            margin-top: 0.5rem !important;
        }

        .mr-2 {
            margin-right: 0.5rem !important;
        }

        .mb-2 {
            margin-bottom: 0.5rem !important;
        }

        .ml-2 {
            margin-left: 0.5rem !important;
        }

        .m-3 {
            margin: 0.75rem !important;
        }

        .mt-3 {
            margin-top: 0.75rem !important;
        }

        .mr-3 {
            margin-right: 0.75rem !important;
        }

        .mb-3 {
            margin-bottom: 0.75rem !important;
        }

        .ml-3 {
            margin-left: 0.75rem !important;
        }

        .m-4 {
            margin: 1rem !important;
        }

        .mt-4 {
            margin-top: 1rem !important;
        }

        .mr-4 {
            margin-right: 1rem !important;
        }

        .mb-4 {
            margin-bottom: 1rem !important;
        }

        .ml-4 {
            margin-left: 1rem !important;
        }

        .m-5 {
            margin: 1.25rem !important;
        }

        .mt-5 {
            margin-top: 1.25rem !important;
        }

        .mr-5 {
            margin-right: 1.25rem !important;
        }

        .mb-5 {
            margin-bottom: 1.25rem !important;
        }

        .ml-5 {
            margin-left: 1.25rem !important;
        }

        .p-0 {
            padding: 0 !important;
        }

        .pt-0 {
            padding-top: 0 !important;
        }

        .pr-0 {
            padding-right: 0 !important;
        }

        .pb-0 {
            padding-bottom: 0 !important;
        }

        .pl-0 {
            padding-left: 0 !important;
        }

        .p-1 {
            padding: 0.25rem !important;
        }

        .pt-1 {
            padding-top: 0.25rem !important;
        }

        .pr-1 {
            padding-right: 0.25rem !important;
        }

        .pb-1 {
            padding-bottom: 0.25rem !important;
        }

        .pl-1 {
            padding-left: 0.25rem !important;
        }

        .p-2 {
            padding: 0.5rem !important;
        }

        .pt-2 {
            padding-top: 0.5rem !important;
        }

        .pr-2 {
            padding-right: 0.5rem !important;
        }

        .pb-2 {
            padding-bottom: 0.5rem !important;
        }

        .pl-2 {
            padding-left: 0.5rem !important;
        }

        .p-3 {
            padding: 0.75rem !important;
        }

        .pt-3 {
            padding-top: 0.75rem !important;
        }

        .pr-3 {
            padding-right: 0.75rem !important;
        }

        .pb-3 {
            padding-bottom: 0.75rem !important;
        }

        .pl-3 {
            padding-left: 0.75rem !important;
        }

        .p-4 {
            padding: 1rem !important;
        }

        .pt-4 {
            padding-top: 1rem !important;
        }

        .pr-4 {
            padding-right: 1rem !important;
        }

        .pb-4 {
            padding-bottom: 1rem !important;
        }

        .pl-4 {
            padding-left: 1rem !important;
        }

        .p-5 {
            padding: 1.25rem !important;
        }

        .pt-5 {
            padding-top: 1.25rem !important;
        }

        .pr-5 {
            padding-right: 1.25rem !important;
        }

        .pb-5 {
            padding-bottom: 1.25rem !important;
        }

        .pl-5 {
            padding-left: 1.25rem !important;
        }

        .rounded {
            border-radius: var(--border-radius) !important;
        }

        .rounded-sm {
            border-radius: var(--border-radius-sm) !important;
        }

        .rounded-md {
            border-radius: var(--border-radius-md) !important;
        }

        .rounded-lg {
            border-radius: var(--border-radius-lg) !important;
        }

        .rounded-xl {
            border-radius: var(--border-radius-xl) !important;
        }

        .rounded-circle {
            border-radius: 50% !important;
        }

        .rounded-pill {
            border-radius: 999px !important;
        }

        .shadow-none {
            box-shadow: none !important;
        }

        .shadow-sm {
            box-shadow: var(--shadow-sm) !important;
        }

        .shadow {
            box-shadow: var(--shadow) !important;
        }

        .shadow-md {
            box-shadow: var(--shadow-md) !important;
        }

        .shadow-lg {
            box-shadow: var(--shadow-lg) !important;
        }

        .border {
            border: 1px solid var(--border-color) !important;
        }

        .border-top {
            border-top: 1px solid var(--border-color) !important;
        }

        .border-right {
            border-right: 1px solid var(--border-color) !important;
        }

        .border-bottom {
            border-bottom: 1px solid var(--border-color) !important;
        }

        .border-left {
            border-left: 1px solid var(--border-color) !important;
        }

        .border-0 {
            border: 0 !important;
        }

        .bg-primary {
            background-color: var(--primary-600) !important;
        }

        .bg-success {
            background-color: var(--success) !important;
        }

        .bg-warning {
            background-color: var(--warning) !important;
        }

        .bg-danger {
            background-color: var(--danger) !important;
        }

        .bg-info {
            background-color: var(--primary-100) !important;
        }

        .bg-transparent {
            background-color: transparent !important;
        }

        .opacity-0 {
            opacity: 0 !important;
        }

        .opacity-25 {
            opacity: 0.25 !important;
        }

        .opacity-50 {
            opacity: 0.5 !important;
        }

        .opacity-75 {
            opacity: 0.75 !important;
        }

        .opacity-100 {
            opacity: 1 !important;
        }

        .overflow-auto {
            overflow: auto !important;
        }

        .overflow-hidden {
            overflow: hidden !important;
        }

        .overflow-visible {
            overflow: visible !important;
        }

        .overflow-scroll {
            overflow: scroll !important;
        }

        .text-truncate {
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }

        .cursor-pointer {
            cursor: pointer !important;
        }

        .user-select-none {
            user-select: none !important;
        }

        /* Responsive utilities */
        @media (max-width: 639px) {
            .hidden-xs {
                display: none !important;
            }
        }

        @media (min-width: 640px) and (max-width: 1023px) {
            .hidden-sm {
                display: none !important;
            }
        }

        @media (min-width: 1024px) {
            .hidden-lg {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <button id="mobile-menu-btn" class="btn btn-icon btn-outline hidden-lg">
                        <i class="bi bi-list"></i>
                    </button>
                    <div class="logo-container">
                        <div class="logo">AF</div>
                        <span class="logo-text">Sistema de Aseo de Flota</span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="weather-display d-flex align-items-center gap-2" id="weather-mini">
                        <i class="bi bi-cloud-sun"></i>
                        <span id="weather-temp">--¬∞C</span>
                    </div>
                    <div class="text-muted hidden-xs" id="now"></div>
                    <button id="notifications-btn" class="btn btn-icon btn-outline position-relative">
                        <i class="bi bi-bell"></i>
                        <span id="notification-badge"
                            class="position-absolute bg-danger text-white d-flex align-items-center justify-content-center rounded-circle"
                            style="top: -5px; right: -5px; width: 18px; height: 18px; font-size: 10px; display: none;">0</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-nav">
                    <div class="sidebar-section">
                        <div class="sidebar-section-header">General</div>
                        <ul class="sidebar-menu">
                            <li class="sidebar-menu-item">
                                <a href="#dashboard" class="sidebar-menu-link active" data-page="dashboard">
                                    <span class="sidebar-menu-icon"><i class="bi bi-speedometer2"></i></span>
                                    <span class="sidebar-menu-text">Dashboard</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item">
                                <a href="#registro" class="sidebar-menu-link" data-page="registro">
                                    <span class="sidebar-menu-icon"><i class="bi bi-clipboard-plus"></i></span>
                                    <span class="sidebar-menu-text">Registrar Aseo</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item">
                                <a href="#pendientes" class="sidebar-menu-link" data-page="pendientes">
                                    <span class="sidebar-menu-icon"><i class="bi bi-exclamation-triangle"></i></span>
                                    <span class="sidebar-menu-text">Pendientes</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item">
                                <a href="#mapa" class="sidebar-menu-link" data-page="mapa">
                                    <span class="sidebar-menu-icon"><i class="bi bi-geo-alt"></i></span>
                                    <span class="sidebar-menu-text">Mapa</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-section-header">Mantenimiento</div>
                        <ul class="sidebar-menu">
                            <li class="sidebar-menu-item">
                                <a href="#reportar-maquina" class="sidebar-menu-link" data-page="reportar-maquina">
                                    <span class="sidebar-menu-icon"><i class="bi bi-tools"></i></span>
                                    <span class="sidebar-menu-text">M√°quinas</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item">
                                <a href="#historial" class="sidebar-menu-link" data-page="historial">
                                    <span class="sidebar-menu-icon"><i class="bi bi-clock-history"></i></span>
                                    <span class="sidebar-menu-text">Historial</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-section-header">Sistema</div>
                        <ul class="sidebar-menu">
                            <li class="sidebar-menu-item">
                                <a href="#reportes" class="sidebar-menu-link" data-page="reportes">
                                    <span class="sidebar-menu-icon"><i class="bi bi-file-earmark-bar-graph"></i></span>
                                    <span class="sidebar-menu-text">Reportes</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item">
                                <a href="#configuracion" class="sidebar-menu-link" data-page="configuracion">
                                    <span class="sidebar-menu-icon"><i class="bi bi-gear"></i></span>
                                    <span class="sidebar-menu-text">Configuraci√≥n</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="sidebar-footer">
                    <div class="user-info">
                        <div class="user-avatar" id="user-initial">U</div>
                        <div class="user-details">
                            <div class="user-name" id="user-name">Usuario</div>
                            <div class="user-role" id="user-terminal">Terminal: Desconocido</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="content-wrapper" id="content">
                <!-- Page Container -->
                <div class="container" id="page-container">
                    <!-- Dashboard Page -->
                    <div class="page active" id="page-dashboard">
                        <h1 class="mb-4">Dashboard</h1>

                        <!-- Weather Widget -->
                        <div class="weather-widget" id="weather-widget">
                            <div class="weather-icon">
                                <i class="bi bi-cloud-sun"></i>
                            </div>
                            <div class="weather-content">
                                <div class="weather-temp" id="weather-temp-full">--¬∞C</div>
                                <div class="weather-desc" id="weather-desc">Cargando informaci√≥n del clima...</div>
                                <div class="weather-date" id="weather-date">Actualizado: --</div>
                            </div>
                        </div>

                        <!-- Stats Cards -->
                        <div class="stats-grid">
                            <div class="stat-card stat-card-primary">
                                <div class="stat-label"><i class="bi bi-clipboard-check"></i> Registros HOY</div>
                                <div class="stat-value" id="kpiTotal">0</div>
                                <div class="stat-icon"><i class="bi bi-clipboard-check"></i></div>
                            </div>
                            <div class="stat-card stat-card-primary">
                                <div class="stat-label"><i class="bi bi-broom"></i> Interior HOY</div>
                                <div class="stat-value" id="kpiInt">0</div>
                                <div class="stat-icon"><i class="bi bi-broom"></i></div>
                            </div>
                            <div class="stat-card stat-card-success">
                                <div class="stat-label"><i class="bi bi-water"></i> Exterior HOY</div>
                                <div class="stat-value" id="kpiExt">0</div>
                                <div class="stat-icon"><i class="bi bi-water"></i></div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label"><i class="bi bi-bar-chart"></i> Distribuci√≥n</div>
                                <canvas id="barTasks" height="64" aria-label="Gr√°fico por tarea" role="img"></canvas>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="card">
                            <div class="tabs-container">
                                <div class="tabs">
                                    <div class="tab-item active" data-tab="resumen">Resumen</div>
                                    <div class="tab-item" data-tab="feed">Historial</div>
                                    <div class="tab-item" data-tab="pendientes">
                                        Pendientes <span class="badge badge-warning" id="pendientes-count">0</span>
                                    </div>
                                    <div class="tab-item" data-tab="maquinas">Estado M√°quinas</div>
                                </div>
                            </div>

                            <div class="card-body p-0">
                                <!-- Resumen Tab -->
                                <div class="tab-pane active" id="tab_resumen">
                                    <div class="p-4">
                                        <div class="d-flex flex-column flex-lg-row gap-4">
                                            <div class="card flex-grow-1 mb-0">
                                                <div class="card-header">
                                                    <h3 class="card-title">Avance Diario</h3>
                                                </div>
                                                <div class="card-body">
                                                    <canvas id="progressChart" height="250"></canvas>
                                                </div>
                                            </div>
                                            <div class="card flex-grow-1 mb-0">
                                                <div class="card-header">
                                                    <h3 class="card-title">Por Terminal</h3>
                                                </div>
                                                <div class="card-body">
                                                    <canvas id="terminalChart" height="250"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Feed Tab -->
                                <div class="tab-pane" id="tab_feed">
                                    <div class="feed-container" id="feed">
                                        <!-- Feed items will be added dynamically -->
                                    </div>
                                </div>

                                <!-- Pendientes Tab -->
                                <div class="tab-pane" id="tab_pendientes">
                                    <div class="p-4">
                                        <div id="pendientes-list" class="mb-4">
                                            <!-- Pending items will be added dynamically -->
                                        </div>
                                    </div>
                                </div>

                                <!-- M√°quinas Tab -->
                                <div class="tab-pane" id="tab_maquinas">
                                    <div class="p-4">
                                        <div id="maquinas-list" class="mb-4">
                                            <!-- Machine reports will be added dynamically -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Registro Page -->
                    <div class="page hidden" id="page-registro">
                        <h1 class="mb-4">Registrar Aseo</h1>

                        <div class="card mb-4">
                            <div class="card-header">
                                <h2 class="card-title"><i class="bi bi-clipboard-plus"></i> Nuevo registro</h2>
                            </div>
                            <div class="card-body">
                                <form id="formLog" novalidate>
                                    <div class="form-grid form-grid-2">
                                        <div class="form-group">
                                            <label class="form-label" for="busSelect">PPU / Bus</label>
                                            <select id="busSelect" class="form-control" required>
                                                <option value="">Selecciona bus</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="taskSelect">Tarea realizada</label>
                                            <select id="taskSelect" class="form-control" required>
                                                <option value="">Elige tarea</option>
                                                <option value="BARRIDO">Barrido</option>
                                                <option value="BARRIDO_Y_MOPEO">Barrido y Mopeo</option>
                                                <option value="FULL">Full (interior + rodillo)</option>
                                                <option value="LAVADO_RODILLO">Lavado con rodillos</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Fotos (opcional)</label>
                                        <div class="file-input-container">
                                            <input type="file" id="files" class="file-input" multiple
                                                accept="image/*" />
                                            <label for="files" class="file-input-label">
                                                <i class="bi bi-cloud-upload"></i> Seleccionar fotos
                                            </label>
                                        </div>
                                        <div id="previews" class="photo-preview mt-3"></div>
                                    </div>

                                    <div class="form-group">
                                        <div class="alert alert-info mb-0">
                                            <div class="alert-icon"><i class="bi bi-geo-alt"></i></div>
                                            <div class="alert-content">
                                                <div class="alert-title">Ubicaci√≥n</div>
                                                <p class="alert-text" id="gpsTxt">GPS: inicializando‚Ä¶</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end gap-3">
                                        <button type="button" class="btn btn-outline"
                                            onclick="resetForm()">Cancelar</button>
                                        <button type="submit" id="submitBtn" class="btn btn-primary">
                                            <i class="bi bi-save"></i> Guardar registro
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="bi bi-clock-history"></i> √öltimos registros</h2>
                            </div>
                            <div class="card-body p-0">
                                <div class="feed-container" id="recent-feed" style="max-height: 400px;">
                                    <!-- Recent feed items will be added dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pendientes Page -->
                    <div class="page hidden" id="page-pendientes">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="mb-0">Tareas Pendientes</h1>
                            <button id="refresh-pendientes" class="btn btn-primary">
                                <i class="bi bi-arrow-clockwise"></i> Actualizar
                            </button>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="bi bi-exclamation-triangle"></i> Lista de pendientes
                                </h2>
                                <div class="d-flex align-items-center">
                                    <span class="badge badge-warning mr-2" id="pendientes-full-count">0</span> tareas
                                    pendientes
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="pendientes-full-list">
                                    <!-- Pending items will be added dynamically -->
                                    <div class="text-center text-muted">No hay tareas pendientes</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mapa Page -->
                    <div class="page hidden" id="page-mapa">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="mb-0">Mapa de Registros</h1>
                            <select id="map-filter" class="form-control" style="width: auto; min-width: 200px;">
                                <option value="all">Todos los registros</option>
                                <option value="today">Hoy</option>
                                <option value="interior">Interior</option>
                                <option value="exterior">Exterior</option>
                            </select>
                        </div>

                        <div class="card">
                            <div class="card-body p-0">
                                <div id="map" class="map-container" aria-label="Mapa de registros"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Reportar M√°quina Page -->
                    <div class="page hidden" id="page-reportar-maquina">
                        <h1 class="mb-4">Reportar M√°quina</h1>

                        <div class="card mb-4">
                            <div class="card-header">
                                <h2 class="card-title"><i class="bi bi-tools"></i> Reportar falla</h2>
                            </div>
                            <div class="card-body">
                                <form id="formMachine" novalidate>
                                    <div class="form-grid form-grid-2">
                                        <div class="form-group">
                                            <label class="form-label" for="machineTerminal">Terminal</label>
                                            <select id="machineTerminal" class="form-control" required>
                                                <option value="">Seleccionar terminal</option>
                                                <option value="El Roble">El Roble</option>
                                                <option value="La Reina">La Reina</option>
                                                <option value="Mar√≠a Ang√©lica">Mar√≠a Ang√©lica</option>
                                                <option value="El Descanso">El Descanso</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="machineType">Tipo de M√°quina</label>
                                            <select id="machineType" class="form-control" required>
                                                <option value="">Seleccionar tipo</option>
                                                <option value="RODILLO">M√°quina de Rodillos</option>
                                                <option value="ASPIRADORA">Aspiradora Industrial</option>
                                                <option value="HIDROLAVADORA">Hidrolavadora</option>
                                                <option value="OTRA">Otra</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label" for="machineIssue">Descripci√≥n del problema</label>
                                        <textarea id="machineIssue" class="form-control" rows="3" required></textarea>
                                    </div>

                                    <div class="form-grid form-grid-2">
                                        <div class="form-group">
                                            <label class="form-label" for="machineDate">Fecha de reporte</label>
                                            <input type="datetime-local" id="machineDate" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="machineEstimate">Estimaci√≥n de reparaci√≥n
                                                (d√≠as)</label>
                                            <input type="number" id="machineEstimate" class="form-control" min="1"
                                                max="30" value="3">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Fotos (opcional)</label>
                                        <div class="file-input-container">
                                            <input type="file" id="machinePhotos" class="file-input" multiple
                                                accept="image/*">
                                            <label for="machinePhotos" class="file-input-label">
                                                <i class="bi bi-cloud-upload"></i> Seleccionar fotos
                                            </label>
                                        </div>
                                        <div id="machinePhotoPreviews" class="photo-preview mt-3"></div>
                                    </div>

                                    <div class="d-flex justify-content-end gap-3">
                                        <button type="button" class="btn btn-outline"
                                            onclick="resetMachineForm()">Cancelar</button>
                                        <button type="submit" id="machineSubmitBtn" class="btn btn-danger">
                                            <i class="bi bi-exclamation-triangle"></i> Reportar M√°quina
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="bi bi-wrench"></i> M√°quinas Reportadas</h2>
                            </div>
                            <div class="card-body">
                                <div id="machine-reports-list">
                                    <!-- Machine reports will be added dynamically -->
                                    <div class="text-center text-muted">No hay reportes de m√°quinas</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Historial Page -->
                    <div class="page hidden" id="page-historial">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="mb-0">Historial Completo</h1>
                            <div class="d-flex gap-3">
                                <select id="history-filter" class="form-control">
                                    <option value="all">Todos los registros</option>
                                    <option value="today">Hoy</option>
                                    <option value="week">Esta semana</option>
                                    <option value="month">Este mes</option>
                                </select>
                                <button id="export-history" class="btn btn-primary">
                                    <i class="bi bi-download"></i> Exportar
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="bi bi-clock-history"></i> Registros</h2>
                            </div>
                            <div class="card-body p-0">
                                <div class="feed-container" id="history-feed" style="max-height: 600px;">
                                    <!-- History feed items will be added dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reportes Page -->
                    <div class="page hidden" id="page-reportes">
                        <h1 class="mb-4">Reportes y Estad√≠sticas</h1>

                        <div class="d-flex flex-column gap-4">
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title"><i class="bi bi-calendar3"></i> Cumplimiento Mensual</h2>
                                </div>
                                <div class="card-body">
                                    <canvas id="monthlyChart" height="300"></canvas>
                                </div>
                            </div>

                            <div class="d-flex flex-column flex-lg-row gap-4">
                                <div class="card flex-grow-1">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-pie-chart"></i> Distribuci√≥n por Tipo
                                        </h2>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="taskTypeChart" height="250"></canvas>
                                    </div>
                                </div>

                                <div class="card flex-grow-1">
                                    <div class="card-header">
                                        <h2 class="card-title"><i class="bi bi-bar-chart-line"></i> Rendimiento por
                                            Terminal</h2>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="terminalPerformanceChart" height="250"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title"><i class="bi bi-wrench"></i> M√°quinas - Tiempo Fuera</h2>
                                </div>
                                <div class="card-body">
                                    <canvas id="machineDowntimeChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuraci√≥n Page -->
                    <div class="page hidden" id="page-configuracion">
                        <h1 class="mb-4">Configuraci√≥n</h1>

                        <div class="card mb-4">
                            <div class="card-header">
                                <h2 class="card-title"><i class="bi bi-sliders"></i> Preferencias del Sistema</h2>
                            </div>
                            <div class="card-body">
                                <form id="configForm">
                                    <h3 class="mb-3">Preferencias Generales</h3>
                                    <div class="form-grid form-grid-2 mb-4">
                                        <div class="toggle-container">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="notificationsEnabled" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                            <span class="toggle-label">Notificaciones en tiempo real</span>
                                        </div>
                                        <div class="toggle-container">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="gpsEnabled" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                            <span class="toggle-label">Rastreo GPS autom√°tico</span>
                                        </div>
                                    </div>

                                    <h3 class="mb-3">Informaci√≥n de Usuario</h3>
                                    <div class="form-grid form-grid-2 mb-4">
                                        <div class="form-group mb-0">
                                            <label class="form-label" for="userName">Nombre de usuario</label>
                                            <input type="text" id="userName" class="form-control"
                                                placeholder="Tu nombre">
                                        </div>
                                        <div class="form-group mb-0">
                                            <label class="form-label" for="userTerminal">Terminal asignado</label>
                                            <select id="userTerminal" class="form-control">
                                                <option value="">Seleccionar terminal</option>
                                                <option value="El Roble">El Roble</option>
                                                <option value="La Reina">La Reina</option>
                                                <option value="Mar√≠a Ang√©lica">Mar√≠a Ang√©lica</option>
                                                <option value="El Descanso">El Descanso</option>
                                            </select>
                                        </div>
                                    </div>

                                    <h3 class="mb-3">Clima</h3>
                                    <div class="form-grid form-grid-2 mb-4">
                                        <div class="form-group mb-0">
                                            <label class="form-label" for="weatherLocation">Ubicaci√≥n para clima</label>
                                            <input type="text" id="weatherLocation" class="form-control"
                                                placeholder="Santiago, CL" value="Santiago, CL">
                                        </div>
                                        <div class="toggle-container" style="align-self: flex-end;">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="autoResetOnRain" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                            <span class="toggle-label">Resetear pendientes al detectar lluvia</span>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end">
                                        <button type="submit" id="saveConfigBtn" class="btn btn-primary">
                                            <i class="bi bi-check-lg"></i> Guardar configuraci√≥n
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="bi bi-info-circle"></i> Informaci√≥n del Sistema</h2>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <strong>Versi√≥n:</strong> <span class="badge badge-primary">2.1.0</span>
                                        </div>
                                        <div class="mb-3">
                                            <strong>Dispositivo:</strong> <span id="device-info">Cargando...</span>
                                        </div>
                                        <div class="mb-3">
                                            <strong>ID de dispositivo:</strong> <span id="device-id">Cargando...</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <strong>Navegador:</strong> <span id="browser-info">Cargando...</span>
                                        </div>
                                        <div class="mb-3">
                                            <strong>Conectividad:</strong> <span id="connectivity">Cargando...</span>
                                        </div>
                                        <div class="mb-3">
                                            <strong>Base de datos:</strong> <span id="db-status">Verificando
                                                conexi√≥n...</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-info">
                                    <div class="alert-icon"><i class="bi bi-shield-check"></i></div>
                                    <div class="alert-content">
                                        <div class="alert-title">Sistema Seguro</div>
                                        <p class="alert-text">Todos los datos son almacenados de forma segura y
                                            sincronizados en tiempo real con el servidor central.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="mt-4 pb-5 text-center text-muted">
                    <div class="container">
                        <p>¬© <span id="yy"></span> Sistema de Aseo de Flota ¬∑ Versi√≥n 2.1</p>
                    </div>
                </footer>
            </div>
        </div>

        <!-- Mobile Navigation -->
        <div class="mobile-nav">
            <div class="mobile-nav-container">
                <a href="#dashboard" class="mobile-nav-item active" data-page="dashboard">
                    <i class="mobile-nav-icon bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#registro" class="mobile-nav-item" data-page="registro">
                    <i class="mobile-nav-icon bi bi-clipboard-plus"></i>
                    <span>Registrar</span>
                </a>
                <a href="#pendientes" class="mobile-nav-item" data-page="pendientes">
                    <i class="mobile-nav-icon bi bi-exclamation-triangle"></i>
                    <span>Pendientes</span>
                </a>
                <a href="#mapa" class="mobile-nav-item" data-page="mapa">
                    <i class="mobile-nav-icon bi bi-geo-alt"></i>
                    <span>Mapa</span>
                </a>
                <a href="#" class="mobile-nav-item" id="mobile-more-btn">
                    <i class="mobile-nav-icon bi bi-three-dots"></i>
                    <span>M√°s</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notification-panel">
        <div class="notification-header">
            <h3 class="notification-title">Notificaciones</h3>
            <button id="close-notifications" class="btn btn-icon btn-outline">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="notification-list" id="notification-list">
            <!-- Notifications will be added here -->
        </div>
        <div class="notification-footer">
            <button id="mark-all-read" class="btn btn-outline">
                <i class="bi bi-check-all"></i> Marcar todas como le√≠das
            </button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container">
        <!-- Toasts will be added here -->
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
        <div class="lightbox-content">
            <img src="" alt="Imagen ampliada" class="lightbox-img" id="lightbox-img">
        </div>
        <div class="lightbox-close" id="lightbox-close">
            <i class="bi bi-x"></i>
        </div>
    </div>

    <script>

        // Al inicio de tu funci√≥n de inicializaci√≥n
        localStorage.removeItem('flota_pendientes');
        localStorage.removeItem('flota_machine_reports');
        // ===== CONFIG =====
        // Reemplazar con tus propios valores
        const SUPABASE_URL = "https://tcmtxvuucjttngcazgff.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjbXR4dnV1Y2p0dG5nY2F6Z2ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA3MjUwMDEsImV4cCI6MjA1NjMwMTAwMX0.2WcIjMUEhSM6j9kYpbsYArQocZdHx86k7wXk-NyjIs0";

        // Configuraci√≥n de terminales
        const TERMINALES = [
            { nombre: "El Roble", lat: -33.44071194412281, lng: -70.78973603006452 },
            { nombre: "La Reina", lat: -33.4648451661274, lng: -70.53179284909858 },
            { nombre: "Mar√≠a Ang√©lica", lat: -33.51772240158645, lng: -70.55641931656773 },
            { nombre: "El Descanso", lat: -33.4695150389365, lng: -70.76243487908678 },
        ];

        // Tipos de tareas
        const TASKS = [
            { code: 'BARRIDO', label: 'Barrido', icon: 'bi-broom' },
            { code: 'BARRIDO_Y_MOPEO', label: 'Barrido y Mopeo', icon: 'bi-droplet' },
            { code: 'FULL', label: 'Full (interior + rodillo)', icon: 'bi-check2-all' },
            { code: 'LAVADO_RODILLO', label: 'Lavado con rodillos', icon: 'bi-water' },
        ];

        // ===== UTILS =====
        // Funciones de utilidad
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));

        // Mostrar un toast - Definici√≥n global para evitar errores de inicializaci√≥n
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) {
                console.error('Contenedor de toast no encontrado');
                return;
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            let icon = 'bi-info-circle';
            if (type === 'success') icon = 'bi-check-circle';
            if (type === 'error') icon = 'bi-exclamation-circle';
            if (type === 'warning') icon = 'bi-exclamation-triangle';

            toast.innerHTML = `
      <div class="toast-icon"><i class="bi ${icon}"></i></div>
      <div class="toast-body">
        <div>${message}</div>
      </div>
      <button type="button" class="toast-close"><i class="bi bi-x"></i></button>
    `;

            container.appendChild(toast);

            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);

            // Manual close
            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            });
        }

        // C√°lculo de distancia entre coordenadas (Haversine)
        function haversineKm(a, b) {
            const R = 6371;
            const dLat = ((b.lat - a.lat) * Math.PI) / 180;
            const dLon = ((b.lng - a.lng) * Math.PI) / 180;
            const lat1 = (a.lat * Math.PI) / 180;
            const lat2 = (b.lat * Math.PI) / 180;
            const x = Math.sin(dLat / 2) ** 2 + Math.sin(dLon / 2) ** 2 * Math.cos(lat1) * Math.cos(lat2);
            const d = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1 - x));
            return R * d;
        }

        // Encontrar el terminal m√°s cercano
        function nearestTerminal(lat, lng) {
            const base = { lat, lng };
            let best = { nombre: '?', dist: Infinity };
            for (const t of TERMINALES) {
                const d = haversineKm(base, t);
                if (d < best.dist) best = { nombre: t.nombre, dist: d };
            }
            return best;
        }

        // Inferir flags de limpieza
        function inferCleaningFlags(task) {
            const inside = task === 'BARRIDO' || task === 'BARRIDO_Y_MOPEO' || task === 'FULL';
            const outside = task === 'LAVADO_RODILLO' || task === 'FULL';
            return { inside, outside };
        }

        // Formatear fecha
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleString('es-CL', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        // Formatear fecha corta
        function formatShortDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('es-CL', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Generar ID de dispositivo √∫nico
        function generateDeviceId() {
            // Checkear si ya existe
            let deviceId = localStorage.getItem('flota_device_id');
            if (deviceId) return deviceId;

            // Crear uno nuevo basado en timestamp + fingerprint parcial
            const timestamp = Date.now().toString(36);
            const randomStr = Math.random().toString(36).substring(2, 8);
            const screenSize = `${window.screen.width}x${window.screen.height}`.replace(/\D/g, '');
            const colorDepth = window.screen.colorDepth || 0;
            const timezone = new Date().getTimezoneOffset();

            // Combinar y hashear ligeramente para crear un ID
            deviceId = `${timestamp}-${randomStr}-${screenSize}-${colorDepth}-${timezone}`.replace(/[^a-zA-Z0-9-]/g, '');

            // Guardar para futuras visitas
            localStorage.setItem('flota_device_id', deviceId);
            return deviceId;
        }

        // Detectar informaci√≥n del dispositivo
        function detectDeviceInfo() {
            const userAgent = navigator.userAgent;
            let deviceInfo = 'Desconocido';
            let browserInfo = 'Desconocido';

            // Detectar dispositivo
            if (/Android/i.test(userAgent)) {
                deviceInfo = `Android ${/Android (\d+\.\d+)/.test(userAgent) ? userAgent.match(/Android (\d+\.\d+)/)[1] : ''}`;
            } else if (/iPhone|iPad|iPod/i.test(userAgent)) {
                deviceInfo = 'iOS';
                if (/iPhone/i.test(userAgent)) deviceInfo = 'iPhone';
                if (/iPad/i.test(userAgent)) deviceInfo = 'iPad';
                if (/iPod/i.test(userAgent)) deviceInfo = 'iPod';
            } else if (/Windows/i.test(userAgent)) {
                deviceInfo = 'PC Windows';
            } else if (/Macintosh/i.test(userAgent)) {
                deviceInfo = 'Mac';
            } else if (/Linux/i.test(userAgent)) {
                deviceInfo = 'PC Linux';
            }

            // Detectar navegador
            if (/Chrome/i.test(userAgent) && !/Chromium|Edge|Edg|OPR|SamsungBrowser/i.test(userAgent)) {
                browserInfo = `Chrome ${/Chrome\/(\d+)/.test(userAgent) ? userAgent.match(/Chrome\/(\d+)/)[1] : ''}`;
            } else if (/Firefox/i.test(userAgent)) {
                browserInfo = `Firefox ${/Firefox\/(\d+)/.test(userAgent) ? userAgent.match(/Firefox\/(\d+)/)[1] : ''}`;
            } else if (/Safari/i.test(userAgent) && !/Chrome|Chromium|Edge|Edg|OPR/i.test(userAgent)) {
                browserInfo = `Safari ${/Version\/(\d+\.\d+)/.test(userAgent) ? userAgent.match(/Version\/(\d+\.\d+)/)[1] : ''}`;
            } else if (/Edge|Edg/i.test(userAgent)) {
                browserInfo = `Edge ${/Edge\/(\d+)|Edg\/(\d+)/.test(userAgent) ? (userAgent.match(/Edge\/(\d+)/) || userAgent.match(/Edg\/(\d+)/))[1] : ''}`;
            } else if (/OPR/i.test(userAgent)) {
                browserInfo = `Opera ${/OPR\/(\d+)/.test(userAgent) ? userAgent.match(/OPR\/(\d+)/)[1] : ''}`;
            } else if (/SamsungBrowser/i.test(userAgent)) {
                browserInfo = `Samsung Browser ${/SamsungBrowser\/(\d+\.\d+)/.test(userAgent) ? userAgent.match(/SamsungBrowser\/(\d+\.\d+)/)[1] : ''}`;
            }

            return { deviceInfo, browserInfo };
        }

        // ===== STATE =====
        let sb = null;
        try {
            if (SUPABASE_URL && SUPABASE_ANON_KEY) {
                sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });
                console.log("Cliente Supabase inicializado correctamente");
            } else {
                console.log("Modo demostraci√≥n activado (sin Supabase)");
            }
        } catch (error) {
            console.error("Error inicializando Supabase:", error);
        }

        let buses = [];
        let logs = [];
        let pendientes = [];
        let machineReports = [];
        let notifications = [];
        let gps = { lat: null, lng: null, ts: null };
        let map, clusterLayer, terminalsLayer, baseLayers;
        let charts = {};
        let gpsWatchId = null;
        let deviceId = generateDeviceId();
        let userConfig = {
            userName: 'Usuario',
            userTerminal: '',
            notificationsEnabled: true,
            gpsEnabled: true,
            autoResetOnRain: true,
            weatherLocation: 'Santiago, CL'
        };
        let weatherData = {
            temp: null,
            description: '',
            icon: '',
            isRaining: false,
            lastUpdated: null
        };

        // Cargar configuraci√≥n de usuario
        function loadUserConfig() {
            const savedConfig = localStorage.getItem('flota_user_config');
            if (savedConfig) {
                try {
                    const parsed = JSON.parse(savedConfig);
                    userConfig = { ...userConfig, ...parsed };
                } catch (e) {
                    console.error("Error cargando configuraci√≥n:", e);
                }
            }

            // Aplicar configuraci√≥n a la interfaz
            $('#userName').value = userConfig.userName || '';
            $('#userTerminal').value = userConfig.userTerminal || '';
            $('#notificationsEnabled').checked = userConfig.notificationsEnabled !== false;
            $('#gpsEnabled').checked = userConfig.gpsEnabled !== false;
            $('#autoResetOnRain').checked = userConfig.autoResetOnRain !== false;
            $('#weatherLocation').value = userConfig.weatherLocation || 'Santiago, CL';

            // Actualizar UI con la configuraci√≥n cargada
            updateUserUI();
        }

        // Guardar configuraci√≥n de usuario
        function saveUserConfig() {
            userConfig.userName = $('#userName').value;
            userConfig.userTerminal = $('#userTerminal').value;
            userConfig.notificationsEnabled = $('#notificationsEnabled').checked;
            userConfig.gpsEnabled = $('#gpsEnabled').checked;
            userConfig.autoResetOnRain = $('#autoResetOnRain').checked;
            userConfig.weatherLocation = $('#weatherLocation').value;

            localStorage.setItem('flota_user_config', JSON.stringify(userConfig));
            updateUserUI();
            showToast("Configuraci√≥n guardada correctamente", "success");
        }

        // Actualizar UI del usuario seg√∫n configuraci√≥n
        function updateUserUI() {
            // Actualizar nombre e inicial en sidebar
            $('#user-name').textContent = userConfig.userName || 'Usuario';
            $('#user-terminal').textContent = `Terminal: ${userConfig.userTerminal || 'Desconocido'}`;
            $('#user-initial').textContent = (userConfig.userName || 'U').charAt(0).toUpperCase();

            // Gestionar GPS seg√∫n preferencias
            if (userConfig.gpsEnabled) {
                startGPSWatch();
            } else if (gpsWatchId !== null) {
                try {
                    navigator.geolocation.clearWatch(gpsWatchId);
                    gpsWatchId = null;
                } catch (e) { }
                $('#gpsTxt').textContent = 'GPS: Desactivado en configuraci√≥n';
            }
        }

        // ===== HEADER & FOOTER =====
        $('#yy').textContent = new Date().getFullYear();

        function updateClock() {
            const now = new Date();
            $('#now').textContent = now.toLocaleTimeString('es-CL', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        setInterval(updateClock, 1000);
        updateClock();

        // ===== LAYOUT & NAVIGATION =====
        // Toggle sidebar
        $('#sidebar-toggle')?.addEventListener('click', () => {
            $('#sidebar').classList.toggle('collapsed');
            $('#content').classList.toggle('sidebar-collapsed');
        });

        // Mobile menu toggle
        $('#mobile-menu-btn')?.addEventListener('click', () => {
            $('#sidebar').classList.toggle('mobile-visible');
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            const sidebar = $('#sidebar');
            const mobileMenuBtn = $('#mobile-menu-btn');

            if (sidebar && sidebar.classList.contains('mobile-visible') && !sidebar.contains(e.target) && e.target !== mobileMenuBtn) {
                sidebar.classList.remove('mobile-visible');
            }
        });

        // Page navigation
        function navigateTo(pageId) {
            // Actualizar URL hash
            window.location.hash = pageId;

            // Ocultar todas las p√°ginas
            $$('.page').forEach(page => page.classList.add('hidden'));
            $$('.page').forEach(page => page.classList.remove('active'));

            // Mostrar la p√°gina seleccionada
            $(`#page-${pageId}`)?.classList.remove('hidden');
            $(`#page-${pageId}`)?.classList.add('active');

            // Actualizar navegaci√≥n
            $$('.sidebar-menu-link').forEach(link => link.classList.remove('active'));
            $$('.sidebar-menu-link').forEach(link => {
                if (link.getAttribute('data-page') === pageId) {
                    link.classList.add('active');
                }
            });

            // Actualizar navegaci√≥n m√≥vil
            $$('.mobile-nav-item').forEach(item => item.classList.remove('active'));
            $$('.mobile-nav-item').forEach(item => {
                if (item.getAttribute('data-page') === pageId) {
                    item.classList.add('active');
                }
            });

            // Acciones espec√≠ficas por p√°gina
            if (pageId === 'mapa' && map) {
                setTimeout(() => map.invalidateSize(), 100);
            }

            // Cerrar sidebar en m√≥vil al navegar
            if (window.innerWidth < 1024) {
                $('#sidebar').classList.remove('mobile-visible');
            }

            // En m√≥viles, hacer scroll al inicio de la p√°gina
            window.scrollTo(0, 0);

            // Si es la p√°gina de registro y estamos en m√≥vil, hacer focus en el formulario
            if (pageId === 'registro' && window.innerWidth < 768) {
                $('#busSelect')?.focus();
            }
        }

        // Event listeners para navegaci√≥n
        $$('.sidebar-menu-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo(link.getAttribute('data-page'));
            });
        });

        $$('.mobile-nav-item').forEach(item => {
            if (item.id !== 'mobile-more-btn') {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(item.getAttribute('data-page'));
                });
            }
        });

        // Bot√≥n M√°s en m√≥vil
        $('#mobile-more-btn')?.addEventListener('click', (e) => {
            e.preventDefault();
            $('#sidebar').classList.add('mobile-visible');
        });

        // ===== TABS =====
        $$('.tab-item').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');

                // Actualizar tabs
                $$('.tab-item').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Actualizar paneles
                $$('.tab-pane').forEach(panel => panel.classList.remove('active'));
                $(`#tab_${tabId}`)?.classList.add('active');

                // Si es el tab del mapa, actualizar tama√±o
                if (tabId === 'mapa' && map) {
                    setTimeout(() => map.invalidateSize(), 100);
                }
            });
        });

        // ===== NOTIFICACIONES =====
        function showNotification(title, content, type = 'info') {
            // Agregar al panel de notificaciones
            const notification = {
                id: Date.now(),
                title,
                content,
                type,
                time: new Date(),
                read: false
            };

            notifications.unshift(notification);
            renderNotifications();

            // Mostrar toast si est√°n habilitadas
            if (userConfig.notificationsEnabled) {
                showToast(title, type);
            }

            // Actualizar badge
            updateNotificationBadge();

            // Si el navegador soporta notificaciones nativas y se ha dado permiso
            if ('Notification' in window && Notification.permission === 'granted' && userConfig.notificationsEnabled) {
                const notification = new Notification(title, {
                    body: content,
                    icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöç</text></svg>'
                });
            }
        }

        function renderNotifications() {
            const container = $('#notification-list');
            if (!container) return;

            container.innerHTML = '';

            if (notifications.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-4">No hay notificaciones</div>';
                return;
            }

            notifications.forEach(notification => {
                const item = document.createElement('div');
                item.className = `notification-item${notification.read ? '' : ' unread'}`;

                item.innerHTML = `
        <div class="notification-item-title">${notification.title}</div>
        <div class="notification-item-time">${formatDate(notification.time)}</div>
        <div class="notification-item-content">${notification.content}</div>
      `;

                item.addEventListener('click', () => {
                    notification.read = true;
                    item.classList.remove('unread');
                    updateNotificationBadge();
                });

                container.appendChild(item);
            });
        }

        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = $('#notification-badge');

            if (!badge) return;

            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // Toggle notification panel
        $('#notifications-btn')?.addEventListener('click', () => {
            $('#notification-panel').classList.toggle('visible');
        });

        // Close notification panel
        $('#close-notifications')?.addEventListener('click', () => {
            $('#notification-panel').classList.remove('visible');
        });

        // Mark all as read
        $('#mark-all-read')?.addEventListener('click', () => {
            notifications.forEach(n => n.read = true);
            renderNotifications();
            updateNotificationBadge();
            showToast("Todas las notificaciones han sido marcadas como le√≠das", "success");
        });

        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
        }

        // ===== GEOLOCALIZACION =====
        function startGPSWatch() {
            const gpsTxt = $('#gpsTxt');
            if (!gpsTxt) return;

            if (!navigator.geolocation) {
                gpsTxt.textContent = 'GPS: no disponible en este navegador';
                return;
            }

            try {
                if (gpsWatchId !== null) navigator.geolocation.clearWatch(gpsWatchId);
            } catch (e) { }

            gpsWatchId = navigator.geolocation.watchPosition(
                pos => {
                    gps = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        ts: Date.now()
                    };

                    const nearest = nearestTerminal(gps.lat, gps.lng);
                    gpsTxt.textContent = `GPS: ${gps.lat.toFixed(6)}, ${gps.lng.toFixed(6)} ¬∑ Terminal: ${nearest.nombre} (${nearest.dist.toFixed(1)} km)`;

                    // Actualizar terminal del usuario si no est√° configurado
                    if (!userConfig.userTerminal && nearest.dist < 1) { // Si est√° a menos de 1km
                        userConfig.userTerminal = nearest.nombre;
                        localStorage.setItem('flota_user_config', JSON.stringify(userConfig));
                        updateUserUI();
                    }
                },
                err => {
                    gpsTxt.textContent = 'GPS: sin se√±al o permiso denegado';
                },
                { enableHighAccuracy: true, timeout: 8000, maximumAge: 10000 }
            );
        }

        // ===== CLIMA =====
        async function fetchWeather() {
            const location = userConfig.weatherLocation || 'Santiago, CL';
            const apiKey = ''; // OpenWeather API Key - TO BE ADDED DURING DEPLOYMENT

            // Si no hay API key, simular datos
            if (!apiKey) {
                simulateWeather();
                return;
            }

            try {
                const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(location)}&units=metric&appid=${apiKey}`);

                if (!response.ok) {
                    throw new Error('Error obteniendo datos del clima');
                }

                const data = await response.json();

                weatherData = {
                    temp: Math.round(data.main.temp),
                    description: data.weather[0].description,
                    icon: data.weather[0].icon,
                    isRaining: data.weather[0].main === 'Rain' || data.weather[0].id >= 500 && data.weather[0].id < 600,
                    lastUpdated: new Date()
                };

                updateWeatherUI();

                // Comprobar si est√° lloviendo y hay que resetear pendientes
                if (weatherData.isRaining && userConfig.autoResetOnRain) {
                    checkRainReset();
                }
            } catch (error) {
                console.error('Error fetching weather:', error);
                simulateWeather();
            }
        }

        function simulateWeather() {
            const now = new Date();
            const hour = now.getHours();
            const isNight = hour < 6 || hour > 18;
            const randomTemp = Math.floor(Math.random() * 10) + (isNight ? 10 : 20);
            const conditions = ['Despejado', 'Parcialmente nublado', 'Nublado', 'Lluvia ligera'];
            const randomCondition = conditions[Math.floor(Math.random() * conditions.length)];
            const isRaining = randomCondition.includes('lluvia');

            weatherData = {
                temp: randomTemp,
                description: randomCondition,
                icon: isNight ? 'moon' : 'sun',
                isRaining: isRaining,
                lastUpdated: new Date()
            };

            updateWeatherUI();
        }

        function updateWeatherUI() {
            // Mini indicador en header
            const weatherMini = $('#weather-mini');
            if (!weatherMini) return;

            weatherMini.innerHTML = '';

            let icon = 'bi-sun';
            if (weatherData.description.includes('nub')) icon = 'bi-cloud-sun';
            if (weatherData.description.includes('lluv') || weatherData.isRaining) icon = 'bi-cloud-rain';
            if (weatherData.description.includes('noche') || weatherData.icon?.includes('n')) icon = 'bi-moon';

            weatherMini.innerHTML = `
      <i class="bi ${icon}"></i>
      <span>${weatherData.temp}¬∞C</span>
    `;

            // Widget completo
            const weatherWidget = $('#weather-widget');
            if (!weatherWidget) return;

            weatherWidget.innerHTML = '';

            weatherWidget.innerHTML = `
      <div class="weather-icon">
        <i class="bi ${icon}"></i>
      </div>
      <div class="weather-content">
        <div class="weather-temp">${weatherData.temp}¬∞C - ${weatherData.description}</div>
        <div class="weather-desc">
          ${weatherData.isRaining ? '<span class="weather-rain"><i class="bi bi-exclamation-triangle"></i> ¬°Alerta de lluvia! Lavados exteriores suspendidos.</span>' : 'Condiciones normales de operaci√≥n.'}
        </div>
        <div class="weather-date">Actualizado: ${weatherData.lastUpdated ? weatherData.lastUpdated.toLocaleTimeString() : 'Nunca'}</div>
      </div>
    `;

            if (weatherData.isRaining) {
                weatherWidget.style.background = 'rgba(239, 68, 68, 0.1)';
                weatherWidget.style.borderColor = 'rgba(239, 68, 68, 0.3)';
            } else {
                weatherWidget.style.background = 'rgba(14, 165, 233, 0.1)';
                weatherWidget.style.borderColor = '';
            }
        }

        function checkRainReset() {
            const lastRainReset = localStorage.getItem('last_rain_reset');
            const now = new Date();
            const today = now.toISOString().split('T')[0];

            // Si no se ha reseteado hoy y est√° lloviendo
            if (lastRainReset !== today && weatherData.isRaining) {
                showNotification(
                    '¬°Alerta de lluvia!',
                    'Se ha detectado lluvia. Los lavados exteriores se han suspendido. Se marcar√° como "pendientes" los buses para mantenimiento exterior.',
                    'warning'
                );

                // Crear pendientes para todos los buses
                if (buses.length > 0) {
                    buses.forEach(bus => {
                        const existingPending = pendientes.find(p => p.bus_id === bus.id && p.task === 'LAVADO_RODILLO');
                        if (!existingPending) {
                            pendientes.push({
                                id: `pending-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
                                bus_id: bus.id,
                                plate: bus.plate,
                                task: 'LAVADO_RODILLO',
                                created_at: new Date().toISOString(),
                                terminal: bus.terminal || userConfig.userTerminal,
                                reason: 'Suspendido por lluvia'
                            });
                        }
                    });

                    renderPendientes();
                    savePendientes();
                }

                localStorage.setItem('last_rain_reset', today);
            }
        }

        // ===== MAPA =====
        function initMap() {
            // Verificar si el contenedor del mapa existe
            const mapContainer = $('#map');
            if (!mapContainer) return;

            // Crear mapa con vista centrada en Santiago
            map = L.map('map', { zoomControl: true }).setView([-33.47, -70.73], 12);

            // Capas base
            const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles ¬© Esri ‚Äî Source: Esri, Maxar, Earthstar Geographics'
            }).addTo(map);

            const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            });

            baseLayers = {
                'Sat√©lite': sat,
                'Calles': streets
            };

            // Capa de clusters para markers
            clusterLayer = L.markerClusterGroup({
                showCoverageOnHover: false,
                disableClusteringAtZoom: 15,
                spiderfyOnMaxZoom: true,
                maxClusterRadius: 60
            });
            map.addLayer(clusterLayer);

            // Capa para terminales
            terminalsLayer = L.layerGroup().addTo(map);
            for (const t of TERMINALES) {
                L.marker([t.lat, t.lng], {
                    icon: L.divIcon({
                        html: `<div style="background-color: white; width: 36px; height: 36px; display: flex; justify-content: center; align-items: center; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 3px solid #0ea5e9;">
                  <i class="bi bi-building" style="color: #0ea5e9; font-size: 18px;"></i>
                </div>`,
                        className: 'custom-terminal-icon',
                        iconSize: [36, 36],
                        iconAnchor: [18, 18]
                    })
                })
                    .addTo(terminalsLayer)
                    .bindPopup(`<div style="text-align: center; font-weight: bold; padding: 5px;">${t.nombre}</div>`);
            }

            // Control de capas
            L.control.layers(
                baseLayers,
                { 'Registros': clusterLayer, 'Terminales': terminalsLayer },
                { collapsed: true }
            ).addTo(map);

            // Evento de cambio de filtro
            $('#map-filter')?.addEventListener('change', () => {
                refreshMarkers();
            });
        }

        function refreshMarkers() {
            if (!clusterLayer) return;

            clusterLayer.clearLayers();
            const pts = [];

            // Aplicar filtro
            const filterValue = $('#map-filter')?.value || 'all';
            let filteredLogs = [...logs];

            if (filterValue === 'today') {
                const todayStr = new Date().toISOString().slice(0, 10);
                filteredLogs = logs.filter(l => (l.created_at || '').slice(0, 10) === todayStr);
            } else if (filterValue === 'interior') {
                filteredLogs = logs.filter(l => l.inside_cleaned);
            } else if (filterValue === 'exterior') {
                filteredLogs = logs.filter(l => l.outside_cleaned);
            }

            const data = filteredLogs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            for (const l of data) {
                if (l.gps_lat && l.gps_lng) {
                    // Seleccionar √≠cono seg√∫n tipo de tarea
                    let iconClass = 'bi-geo';
                    let iconColor = '#0ea5e9';

                    if (l.inside_cleaned && !l.outside_cleaned) {
                        iconClass = 'bi-broom';
                        iconColor = '#0ea5e9';
                    } else if (!l.inside_cleaned && l.outside_cleaned) {
                        iconClass = 'bi-water';
                        iconColor = '#16a34a';
                    } else if (l.inside_cleaned && l.outside_cleaned) {
                        iconClass = 'bi-check2-all';
                        iconColor = '#8b5cf6';
                    }

                    // Crear HTML para el √≠cono personalizado
                    const iconHtml = `
          <div style="background-color: white; width: 32px; height: 32px; display: flex; justify-content: center; align-items: center; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 2px solid ${iconColor};">
            <i class="bi ${iconClass}" style="color: ${iconColor}; font-size: 16px;"></i>
          </div>
        `;

                    // Crear icono personalizado
                    const customIcon = L.divIcon({
                        html: iconHtml,
                        className: 'custom-map-icon',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });

                    // Crear marcador con icono personalizado
                    const m = L.marker([l.gps_lat, l.gps_lng], { icon: customIcon });

                    // Contenido del popup
                    const body = `
          <div style="min-width: 200px;">
            <h3 style="margin: 0 0 5px; font-size: 16px; text-align: center;">${l.plate || 'Bus'}</h3>
            <p style="margin: 0 0 8px; font-size: 12px; color: #64748b; text-align: center;">
              ${formatDate(l.created_at)}
            </p>
            <div style="font-weight: 600; text-align: center; margin-bottom: 8px;">${l.task_type.replaceAll('_', ' ')}</div>
            <div style="margin-top: 5px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
              ${l.inside_cleaned ? '<span style="background: #0ea5e9; color: white; padding: 3px 8px; border-radius: 999px; font-size: 12px;">Interior</span>' : ''}
              ${l.outside_cleaned ? '<span style="background: #16a34a; color: white; padding: 3px 8px; border-radius: 999px; font-size: 12px;">Exterior</span>' : ''}
            </div>
            ${l.photos && l.photos.length > 0 ? `
              <div style="margin-top: 8px; font-size: 12px; text-align: center;">
                <a href="#" onclick="showGallery('${l.id}'); return false;">Ver ${l.photos.length} foto${l.photos.length > 1 ? 's' : ''}</a>
              </div>
            ` : ''}
          </div>
        `;

                    m.bindPopup(body);
                    clusterLayer.addLayer(m);
                    pts.push([l.gps_lat, l.gps_lng]);
                }
            }

            // Ajustar vista del mapa si hay puntos
            if (pts.length) {
                const b = L.latLngBounds(pts);
                map.fitBounds(b.pad(0.2));
            }
        }

        // ===== FEED Y LISTADOS =====
        function renderKPIs() {
            const kpiTotal = $('#kpiTotal');
            const kpiInt = $('#kpiInt');
            const kpiExt = $('#kpiExt');

            if (!kpiTotal || !kpiInt || !kpiExt) return;

            const todayStr = new Date().toISOString().slice(0, 10);
            const today = logs.filter(l => (l.created_at || '').slice(0, 10) === todayStr);

            kpiTotal.textContent = today.length;
            kpiInt.textContent = today.filter(l => !!l.inside_cleaned).length;
            kpiExt.textContent = today.filter(l => !!l.outside_cleaned).length;

            // Gr√°fico de barras por tarea
            const byTask = TASKS.map(t => ({
                name: t.label,
                count: today.filter(l => l.task_type === t.code).length
            }));

            const ctx = document.getElementById('barTasks');
            if (!ctx) return;

            if (charts.barTasks) charts.barTasks.destroy();

            charts.barTasks = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: byTask.map(x => x.name),
                    datasets: [{
                        label: 'Hoy',
                        data: byTask.map(x => x.count),
                        borderRadius: 6,
                        backgroundColor: '#60a5fa'
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: false
                        }
                    }
                }
            });

            // Crear/Actualizar gr√°ficos adicionales
            renderCharts();
        }

        function renderFeed() {
            const feeds = [
                { container: $('#feed'), limit: 200 },
                { container: $('#recent-feed'), limit: 5 },
                { container: $('#history-feed'), limit: 1000 }
            ];

            // Ordenar registros por fecha (m√°s recientes primero)
            const data = [...logs].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            // Actualizar cada feed
            feeds.forEach(({ container, limit }) => {
                if (!container) return;

                container.innerHTML = '';
                const frag = document.createDocumentFragment();

                for (const l of data.slice(0, limit)) {
                    const row = document.createElement('div');
                    row.className = 'feed-item';

                    const taskIcon = TASKS.find(t => t.code === l.task_type)?.icon || 'bi-check-circle';

                    row.innerHTML = `
          <div class="feed-content">
            <div class="feed-title">
              <i class="bi ${taskIcon}"></i> ${l.plate || 'Bus'}
            </div>
            <div class="feed-subtitle">
              ${formatDate(l.created_at)} 
              ${l.gps_lat && l.gps_lng ? `| ${nearestTerminal(l.gps_lat, l.gps_lng).nombre}` : ''}
            </div>
            <div class="feed-badges">
              ${l.inside_cleaned ? '<span class="badge badge-primary"><i class="bi bi-broom"></i> Interior</span>' : ''}
              ${l.outside_cleaned ? '<span class="badge badge-success"><i class="bi bi-water"></i> Exterior</span>' : ''}
            </div>
          </div>
          <div class="feed-actions">
            <button class="btn btn-sm btn-outline" onclick="showLogDetails('${l.id}')">
              <i class="bi bi-eye"></i>
            </button>
          </div>
        `;

                    frag.appendChild(row);
                }

                if (!data.length) {
                    const row = document.createElement('div');
                    row.className = 'feed-item';
                    row.innerHTML = '<div class="text-center text-muted p-3">Sin registros todav√≠a.</div>';
                    frag.appendChild(row);
                }

                container.appendChild(frag);
            });
        }

        // ===== GR√ÅFICOS Y AN√ÅLISIS =====
        function renderCharts() {
            // Progreso diario (comparaci√≥n interior vs exterior)
            const renderProgressChart = () => {
                const ctx = document.getElementById('progressChart');
                if (!ctx) return;
                if (charts.progress) charts.progress.destroy();

                const todayStr = new Date().toISOString().slice(0, 10);
                const today = logs.filter(l => (l.created_at || '').slice(0, 10) === todayStr);

                // Preparar datos para gr√°fico
                const hours = [];
                for (let i = 0; i < 24; i++) {
                    hours.push(i < 10 ? `0${i}:00` : `${i}:00`);
                }

                const interiorData = new Array(24).fill(0);
                const exteriorData = new Array(24).fill(0);

                today.forEach(log => {
                    const hour = new Date(log.created_at).getHours();
                    if (log.inside_cleaned) interiorData[hour]++;
                    if (log.outside_cleaned) exteriorData[hour]++;
                });

                charts.progress = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: hours,
                        datasets: [
                            {
                                label: 'Interior',
                                data: interiorData,
                                borderColor: '#0ea5e9',
                                backgroundColor: 'rgba(14, 165, 233, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Exterior',
                                data: exteriorData,
                                borderColor: '#16a34a',
                                backgroundColor: 'rgba(22, 163, 74, 0.1)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: false
                            },
                            legend: {
                                position: 'bottom'
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            };

            // Gr√°fico por terminal
            const renderTerminalChart = () => {
                const ctx = document.getElementById('terminalChart');
                if (!ctx) return;
                if (charts.terminal) charts.terminal.destroy();

                const todayStr = new Date().toISOString().slice(0, 10);
                const today = logs.filter(l => (l.created_at || '').slice(0, 10) === todayStr);

                // Contar registros por terminal
                const terminals = {};
                today.forEach(log => {
                    if (log.gps_lat && log.gps_lng) {
                        const nearest = nearestTerminal(log.gps_lat, log.gps_lng);
                        terminals[nearest.nombre] = (terminals[nearest.nombre] || 0) + 1;
                    }
                });

                const labels = Object.keys(terminals);
                const data = Object.values(terminals);

                // Colores para cada terminal
                const colors = [
                    '#0ea5e9', '#16a34a', '#f59e0b', '#ef4444',
                    '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'
                ];

                charts.terminal = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12
                                }
                            }
                        }
                    }
                });
            };

            // Gr√°ficos para la p√°gina de reportes
            const renderReportCharts = () => {
                // Cumplimiento Mensual
                const renderMonthlyChart = () => {
                    const ctx = document.getElementById('monthlyChart');
                    if (!ctx) return;
                    if (charts.monthly) charts.monthly.destroy();

                    // Obtener los √∫ltimos 30 d√≠as
                    const days = [];
                    const interiorData = [];
                    const exteriorData = [];
                    const targetLine = [];

                    for (let i = 29; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().slice(0, 10);
                        const dayLogs = logs.filter(l => (l.created_at || '').slice(0, 10) === dateStr);

                        days.push(date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }));
                        interiorData.push(dayLogs.filter(l => l.inside_cleaned).length);
                        exteriorData.push(dayLogs.filter(l => l.outside_cleaned).length);
                        targetLine.push(15); // Meta diaria ejemplo
                    }

                    charts.monthly = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: days,
                            datasets: [
                                {
                                    label: 'Interior',
                                    data: interiorData,
                                    backgroundColor: '#0ea5e9',
                                    barPercentage: 0.6,
                                    categoryPercentage: 0.8
                                },
                                {
                                    label: 'Exterior',
                                    data: exteriorData,
                                    backgroundColor: '#16a34a',
                                    barPercentage: 0.6,
                                    categoryPercentage: 0.8
                                },
                                {
                                    label: 'Meta',
                                    data: targetLine,
                                    type: 'line',
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    pointStyle: false,
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                },
                                title: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    stacked: true,
                                    grid: {
                                        display: false
                                    }
                                },
                                y: {
                                    stacked: false,
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                };

                // Distribuci√≥n por Tipo
                const renderTaskTypeChart = () => {
                    const ctx = document.getElementById('taskTypeChart');
                    if (!ctx) return;
                    if (charts.taskType) charts.taskType.destroy();

                    // Contar por tipo de tarea
                    const taskCounts = {};
                    TASKS.forEach(task => {
                        taskCounts[task.label] = logs.filter(l => l.task_type === task.code).length;
                    });

                    const labels = Object.keys(taskCounts);
                    const data = Object.values(taskCounts);

                    charts.taskType = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: [
                                    '#0ea5e9',
                                    '#16a34a',
                                    '#f59e0b',
                                    '#ef4444'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                };

                // Rendimiento por Terminal
                const renderTerminalPerformanceChart = () => {
                    const ctx = document.getElementById('terminalPerformanceChart');
                    if (!ctx) return;
                    if (charts.terminalPerformance) charts.terminalPerformance.destroy();

                    // Datos agrupados por terminal
                    const terminalData = {};
                    TERMINALES.forEach(terminal => {
                        terminalData[terminal.nombre] = {
                            interior: 0,
                            exterior: 0,
                            total: 0
                        };
                    });

                    logs.forEach(log => {
                        if (log.gps_lat && log.gps_lng) {
                            const nearest = nearestTerminal(log.gps_lat, log.gps_lng);
                            terminalData[nearest.nombre].total++;
                            if (log.inside_cleaned) terminalData[nearest.nombre].interior++;
                            if (log.outside_cleaned) terminalData[nearest.nombre].exterior++;
                        }
                    });

                    const labels = Object.keys(terminalData);
                    const interiorData = labels.map(label => terminalData[label].interior);
                    const exteriorData = labels.map(label => terminalData[label].exterior);

                    charts.terminalPerformance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Interior',
                                    data: interiorData,
                                    backgroundColor: '#0ea5e9'
                                },
                                {
                                    label: 'Exterior',
                                    data: exteriorData,
                                    backgroundColor: '#16a34a'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: false
                                    }
                                },
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                };

                // Tiempo Fuera de M√°quinas
                const renderMachineDowntimeChart = () => {
                    const ctx = document.getElementById('machineDowntimeChart');
                    if (!ctx) return;
                    if (charts.machineDowntime) charts.machineDowntime.destroy();

                    // Obtener datos de reportes de m√°quinas
                    const machineTypes = ['RODILLO', 'ASPIRADORA', 'HIDROLAVADORA', 'OTRA'];
                    const downtimeDays = machineTypes.map(type => {
                        const reports = machineReports.filter(r => r.type === type);
                        let totalDays = 0;

                        reports.forEach(report => {
                            if (report.resolved) {
                                const start = new Date(report.created_at);
                                const end = new Date(report.resolved_at);
                                const diffTime = Math.abs(end - start);
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                totalDays += diffDays;
                            } else {
                                const start = new Date(report.created_at);
                                const end = new Date();
                                const diffTime = Math.abs(end - start);
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                totalDays += diffDays;
                            }
                        });

                        return totalDays;
                    });

                    charts.machineDowntime = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Rodillos', 'Aspiradoras', 'Hidrolavadoras', 'Otras'],
                            datasets: [{
                                label: 'D√≠as fuera de servicio',
                                data: downtimeDays,
                                backgroundColor: '#ef4444',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'D√≠as'
                                    }
                                }
                            }
                        }
                    });
                };

                // Llamar a todas las funciones de gr√°ficos de reportes
                renderMonthlyChart();
                renderTaskTypeChart();
                renderTerminalPerformanceChart();
                renderMachineDowntimeChart();
            };

            // Ejecutar gr√°ficos
            renderProgressChart();
            renderTerminalChart();

            // Verificar si estamos en la p√°gina de reportes
            if (document.getElementById('monthlyChart')) {
                renderReportCharts();
            }
        }

        // ===== PENDIENTES =====
        function renderPendientes() {
            const containers = [
                $('#pendientes-list'),
                $('#pendientes-full-list')
            ];

            // Actualizar contador
            const counters = [
                $('#pendientes-count'),
                $('#pendientes-full-count')
            ];

            counters.forEach(counter => {
                if (counter) counter.textContent = pendientes.length;
            });

            containers.forEach(container => {
                if (!container) return;

                container.innerHTML = '';

                if (pendientes.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted p-3">No hay tareas pendientes</div>';
                    return;
                }

                // Ordenar por fecha (m√°s recientes primero)
                const sorted = [...pendientes].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                sorted.forEach(pendiente => {
                    const item = document.createElement('div');
                    item.className = 'pending-item';
                    item.id = `pending-${pendiente.id}`;

                    // Icon based on task
                    let taskIcon = 'bi-water';
                    if (pendiente.task === 'BARRIDO' || pendiente.task === 'BARRIDO_Y_MOPEO') {
                        taskIcon = 'bi-broom';
                    } else if (pendiente.task === 'FULL') {
                        taskIcon = 'bi-check2-all';
                    }

                    item.innerHTML = `
          <div class="pending-content">
            <div class="pending-title"><i class="bi ${taskIcon}"></i> ${pendiente.plate}</div>
            <div class="pending-info">
              ${pendiente.task.replaceAll('_', ' ')} ¬∑ ${formatShortDate(pendiente.created_at)}
              ${pendiente.reason ? `<br><small>Motivo: ${pendiente.reason}</small>` : ''}
              ${pendiente.terminal ? `<br><small>Terminal: ${pendiente.terminal}</small>` : ''}
            </div>
          </div>
          <div class="pending-actions">
            <button class="btn btn-sm btn-success" onclick="completePendiente('${pendiente.id}')">
              <i class="bi bi-check-lg"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="removePendiente('${pendiente.id}')">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        `;

                    container.appendChild(item);
                });
            });
        }

        function savePendientes() {
            localStorage.setItem('flota_pendientes', JSON.stringify(pendientes));
        }

        // 1. Reemplazar la funci√≥n loadPendientes
        function loadPendientes() {
            try {
                // Limpiar pendientes existentes
                pendientes = [];

                // Si hay pendientes guardados localmente, intentar cargarlos
                const savedPendientes = localStorage.getItem('flota_pendientes');
                if (savedPendientes) {
                    try {
                        const parsed = JSON.parse(savedPendientes);
                        // Validar que cada pendiente tenga la estructura correcta y 
                        // que el bus asociado exista realmente
                        parsed.forEach(pendiente => {
                            // Verificar que el bus existe en la base de datos real
                            const busExists = buses.some(bus => bus.id === pendiente.bus_id);
                            if (busExists) {
                                pendientes.push(pendiente);
                            }
                        });
                    } catch (e) {
                        console.error('Error en formato de pendientes guardados:', e);
                    }
                }

                // Si estamos conectados a Supabase, tambi√©n intentar cargar desde ah√≠
                if (sb) {
                    // Aqu√≠ podr√≠as implementar la carga desde una tabla "pending_tasks"
                    // si la tienes en tu base de datos
                }

                // Actualizar la UI con solo los pendientes v√°lidos
                renderPendientes();
            } catch (e) {
                console.error('Error cargando pendientes:', e);
                pendientes = [];
                renderPendientes();
            }
        }

        // 2. Reemplazar completamente la funci√≥n de generaci√≥n de pendientes
        // para que solo funcione expl√≠citamente cuando el usuario lo solicita
        function generatePendientes() {
            // Solo generar pendientes si hay buses y logs reales
            if (!buses.length || !logs.length) {
                showToast("No hay suficientes datos para generar pendientes.", "warning");
                return;
            }

            // Limpiar pendientes ficticios primero
            pendientes = pendientes.filter(p => {
                // Verificar que el bus existe realmente
                return buses.some(bus => bus.id === p.bus_id);
            });

            // Ahora generar nuevos pendientes basados en datos reales
            const now = new Date();
            const threeDaysAgo = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000);
            let newPendientes = [];

            buses.forEach(bus => {
                // Verificar si ya existe un pendiente para este bus
                const existingExterior = pendientes.some(p =>
                    p.bus_id === bus.id && p.task === 'LAVADO_RODILLO'
                );

                const existingInterior = pendientes.some(p =>
                    p.bus_id === bus.id &&
                    (p.task === 'BARRIDO' || p.task === 'BARRIDO_Y_MOPEO')
                );

                // Solo crear pendientes si no existen ya
                if (!existingExterior) {
                    // Buscar √∫ltima limpieza exterior
                    const lastExterior = logs.find(l =>
                        l.bus_id === bus.id &&
                        l.outside_cleaned &&
                        new Date(l.created_at) > threeDaysAgo
                    );

                    // Si no hay limpieza exterior reciente, crear pendiente
                    if (!lastExterior) {
                        newPendientes.push({
                            id: `pending-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
                            bus_id: bus.id,
                            plate: bus.plate,
                            task: 'LAVADO_RODILLO',
                            created_at: new Date().toISOString(),
                            terminal: bus.terminal,
                            reason: 'Sin lavado exterior en 3+ d√≠as'
                        });
                    }
                }

                if (!existingInterior) {
                    // Buscar √∫ltima limpieza interior
                    const lastInterior = logs.find(l =>
                        l.bus_id === bus.id &&
                        l.inside_cleaned &&
                        new Date(l.created_at) > threeDaysAgo
                    );

                    // Si no hay limpieza interior reciente, crear pendiente
                    if (!lastInterior) {
                        newPendientes.push({
                            id: `pending-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
                            bus_id: bus.id,
                            plate: bus.plate,
                            task: 'BARRIDO_Y_MOPEO',
                            created_at: new Date().toISOString(),
                            terminal: bus.terminal,
                            reason: 'Sin limpieza interior en 3+ d√≠as'
                        });
                    }
                }
            });

            // Si hay nuevos pendientes, preguntar al usuario
            if (newPendientes.length > 0) {
                if (confirm(`Se detectaron ${newPendientes.length} nuevos pendientes basados en el historial. ¬øDeseas agregarlos a la lista?`)) {
                    // Agregar los nuevos pendientes
                    pendientes = [...pendientes, ...newPendientes];
                    savePendientes();
                    renderPendientes();
                    showToast(`Se agregaron ${newPendientes.length} nuevos pendientes`, "success");
                } else {
                    showToast("No se agregaron pendientes", "info");
                }
            } else {
                showToast("No se detectaron nuevos pendientes", "info");
            }
        }

        // 3. Asegurarse de que la funci√≥n savePendientes SOLO guarde pendientes v√°lidos
        function savePendientes() {
            // Filtrar para asegurar que solo se guarden pendientes con buses reales
            const validPendientes = pendientes.filter(p => {
                return buses.some(bus => bus.id === p.bus_id);
            });

            localStorage.setItem('flota_pendientes', JSON.stringify(validPendientes));
        }

        // 4. Limpiar cualquier pendiente falso al inicio
        document.addEventListener('DOMContentLoaded', function () {
            // Al cargar la p√°gina, limpiar el localStorage de pendientes falsos
            localStorage.removeItem('flota_pendientes');
        });

        // 5. Modificar la carga inicial para no generar pendientes autom√°ticamente
        async function loadInitialData() {
            try {
                // Cargar buses primero
                await loadBuses();

                // Luego cargar logs
                await loadLogs();

                // Cargar pendientes pero NO generar autom√°ticamente
                loadPendientes();

                // El resto del c√≥digo de inicializaci√≥n...
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
            }
        }

        // Completar pendiente (lo elimina y registra la tarea)
        window.completePendiente = function (id) {
            const pendiente = pendientes.find(p => p.id === id);
            if (!pendiente) return;

            // Llenar formulario de registro
            $('#busSelect').value = pendiente.bus_id || '';
            $('#taskSelect').value = pendiente.task || '';

            // Navegar a p√°gina de registro
            navigateTo('registro');

            // Remover pendiente
            removePendiente(id);

            // Notificar
            showToast(`Pendiente de ${pendiente.plate} preparado para registro`, 'info');
        };

        // Eliminar pendiente
        window.removePendiente = function (id) {
            const index = pendientes.findIndex(p => p.id === id);
            if (index === -1) return;

            // Eliminar del array
            const removed = pendientes.splice(index, 1)[0];

            // Guardar cambios
            savePendientes();

            // Actualizar UI
            renderPendientes();

            // Animar eliminaci√≥n
            const el = document.getElementById(`pending-${id}`);
            if (el) {
                el.style.transition = 'all 0.3s ease';
                el.style.opacity = '0';
                el.style.height = '0';
                el.style.padding = '0';
                el.style.margin = '0';
                el.style.overflow = 'hidden';

                setTimeout(() => {
                    el.remove();
                }, 300);
            }

            // Notificar
            showToast(`Pendiente de ${removed.plate} eliminado`, 'info');
        };

        // ===== REPORTE DE M√ÅQUINAS =====
        function renderMachineReports() {
            const containers = [
                $('#maquinas-list'),
                $('#machine-reports-list')
            ];

            containers.forEach(container => {
                if (!container) return;

                container.innerHTML = '';

                if (machineReports.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted p-3">No hay reportes de m√°quinas</div>';
                    return;
                }

                // Ordenar por fecha (m√°s recientes primero)
                const sorted = [...machineReports].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                sorted.forEach(report => {
                    const item = document.createElement('div');
                    item.className = `maintenance-item ${report.resolved ? 'resolved' : ''}`;
                    item.id = `machine-${report.id}`;

                    const reportDate = formatShortDate(report.created_at);
                    const resolvedDate = report.resolved ? formatShortDate(report.resolved_at) : 'Pendiente';

                    item.innerHTML = `
          <div class="maintenance-header">
            <div class="maintenance-title">
              <i class="bi bi-tools"></i> ${report.terminal} - ${report.type.replaceAll('_', ' ')}
            </div>
            <div class="maintenance-status ${report.resolved ? 'resolved' : ''}">
              ${report.resolved ? '<i class="bi bi-check-circle"></i> Resuelto' : '<i class="bi bi-exclamation-circle"></i> Pendiente'}
            </div>
          </div>
          <div class="maintenance-dates">
            <div><i class="bi bi-calendar3"></i> Reporte: ${reportDate}</div>
            <div><i class="bi bi-calendar-check"></i> Resoluci√≥n: ${resolvedDate}</div>
          </div>
          <div class="maintenance-description">${report.description}</div>
          ${!report.resolved ? `
            <div class="d-flex justify-content-end mt-3">
              <button class="btn btn-sm btn-success" onclick="resolveMachine('${report.id}')">
                <i class="bi bi-check-lg"></i> Marcar como resuelto
              </button>
            </div>
          ` : ''}
        `;

                    container.appendChild(item);
                });
            });
        }

        function saveMachineReports() {
            localStorage.setItem('flota_machine_reports', JSON.stringify(machineReports));
        }

        function loadMachineReports() {
            try {
                const savedReports = localStorage.getItem('flota_machine_reports');
                if (savedReports) {
                    machineReports = JSON.parse(savedReports);
                }
            } catch (e) {
                console.error('Error cargando reportes de m√°quinas:', e);
                machineReports = [];
            }

            renderMachineReports();
        }

        window.resolveMachine = function (id) {
            const report = machineReports.find(r => r.id === id);
            if (!report) return;

            // Marcar como resuelto
            report.resolved = true;
            report.resolved_at = new Date().toISOString();

            // Guardar cambios
            saveMachineReports();

            // Actualizar UI
            renderMachineReports();

            // Notificar
            showToast(`M√°quina en ${report.terminal} marcada como resuelta`, 'success');

            // Enviar notificaci√≥n
            showNotification(
                'M√°quina reparada',
                `La m√°quina ${report.type.replaceAll('_', ' ')} en ${report.terminal} ha sido reparada y est√° lista para su uso.`,
                'success'
            );
        };

        // ===== FORMULARIOS =====
        // Previews de im√°genes
        function setupImagePreviews() {
            const fileInputs = [
                { input: $('#files'), preview: $('#previews') },
                { input: $('#machinePhotos'), preview: $('#machinePhotoPreviews') }
            ];

            fileInputs.forEach(({ input, preview }) => {
                if (!input || !preview) return;

                input.addEventListener('change', (e) => {
                    preview.innerHTML = '';

                    Array.from(e.target.files || []).forEach((f, index) => {
                        const item = document.createElement('div');
                        item.className = 'photo-item';

                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(f);
                        img.className = 'photo-img';

                        const removeBtn = document.createElement('div');
                        removeBtn.className = 'photo-remove';
                        removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                        removeBtn.addEventListener('click', () => {
                            // Crear un nuevo FileList sin este archivo
                            const dt = new DataTransfer();
                            const files = input.files;

                            for (let i = 0; i < files.length; i++) {
                                if (i !== index) dt.items.add(files[i]);
                            }

                            input.files = dt.files;
                            item.remove();
                        });

                        item.appendChild(img);
                        item.appendChild(removeBtn);
                        preview.appendChild(item);
                    });
                });
            });
        }

        // Resetear formulario de registro
        window.resetForm = function () {
            $('#formLog').reset();
            $('#previews').innerHTML = '';
        };

        // Resetear formulario de m√°quina
        window.resetMachineForm = function () {
            $('#formMachine').reset();
            $('#machinePhotoPreviews').innerHTML = '';
        };

        // Formulario de registro
        function setupFormSubmission() {
            const formLog = $('#formLog');
            if (!formLog) return;

            formLog.addEventListener('submit', async (e) => {
                e.preventDefault();

                const bus_id = $('#busSelect').value;
                const task = $('#taskSelect').value;

                if (!bus_id || !task) {
                    showToast('Completa PPU y Tarea.', 'warning');
                    return;
                }

                const { inside, outside } = inferCleaningFlags(task);
                const busDetails = buses.find(b => b.id === bus_id);

                // Deshabilitar bot√≥n durante env√≠o
                const submitBtn = $('#submitBtn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<div class="spinner"></div> Guardando...';
                }

                try {
                    // ID √∫nico para el registro (simulando DB)
                    const logId = `log-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;

                    // Procesar im√°genes
                    const files = $('#files').files;
                    const uploadedImages = [];

                    // Simular subida de im√°genes (en producci√≥n usar√≠a Supabase Storage)
                    for (const file of files) {
                        const path = `${logId}/${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
                        // En producci√≥n: await sb.storage.from('cleaning-photos').upload(path, file)

                        // Guardar URL temporal
                        uploadedImages.push({
                            path,
                            url: URL.createObjectURL(file)
                        });
                    }

                    // Guardar registro en el estado local (en producci√≥n ir√≠a a Supabase)
                    const newLog = {
                        id: logId,
                        created_at: new Date().toISOString(),
                        bus_id,
                        plate: busDetails?.plate,
                        task_type: task,
                        gps_lat: gps.lat,
                        gps_lng: gps.lng,
                        photos: uploadedImages,
                        inside_cleaned: inside,
                        outside_cleaned: outside,
                        user_id: deviceId,
                        user_name: userConfig.userName || 'Usuario'
                    };

                    // Si supabase est√° configurado, guardar registro
                    if (sb) {
                        try {
                            const { data: ins, error: e1 } = await sb.from('cleaning_logs').insert({
                                bus_id,
                                task_type: task,
                                gps_lat: gps.lat,
                                gps_lng: gps.lng,
                                inside_cleaned: inside,
                                outside_cleaned: outside,
                                device_id: deviceId,
                                user_name: userConfig.userName || 'Usuario'
                            }).select('id').single();

                            if (e1) throw e1;

                            // Subir fotos
                            const uploaded = [];
                            for (const f of files) {
                                const ext = f.name.split('.').pop();
                                const path = `${ins.id}/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
                                const { error: eUp } = await sb.storage.from('cleaning-photos').upload(path, f, { upsert: false });
                                if (eUp) throw eUp;
                                uploaded.push(path);
                            }

                            // Actualizar registro con fotos
                            if (uploaded.length) {
                                const { error: e2 } = await sb.from('cleaning_logs').update({ photos: uploaded }).eq('id', ins.id);
                                if (e2) throw e2;
                            }

                            // Usar el ID real de Supabase
                            newLog.id = ins.id;
                        } catch (error) {
                            console.error('Error guardando en Supabase:', error);
                            throw error;
                        }
                    }

                    // Agregar al estado local
                    logs.unshift(newLog);

                    // Verificar si el bus ten√≠a pendientes de esta tarea y eliminarlos
                    const pendienteIndex = pendientes.findIndex(p =>
                        p.bus_id === bus_id &&
                        ((p.task === task) ||
                            (p.task === 'LAVADO_RODILLO' && outside) ||
                            (p.task === 'BARRIDO' && inside) ||
                            (p.task === 'BARRIDO_Y_MOPEO' && inside))
                    );

                    if (pendienteIndex !== -1) {
                        pendientes.splice(pendienteIndex, 1);
                        savePendientes();
                        renderPendientes();
                    }

                    // Actualizar UI
                    if (clusterLayer) refreshMarkers();
                    renderKPIs();
                    renderFeed();

                    // Reiniciar formulario
                    formLog.reset();
                    $('#previews').innerHTML = '';

                    // Mostrar notificaci√≥n
                    showToast(`Registro guardado para bus ${busDetails?.plate}`, 'success');

                    // Enviar notificaci√≥n
                    showNotification(
                        'Registro completado',
                        `Se ha realizado el aseo de ${busDetails?.plate}: ${task.replaceAll('_', ' ')}`,
                        'success'
                    );
                } catch (err) {
                    showToast(`Error al guardar: ${err?.message || err}`, 'error');
                } finally {
                    // Reactivar bot√≥n
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-save"></i> Guardar registro';
                    }
                }
            });
        }

        // Formulario de reporte de m√°quina
        function setupMachineForm() {
            const formMachine = $('#formMachine');
            if (!formMachine) return;

            // Establecer fecha actual en el formulario
            const machineDateInput = $('#machineDate');
            if (machineDateInput) {
                const now = new Date();
                const formattedDate = now.toISOString().slice(0, 16); // Formato: YYYY-MM-DDTHH:MM
                machineDateInput.value = formattedDate;
            }

            formMachine.addEventListener('submit', async (e) => {
                e.preventDefault();

                const terminal = $('#machineTerminal').value;
                const type = $('#machineType').value;
                const description = $('#machineIssue').value;
                const reportDate = $('#machineDate').value;
                const estimate = $('#machineEstimate').value;

                if (!terminal || !type || !description || !reportDate) {
                    showToast('Completa todos los campos requeridos.', 'warning');
                    return;
                }

                // Deshabilitar bot√≥n durante env√≠o
                const submitBtn = $('#machineSubmitBtn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<div class="spinner"></div> Guardando...';
                }

                try {
                    // ID √∫nico para el reporte
                    const reportId = `machine-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;

                    // Procesar im√°genes
                    const files = $('#machinePhotos').files;
                    const uploadedImages = [];

                    // Simular subida de im√°genes
                    for (const file of files) {
                        const path = `${reportId}/${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
                        uploadedImages.push({
                            path,
                            url: URL.createObjectURL(file)
                        });
                    }

                    // Calcular fecha estimada de resoluci√≥n
                    const estimatedDate = new Date(reportDate);
                    estimatedDate.setDate(estimatedDate.getDate() + parseInt(estimate, 10));

                    // Guardar reporte
                    const newReport = {
                        id: reportId,
                        created_at: new Date(reportDate).toISOString(),
                        terminal,
                        type,
                        description,
                        estimated_days: parseInt(estimate, 10),
                        estimated_date: estimatedDate.toISOString(),
                        photos: uploadedImages,
                        resolved: false,
                        resolved_at: null,
                        user_id: deviceId,
                        user_name: userConfig.userName || 'Usuario'
                    };

                    // Si supabase est√° configurado, guardar registro
                    if (sb) {
                        try {
                            const { data: ins, error: e1 } = await sb.from('machine_reports').insert({
                                terminal,
                                type,
                                description,
                                estimated_days: parseInt(estimate, 10),
                                estimated_date: estimatedDate.toISOString(),
                                device_id: deviceId,
                                user_name: userConfig.userName || 'Usuario'
                            }).select('id').single();

                            if (e1) throw e1;

                            // Subir fotos
                            const uploaded = [];
                            for (const f of files) {
                                const ext = f.name.split('.').pop();
                                const path = `machine-${ins.id}/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
                                const { error: eUp } = await sb.storage.from('machine-photos').upload(path, f, { upsert: false });
                                if (eUp) throw eUp;
                                uploaded.push(path);
                            }

                            // Actualizar registro con fotos
                            if (uploaded.length) {
                                const { error: e2 } = await sb.from('machine_reports').update({ photos: uploaded }).eq('id', ins.id);
                                if (e2) throw e2;
                            }

                            // Usar el ID real de Supabase
                            newReport.id = ins.id;
                        } catch (error) {
                            console.error('Error guardando en Supabase:', error);
                            throw error;
                        }
                    }

                    // Agregar al estado local
                    machineReports.unshift(newReport);
                    saveMachineReports();

                    // Actualizar UI
                    renderMachineReports();

                    // Reiniciar formulario
                    formMachine.reset();
                    $('#machinePhotoPreviews').innerHTML = '';

                    // Establecer fecha actual
                    if (machineDateInput) {
                        machineDateInput.value = new Date().toISOString().slice(0, 16);
                    }

                    // Restaurar valor por defecto
                    $('#machineEstimate').value = '3';

                    // Mostrar notificaci√≥n
                    showToast(`M√°quina reportada en ${terminal}`, 'success');

                    // Enviar notificaci√≥n
                    showNotification(
                        'M√°quina reportada',
                        `Se ha reportado una m√°quina de tipo ${type.replaceAll('_', ' ')} en ${terminal} como fuera de servicio.`,
                        'warning'
                    );

                    // Crear pendientes para buses en ese terminal
                    const busesInTerminal = buses.filter(b => b.terminal === terminal);
                    if (type === 'RODILLO' && busesInTerminal.length > 0) {
                        busesInTerminal.forEach(bus => {
                            const existingPending = pendientes.find(p => p.bus_id === bus.id && p.task === 'LAVADO_RODILLO');
                            if (!existingPending) {
                                pendientes.push({
                                    id: `pending-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
                                    bus_id: bus.id,
                                    plate: bus.plate,
                                    task: 'LAVADO_RODILLO',
                                    created_at: new Date().toISOString(),
                                    terminal,
                                    reason: 'M√°quina fuera de servicio'
                                });
                            }
                        });

                        savePendientes();
                        renderPendientes();

                        showToast(`Se han creado pendientes para ${busesInTerminal.length} buses en ${terminal}`, 'info');
                    }
                } catch (err) {
                    showToast(`Error al guardar: ${err?.message || err}`, 'error');
                } finally {
                    // Reactivar bot√≥n
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Reportar M√°quina';
                    }
                }
            });
        }

        // Formulario de configuraci√≥n
        function setupConfigForm() {
            const configForm = $('#configForm');
            if (!configForm) return;

            configForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveUserConfig();
            });
        }

        // ===== GALER√çA DE FOTOS =====
        window.showGallery = function (logId) {
            const log = logs.find(l => l.id === logId);
            if (!log || !log.photos || log.photos.length === 0) return;

            // Mostrar primera imagen en lightbox
            const lightbox = $('#lightbox');
            const img = $('#lightbox-img');

            if (!lightbox || !img) return;

            img.src = log.photos[0].url || '';
            lightbox.classList.add('visible');
        };

        // Cerrar lightbox
        $('#lightbox-close')?.addEventListener('click', () => {
            $('#lightbox').classList.remove('visible');
        });

        // Cerrar lightbox al hacer clic fuera de la imagen
        $('#lightbox')?.addEventListener('click', (e) => {
            if (e.target === $('#lightbox')) {
                $('#lightbox').classList.remove('visible');
            }
        });

        // En la funci√≥n loadBuses
        async function loadBuses() {
            const sel = $('#busSelect');
            if (!sel) return;

            sel.innerHTML = '<option value="">Cargando‚Ä¶</option>';

            try {
                if (sb) {
                    const { data, error } = await sb.from('buses')
                        .select('id,ppu,terminal:numero_interno')
                        .order('ppu', { ascending: true });

                    if (error) throw error;

                    // Mapear los datos recibidos para usar 'plate' internamente
                    buses = (data || []).map(bus => ({
                        id: bus.id,
                        plate: bus.ppu, // Asignar ppu a plate para uso interno
                        terminal: bus.terminal
                    }));
                } else {
                    // Sin datos de ejemplo
                    buses = [];
                    showToast("Modo sin conexi√≥n. Configura Supabase para funcionalidad completa.", "warning");
                }

                sel.innerHTML = '<option value="">Selecciona bus</option>' +
                    buses.map(b => `<option value="${b.id}">${b.plate}${b.terminal ? ` ¬∑ ${b.terminal}` : ''}</option>`).join('');
            } catch (error) {
                console.error('Error cargando buses:', error);
                showToast('Error cargando buses: ' + error.message, 'error');
                buses = [];
                sel.innerHTML = '<option value="">Error cargando buses</option>';
            }
        }

        // En la funci√≥n loadLogs
        async function loadLogs() {
            try {
                // Asegurar que el mapa est√° inicializado
                if (map && !clusterLayer) {
                    console.log("Inicializando componentes del mapa");
                    refreshMarkers();
                }

                if (sb) {
                    // Quitar user_email de la consulta
                    const { data, error } = await sb.from('cleaning_logs_view')
                        .select('id,created_at,bus_id,plate,task_type,gps_lat,gps_lng,photos,inside_cleaned,outside_cleaned,user_name,device_id')
                        .order('created_at', { ascending: false })
                        .limit(1000);

                    if (error) throw error;
                    logs = data || [];
                } else {
                    // Sin datos de ejemplo
                    logs = [];
                }

                // Actualizar UI
                if (clusterLayer) refreshMarkers();
                renderKPIs();
                renderFeed();

                // No generar pendientes autom√°ticamente
                // Solo hacerlo si el usuario lo solicita expl√≠citamente
            } catch (error) {
                console.error('Error cargando registros:', error);
                showToast('Error cargando registros: ' + error.message, 'error');
                logs = [];
            }
        }

        // Modificar generatePendientes para que requiera confirmaci√≥n
        function generatePendientes() {
            // Primero mostrar un conteo de lo que se va a generar
            const now = new Date();
            const threeDaysAgo = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000);

            let pendientesCount = 0;

            buses.forEach(bus => {
                // Buscar √∫ltima limpieza exterior
                const lastExterior = logs.find(l =>
                    l.bus_id === bus.id &&
                    l.outside_cleaned &&
                    new Date(l.created_at) > threeDaysAgo
                );

                // Si no hay limpieza exterior reciente
                if (!lastExterior) pendientesCount++;

                // Buscar √∫ltima limpieza interior
                const lastInterior = logs.find(l =>
                    l.bus_id === bus.id &&
                    l.inside_cleaned &&
                    new Date(l.created_at) > threeDaysAgo
                );

                // Si no hay limpieza interior reciente
                if (!lastInterior) pendientesCount++;
            });

            if (pendientesCount > 0) {
                // Preguntar al usuario antes de generar
                if (confirm(`Se detectaron ${pendientesCount} posibles pendientes basados en el historial. ¬øDeseas agregarlos a la lista de pendientes?`)) {
                    // Ahora generar los pendientes con el c√≥digo original
                    // [c√≥digo original de generaci√≥n de pendientes...]
                } else {
                    showToast("Generaci√≥n de pendientes cancelada", "info");
                }
            } else {
                showToast("No se detectaron pendientes nuevos", "info");
            }
        }
        // ===== LOGS =====




        function setupRealtime() {
            if (!sb) return;

            sb.channel('realtime:cleaning_logs')
                .on('postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'cleaning_logs' },
                    (payload) => {
                        const rec = payload.new;
                        const bus = buses.find(x => x.id === rec.bus_id);
                        const near = (rec.gps_lat && rec.gps_lng) ? nearestTerminal(rec.gps_lat, rec.gps_lng) : null;

                        showToast(
                            `Nuevo registro: ${bus?.plate || '(bus)'} ¬∑ ${rec.task_type.replaceAll('_', ' ')} ¬∑ ${near ? `${near.nombre} (~${near.dist.toFixed(1)} km)` : 'sin GPS'}`,
                            'info'
                        );

                        // Si el ID de dispositivo es diferente al actual, es un registro de otro usuario
                        if (rec.device_id !== deviceId) {
                            showNotification(
                                'Nuevo registro de otro usuario',
                                `${rec.user_name || 'Usuario'} ha registrado ${bus?.plate || 'un bus'} - ${rec.task_type.replaceAll('_', ' ')}`,
                                'info'
                            );
                        }

                        logs.unshift({ ...rec, plate: bus?.plate });
                        if (clusterLayer) refreshMarkers();
                        renderKPIs();
                        renderFeed();
                    })
                .subscribe();

            // Polling cada minuto para mantener datos actualizados
            setInterval(loadLogs, 60000);
        }

        // ===== INFORMACI√ìN DEL SISTEMA =====
        function updateSystemInfo() {
            // Informaci√≥n del dispositivo
            const { deviceInfo, browserInfo } = detectDeviceInfo();
            const deviceInfoEl = $('#device-info');
            const browserInfoEl = $('#browser-info');
            const deviceIdEl = $('#device-id');

            if (deviceInfoEl) deviceInfoEl.textContent = deviceInfo;
            if (browserInfoEl) browserInfoEl.textContent = browserInfo;
            if (deviceIdEl) deviceIdEl.textContent = deviceId.slice(0, 8) + '...';

            // Estado de conectividad
            const updateConnectivity = () => {
                const connectivityEl = $('#connectivity');
                if (!connectivityEl) return;

                connectivityEl.textContent = navigator.onLine ? 'En l√≠nea' : 'Sin conexi√≥n';
                connectivityEl.style.color = navigator.onLine ? 'var(--success)' : 'var(--danger)';
            };

            window.addEventListener('online', updateConnectivity);
            window.addEventListener('offline', updateConnectivity);
            updateConnectivity();

            // Estado de la base de datos
            const dbStatusEl = $('#db-status');
            if (!dbStatusEl) return;

            if (sb) {
                sb.from('buses').select('count(*)', { count: 'exact', head: true })
                    .then(({ count, error }) => {
                        if (error) {
                            dbStatusEl.textContent = 'Error de conexi√≥n';
                            dbStatusEl.style.color = 'var(--danger)';
                        } else {
                            dbStatusEl.textContent = `Conectado (${count} buses)`;
                            dbStatusEl.style.color = 'var(--success)';
                        }
                    })
                    .catch(() => {
                        dbStatusEl.textContent = 'Error de conexi√≥n';
                        dbStatusEl.style.color = 'var(--danger)';
                    });
            } else {
                dbStatusEl.textContent = 'Modo sin conexi√≥n';
                dbStatusEl.style.color = 'var(--warning)';
            }
        }

        // Exportar historial
        function setupExportHistory() {
            const exportBtn = $('#export-history');
            if (!exportBtn) return;

            exportBtn.addEventListener('click', () => {
                try {
                    const filterValue = $('#history-filter')?.value || 'all';
                    let filteredLogs = [...logs];

                    // Aplicar filtro
                    if (filterValue === 'today') {
                        const todayStr = new Date().toISOString().slice(0, 10);
                        filteredLogs = logs.filter(l => (l.created_at || '').slice(0, 10) === todayStr);
                    } else if (filterValue === 'week') {
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        filteredLogs = logs.filter(l => new Date(l.created_at) >= weekAgo);
                    } else if (filterValue === 'month') {
                        const monthAgo = new Date();
                        monthAgo.setMonth(monthAgo.getMonth() - 1);
                        filteredLogs = logs.filter(l => new Date(l.created_at) >= monthAgo);
                    }

                    // Convertir a CSV
                    const headers = ['Fecha', 'Bus', 'Tarea', 'Interior', 'Exterior', 'Terminal', 'Usuario'];

                    const rows = filteredLogs.map(log => {
                        const date = new Date(log.created_at).toLocaleString();
                        const terminal = log.gps_lat && log.gps_lng ? nearestTerminal(log.gps_lat, log.gps_lng).nombre : 'N/A';

                        return [
                            date,
                            log.plate || 'Desconocido',
                            log.task_type.replaceAll('_', ' '),
                            log.inside_cleaned ? 'S√≠' : 'No',
                            log.outside_cleaned ? 'S√≠' : 'No',
                            terminal,
                            log.user_name || 'Desconocido'
                        ];
                    });

                    // Crear contenido CSV
                    let csvContent = headers.join(',') + '\n';
                    rows.forEach(row => {
                        csvContent += row.join(',') + '\n';
                    });

                    // Crear blob y descargar
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', `historial_aseo_${new Date().toISOString().slice(0, 10)}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showToast(`Exportado ${rows.length} registros a CSV`, 'success');
                } catch (error) {
                    console.error('Error exportando historial:', error);
                    showToast('Error exportando historial: ' + error.message, 'error');
                }
            });
        }

     // Funci√≥n mejorada para generar pendientes autom√°ticamente
async function generatePendientesFromRealData() {
  // 1. Verificar que tenemos conexi√≥n a Supabase y datos reales
  if (!sb) {
    showToast("No hay conexi√≥n a la base de datos para verificar pendientes", "error");
    return;
  }
  
  showToast("Analizando estado de mantenimiento de la flota...", "info");
  
  try {
    // 2. Obtener lista completa y actualizada de buses directamente de Supabase
    const { data: allBuses, error: busError } = await sb.from('buses')
      .select('id,ppu,terminal:numero_interno')
      .order('ppu', { ascending: true });
      
    if (busError) throw busError;
    
    if (!allBuses || allBuses.length === 0) {
      showToast("No se encontraron buses en la base de datos", "warning");
      return;
    }
    
    // 3. Mapear los datos para formato consistente
    const fleetBuses = allBuses.map(bus => ({
      id: bus.id,
      plate: bus.ppu,
      terminal: bus.terminal
    }));
    
    // 4. Obtener todos los registros de limpieza recientes
    const thresholdDate = new Date();
    thresholdDate.setDate(thresholdDate.getDate() - 3); // 3 d√≠as atr√°s
    
    const { data: recentLogs, error: logError } = await sb.from('cleaning_logs_view')
      .select('id,created_at,bus_id,task_type,inside_cleaned,outside_cleaned')
      .gte('created_at', thresholdDate.toISOString())
      .order('created_at', { ascending: false });
      
    if (logError) throw logError;
    
    // 5. Limpiar pendientes existentes (opcional - mantener solo los que siguen siendo v√°lidos)
    pendientes = [];
    
    // 6. Analizar cada bus para determinar si necesita mantenimiento
    let newPendientesCount = 0;
    
    fleetBuses.forEach(bus => {
      // Buscar registros recientes para este bus
      const busLogs = recentLogs?.filter(log => log.bus_id === bus.id) || [];
      
      // Verificar si tiene limpieza exterior reciente
      const hasRecentExterior = busLogs.some(log => log.outside_cleaned);
      
      // Verificar si tiene limpieza interior reciente
      const hasRecentInterior = busLogs.some(log => log.inside_cleaned);
      
      // Crear pendiente para exterior si es necesario
      if (!hasRecentExterior) {
        pendientes.push({
          id: `pending-ext-${Date.now()}-${bus.id}`,
          bus_id: bus.id,
          plate: bus.plate,
          task: 'LAVADO_RODILLO',
          created_at: new Date().toISOString(),
          terminal: bus.terminal,
          reason: 'Sin lavado exterior en 3+ d√≠as'
        });
        newPendientesCount++;
      }
      
      // Crear pendiente para interior si es necesario
      if (!hasRecentInterior) {
        pendientes.push({
          id: `pending-int-${Date.now()}-${bus.id}`,
          bus_id: bus.id,
          plate: bus.plate,
          task: 'BARRIDO_Y_MOPEO',
          created_at: new Date().toISOString(),
          terminal: bus.terminal,
          reason: 'Sin limpieza interior en 3+ d√≠as'
        });
        newPendientesCount++;
      }
    });
    
    // 7. Guardar y actualizar UI
    savePendientes();
    renderPendientes();
    
    // 8. Notificar resultado
    showToast(`Se detectaron ${newPendientesCount} tareas pendientes en ${fleetBuses.length} buses`, "success");
    
    // 9. Actualizar notificaci√≥n
    if (newPendientesCount > 0) {
      showNotification(
        'Mantenimiento pendiente',
        `Se han detectado ${newPendientesCount} tareas de mantenimiento pendientes en la flota.`,
        'warning'
      );
    }
    
    return newPendientesCount;
  } catch (error) {
    console.error("Error generando pendientes:", error);
    showToast("Error generando pendientes: " + (error.message || error), "error");
    return 0;
  }
}

// Modificar la funci√≥n que inicia la aplicaci√≥n para que genere pendientes autom√°ticamente
// Coloca esto donde inicializas la aplicaci√≥n
document.addEventListener('DOMContentLoaded', async function() {
  try {
    // Otras inicializaciones...
    
    // Cargar buses y logs
    await loadBuses();
    await loadLogs();
    
    // Generar pendientes autom√°ticamente con datos reales
    await generatePendientesFromRealData();
    
    // Continuar con el resto de la inicializaci√≥n...
  } catch (error) {
    console.error("Error en inicializaci√≥n:", error);
  }
});

// Reemplazar el evento del bot√≥n de refresh pendientes para usar la nueva funci√≥n
function setupRefreshPendientes() {
  const refreshBtn = $('#refresh-pendientes');
  if (!refreshBtn) return;
  
  refreshBtn.addEventListener('click', async () => {
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<div class="spinner"></div> Actualizando...';
    
    try {
      await generatePendientesFromRealData();
    } finally {
      refreshBtn.disabled = false;
      refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Actualizar';
    }
  });
}

        // ===== INICIALIZACI√ìN =====
        // Esperar a que el DOM est√© completamente cargado
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                // Inicializar el toast al principio
                if (!document.getElementById('toast-container')) {
                    console.log('Contenedor de toast no encontrado - creando uno');
                    const toastContainer = document.createElement('div');
                    toastContainer.id = 'toast-container';
                    toastContainer.className = 'toast-container';
                    document.body.appendChild(toastContainer);
                }

                // Mostrar mensaje de inicializaci√≥n
                showToast("Inicializando sistema...", "info");

                // Inicializar el mapa antes que cualquier otra cosa que lo use
                console.log("Inicializando mapa...");
                initMap();

                // Responsive menu
                if (document.getElementById('mobile-menu-btn')) {
                    document.getElementById('mobile-menu-btn').style.display = window.innerWidth < 1024 ? 'block' : 'none';
                    window.addEventListener('resize', () => {
                        document.getElementById('mobile-menu-btn').style.display = window.innerWidth < 1024 ? 'block' : 'none';
                    });
                }

                // Configurar formularios
                setupImagePreviews();
                setupFormSubmission();
                setupMachineForm();
                setupConfigForm();
                setupExportHistory();
                setupRefreshPendientes();

                // Cargar configuraci√≥n
                console.log("Cargando configuraci√≥n de usuario...");
                loadUserConfig();

                // Solicitar permisos de notificaci√≥n
                console.log("Solicitando permisos de notificaci√≥n...");
                requestNotificationPermission();

                // Cargar buses antes que logs (dependencia)
                console.log("Cargando datos de buses...");
                await loadBuses();

                // Cargar logs ahora que el mapa est√° inicializado
                console.log("Cargando registros...");
                await loadLogs();

                // Cargar pendientes y reportes de m√°quinas
                console.log("Cargando pendientes...");
                loadPendientes();

                console.log("Cargando reportes de m√°quinas...");
                loadMachineReports();

                // Configurar tiempo real
                console.log("Configurando tiempo real...");
                setupRealtime();

                // Iniciar GPS si est√° habilitado
                if (userConfig.gpsEnabled) {
                    console.log("Iniciando GPS...");
                    startGPSWatch();
                }

                // Obtener clima
                console.log("Obteniendo datos del clima...");
                fetchWeather();
                // Actualizar clima cada 30 minutos
                setInterval(fetchWeather, 30 * 60 * 1000);

                // Informaci√≥n del sistema
                console.log("Actualizando informaci√≥n del sistema...");
                updateSystemInfo();

                // Definir navegaci√≥n desde el URL si existe
                const pageFromHash = window.location.hash.slice(1);
                if (pageFromHash && document.getElementById(`page-${pageFromHash}`)) {
                    console.log(`Navegando a p√°gina inicial: ${pageFromHash}`);
                    navigateTo(pageFromHash);
                }

                // Actualizar hash al navegar
                window.addEventListener('hashchange', () => {
                    const pageFromHash = window.location.hash.slice(1);
                    if (pageFromHash && document.getElementById(`page-${pageFromHash}`)) {
                        navigateTo(pageFromHash);
                    }
                });

                // Mostrar mensaje de bienvenida despu√©s de unos segundos
                setTimeout(() => {
                    const name = userConfig.userName || 'Usuario';
                    console.log(`Mostrando bienvenida para: ${name}`);
                    showNotification(
                        `¬°Bienvenido, ${name}!`,
                        `Sistema de Aseo de Flota inicializado correctamente. Terminal: ${userConfig.userTerminal || 'No configurado'}.`,
                        'success'
                    );
                    // Todo cargado correctamente
                    showToast("Sistema inicializado correctamente", "success");
                }, 2000);

                console.log("Inicializaci√≥n completa.");
            } catch (error) {
                console.error('Error inicializando la aplicaci√≥n:', error);
                // Usar document.getElementById para evitar problemas con $
                const container = document.getElementById('toast-container');
                if (container) {
                    const toast = document.createElement('div');
                    toast.className = 'toast error';
                    toast.innerHTML = `
          <div class="toast-icon"><i class="bi bi-exclamation-circle"></i></div>
          <div class="toast-content">Error inicializando la aplicaci√≥n: ${error.message}</div>
          <div class="toast-close"><i class="bi bi-x"></i></div>
        `;
                    container.appendChild(toast);

                    toast.querySelector('.toast-close').addEventListener('click', () => {
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 300);
                    });
                }
            }
        });
    </script>
</body>

</html>